<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>CSIRT: Card Defense (Prototype)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
<style>
  body { margin:0; background:#111; color:#eee; font-family: "Noto Sans JP", sans-serif; }
  #game-container { width:100%; height:100vh; overflow:hidden; }
  .small { font-size:12px; }
</style>
</head>
<body>
<div id="game-container"></div>

<script>
/*
  CSIRT Card Game - Phaser prototype
  - One-file Phaser 3 game implementing main flows from the spec.
  - Triple-energy system: gold (money), labor (people), time
  - Scenes: Opening, Map, Battle, Reward, Chest, Rest, Shop, Event, GameOver
  - Simplified UI using Phaser text & rectangles
*/

/* ---------- Utility ---------- */
const Util = {
  randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; },
  shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; },
  clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
};
const debugMode = true;
let debugIndex = 0;
//*
function startBattle(Scene){
  if(RUN.stageIndex < 5){
    startBattle(Scene, false);
  }else if(RUN.stageIndex == 9){
    startBattle(Scene, 'boss');
  }else{
    startBattle(Scene, true);
  }  
}
function startBattle(Scene, eliteFlag){
  // prepare enemy from templates based on type & stage
  let enemy;
  if(eliteFlag==='boss') enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.boss)));
  else if(eliteFlag===true) enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.elite)));
  else enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.normal)));
  // store battle state in RUN
  RUN.currentEnemy = {
    ...enemy,
    hp: enemy.hp,
    def: enemy.def,
    intent: enemy.intent,
    intentValue: enemy.intentValue,
    tags: enemy.tags || []
  };
  // prepare player draw pile if empty
  if(RUN.player.drawPile.length===0) RUN.player.drawPile = Util.shuffle(RUN.player.deck.slice());
  // reset temporary player values
  RUN.player.defense = 0;
  //RUN.player.energy = RUN.player.maxEnergy;
  RUN.player.status = {}; // status effects
  Scene.scene.start('BattleScene', {elite: eliteFlag});
}
//*/


/* ---------- Game Data Templates ---------- */

// Sample Cards (costs: money, labor, time)
const CARD_TEMPLATES = [
  /*
  { id:'fw', name:'Firewall Deployment', cost:{money:1,labor:1,time:0}, defense:8, text:'é˜²å¾¡+8 (network)', synergy:'network' },
  { id:'patch', name:'Apply Patch', cost:{money:0,labor:1,time:1}, damageToVuln:12, text:'è„†å¼±æ€§æ‚ªç”¨ã‚’é˜»æ­¢(ãƒ€ãƒ¡ãƒ¼ã‚¸12)', synergy:'vuln' },
  { id:'backup', name:'Offsite Backup', cost:{money:2,labor:0,time:1}, heal:10, text:'è³‡ç”£å›å¾©+10', synergy:'backup' },
  { id:'monitor', name:'IDS Monitoring', cost:{money:1,labor:0,time:1}, draw:1, text:'ã‚«ãƒ¼ãƒ‰ãƒ‰ãƒ­ãƒ¼1', synergy:'network' },
  { id:'train', name:'Employee Training', cost:{money:0,labor:2,time:0}, buffDefense:4, text:'æ¬¡ã‚¿ãƒ¼ãƒ³é˜²å¾¡+4 (human)', synergy:'human' },
  { id:'audit', name:'Security Audit', cost:{money:1,labor:1,time:1}, debuffEnemy:2, text:'æ•µé˜²å¾¡-2 (policy)', synergy:'policy' },
  */

  // æŠ€è¡“çš„å¯¾ç­–:19
  { id:'pw', name:'å¼·å›ºãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é‹ç”¨', cost:{money:0,labor:1,time:0}, defense:4, text:'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¼·åŒ–ã§æ”»æ’ƒã‚’å›°é›£ã«ã™ã‚‹', synergy:'è­˜åˆ¥,äººçš„å¯¾ç­–' },
  { id:'encrypt', name:'ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–', cost:{money:2,labor:1,time:1}, defense:7, text:'æš—å·åŒ–ã§æƒ…å ±æ¼æ´©ã‚’é˜²ã', synergy:'ãƒ‡ãƒ¼ã‚¿,æŠ€è¡“çš„å¯¾ç­–' },
  { id:'fw', name:'ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­ç½®', cost:{money:1,labor:1,time:0}, defense:8, text:'ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã‚’é˜²å¾¡', synergy:'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯,é˜²å¾¡' },
  { id:'accessctrl', name:'ã‚¢ã‚¯ã‚»ã‚¹ç®¡ç†', cost:{money:1,labor:1,time:1}, defense:6, text:'æ¨©é™ã‚’åˆ¶å¾¡ã—ãƒªã‚¹ã‚¯ã‚’æ¸›ã‚‰ã™', synergy:'è­˜åˆ¥,æŠ€è¡“çš„å¯¾ç­–' },
  { id:'av', name:'ã‚¦ã‚¤ãƒ«ã‚¹å¯¾ç­–ã‚½ãƒ•ãƒˆå°å…¥', cost:{money:1,labor:1,time:0}, defense:6, text:'ãƒãƒ«ã‚¦ã‚§ã‚¢ã‚’æ¤œçŸ¥ã—ã¦é˜²ã', synergy:'ãƒ‡ãƒã‚¤ã‚¹,é˜²å¾¡' },
  { id:'ips', name:'IPSå°å…¥', cost:{money:2,labor:2,time:1}, defense:10, text:'ä¾µå…¥ã‚’æœªç„¶ã«é˜²æ­¢', synergy:'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯,æ¤œçŸ¥' },
  { id:'ids', name:'IDSå°å…¥', cost:{money:1,labor:1,time:1}, draw:1, text:'ä¾µå…¥ã‚’æ¤œçŸ¥ã§ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹', synergy:'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯,æ¤œçŸ¥' },
  { id:'tls', name:'é€šä¿¡æš—å·åŒ–(TLS)', cost:{money:1,labor:1,time:1}, defense:7, text:'ç›—è´ã‚’é˜²æ­¢ã™ã‚‹', synergy:'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯,ä¿è­·' },
  { id:'backup', name:'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—', cost:{money:2,labor:0,time:1}, heal:10, text:'å¾©æ—§ã®ãŸã‚ã®ä¿é™º', synergy:'å¾©æ—§,ãƒ‡ãƒ¼ã‚¿' },
  { id:'logmon', name:'ãƒ­ã‚°ç›£è¦–', cost:{money:1,labor:1,time:1}, draw:1, text:'ç•°å¸¸ã‚’æ¤œå‡ºã™ã‚‹ãƒ’ãƒ³ãƒˆã‚’å¾—ã‚‹', synergy:'æ¤œçŸ¥,é‹ç”¨' },
  { id:'patch', name:'ãƒ‘ãƒƒãƒé©ç”¨', cost:{money:0,labor:1,time:1}, defense:12, text:'è„†å¼±æ€§ã‚’å¡ã', synergy:'é˜²å¾¡,æŠ€è¡“çš„å¯¾ç­–' },
  { id:'2fa', name:'äºŒæ®µéšèªè¨¼å°å…¥', cost:{money:1,labor:1,time:1}, defense:8, text:'ä¸æ­£ãƒ­ã‚°ã‚¤ãƒ³ã‚’å›°é›£ã«ã™ã‚‹', synergy:'è­˜åˆ¥,é˜²å¾¡' },
  { id:'sso', name:'SSOå°å…¥', cost:{money:2,labor:2,time:2}, defense:6, text:'èªè¨¼ç®¡ç†ã‚’åŠ¹ç‡åŒ–', synergy:'è­˜åˆ¥,çµ±æ²»' },
  { id:'edr', name:'EDRå°å…¥', cost:{money:3,labor:2,time:2}, defense:12, text:'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®è„…å¨ã‚’ç›£è¦–ãƒ»é˜²å¾¡', synergy:'ãƒ‡ãƒã‚¤ã‚¹,æ¤œçŸ¥' },
  { id:'ueba', name:'UEBA', cost:{money:3,labor:2,time:2}, debuffEnemy:3, text:'ç•°å¸¸è¡Œå‹•ã‚’æ¤œçŸ¥', synergy:'æ¤œçŸ¥,ãƒ¦ãƒ¼ã‚¶' },
  { id:'ndr', name:'NDRå°å…¥', cost:{money:3,labor:2,time:2}, defense:10, text:'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç•°å¸¸ã‚’ç›£è¦–', synergy:'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯,æ¤œçŸ¥' },
  { id:'cdn', name:'CDNå°å…¥', cost:{money:2,labor:1,time:2}, defense:6, text:'DDoSã‹ã‚‰ã®è€æ€§ã‚’å¼·åŒ–', synergy:'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯,é˜²å¾¡' },
  { id:'dynana', name:'å‹•çš„è§£æã‚µãƒ¼ãƒ“ã‚¹', cost:{money:2,labor:1,time:1}, draw:1, text:'æœªçŸ¥ã®è„…å¨ã‚’æ¤œå‡º', synergy:'æ¤œçŸ¥,ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³' },
  { id:'staticana', name:'é™çš„è§£æã‚µãƒ¼ãƒ“ã‚¹', cost:{money:2,labor:1,time:1}, defense:6, text:'ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‹ã‚‰è„†å¼±æ€§ç™ºè¦‹', synergy:'æ¤œçŸ¥,ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³' },

  // ç‰©ç†çš„å¯¾ç­–
  { id:'lock', name:'ã‚ªãƒ•ã‚£ã‚¹æ–½éŒ ', cost:{money:1,labor:1,time:0}, defense:5, text:'ç‰©ç†çš„ä¾µå…¥ã‚’é˜²ã', synergy:'ç‰©ç†çš„å¯¾ç­–,é˜²å¾¡' },
  { id:'theft', name:'ç›—é›£å¯¾ç­–', cost:{money:1,labor:1,time:1}, defense:5, text:'è³‡ç”£ã‚’å®ˆã‚‹', synergy:'ç‰©ç†çš„å¯¾ç­–,ä¿è­·' },
  { id:'shred', name:'ã‚·ãƒ¥ãƒ¬ãƒƒãƒ€ãƒ¼', cost:{money:1,labor:0,time:0}, defense:4, text:'æƒ…å ±æ¼æ´©ã‚’ç‰©ç†çš„ã«é˜²ã', synergy:'ãƒ‡ãƒ¼ã‚¿,ç‰©ç†çš„å¯¾ç­–' },
  { id:'destroy', name:'ç‰©ç†çš„ç ´å£Š', cost:{money:1,labor:1,time:0}, defense:8, text:'æ©Ÿå¯†ã‚’ç¢ºå®Ÿã«æ¶ˆå»', synergy:'å¾©æ—§,ç‰©ç†çš„å¯¾ç­–' },

  // çµ„ç¹”çš„å¯¾ç­–
  { id:'policy', name:'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒªã‚·ãƒ¼æ•´å‚™', cost:{money:0,labor:2,time:2}, buffDefense:5, text:'ãƒ«ãƒ¼ãƒ«ã‚’ç­–å®šã—ã¦éµå®ˆã•ã›ã‚‹', synergy:'çµ±æ²»,çµ„ç¹”çš„å¯¾ç­–' },
  { id:'team', name:'ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œãƒãƒ¼ãƒ è¨­ç½®', cost:{money:2,labor:2,time:2}, heal:10, text:'è¢«å®³ã‚’æœ€å°åŒ–ã™ã‚‹ä½“åˆ¶', synergy:'å¯¾å¿œ,çµ„ç¹”çš„å¯¾ç­–' },
  { id:'audit', name:'ç›£æŸ»', cost:{money:1,labor:1,time:1}, debuffEnemy:2, text:'è„†å¼±ãªç‚¹ã‚’æ´—ã„å‡ºã™', synergy:'æ¤œçŸ¥,çµ„ç¹”çš„å¯¾ç­–' },
  { id:'threatintel', name:'è„…å¨ã‚¤ãƒ³ãƒ†ãƒªã‚¸ã‚§ãƒ³ã‚¹æ´»ç”¨', cost:{money:2,labor:1,time:1}, draw:1, text:'æ”»æ’ƒã®å…†å€™ã‚’å…ˆå–ã‚Š', synergy:'æ¤œçŸ¥,çµ±æ²»' },
  { id:'insure', name:'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿é™º', cost:{money:3,labor:0,time:0}, heal:15, text:'æå®³ã‚’è£œå„Ÿ', synergy:'å¾©æ—§,çµ„ç¹”çš„å¯¾ç­–' },
  { id:'authctrl', name:'æ¨©é™ç®¡ç†', cost:{money:1,labor:1,time:1}, defense:6, text:'æ¨©é™ã‚’æœ€å°åŒ–ã—ã¦ãƒªã‚¹ã‚¯ä½æ¸›', synergy:'è­˜åˆ¥,çµ„ç¹”çš„å¯¾ç­–' },
  { id:'vulnscan', name:'è„†å¼±æ€§è¨ºæ–­', cost:{money:2,labor:2,time:2}, debuffEnemy:3, text:'å¼±ç‚¹ã‚’çªã‹ã‚Œã‚‹å‰ã«ç™ºè¦‹', synergy:'æ¤œçŸ¥,é˜²å¾¡' },
  { id:'redblue', name:'ãƒ¬ãƒƒãƒ‰/ãƒ–ãƒ«ãƒ¼ãƒãƒ¼ãƒ æ¼”ç¿’', cost:{money:2,labor:3,time:2}, buffDefense:6, text:'æ¨¡æ“¬æ”»é˜²ã§å‚™ãˆã‚‹', synergy:'æ¤œçŸ¥,å¯¾å¿œ' },
  { id:'soc', name:'SOCè¨­ç«‹', cost:{money:3,labor:3,time:3}, defense:15, text:'å¸¸æ™‚ç›£è¦–ä½“åˆ¶ã‚’æ•´ãˆã‚‹', synergy:'æ¤œçŸ¥,çµ„ç¹”çš„å¯¾ç­–' },
  { id:'dlp', name:'DLPå°å…¥', cost:{money:2,labor:2,time:2}, defense:10, text:'æƒ…å ±æ¼æ´©ã‚’æœªç„¶ã«é˜²ã', synergy:'ãƒ‡ãƒ¼ã‚¿,é˜²å¾¡' },

  // äººçš„å¯¾ç­–
  { id:'edu', name:'æƒ…å ±æ•™è‚²', cost:{money:0,labor:2,time:1}, buffDefense:4, text:'ç¤¾å“¡ã®æ„è­˜ã‚’é«˜ã‚ã‚‹', synergy:'äººçš„å¯¾ç­–,çµ±æ²»' },
  { id:'manual', name:'ãƒãƒ‹ãƒ¥ã‚¢ãƒ«åŒ–', cost:{money:0,labor:1,time:1}, defense:4, text:'å¯¾å¿œã‚’æ¨™æº–åŒ–ã—ãƒŸã‚¹ã‚’æ¸›ã‚‰ã™', synergy:'äººçš„å¯¾ç­–,å¯¾å¿œ' },
  { id:'check', name:'ç›¸äº’ç¢ºèªãƒ»ç›£è¦–', cost:{money:0,labor:2,time:0}, defense:5, text:'ä¸æ­£ã‚„èª¤ã‚Šã‚’æ—©æœŸç™ºè¦‹', synergy:'äººçš„å¯¾ç­–,æ¤œçŸ¥' },
  { id:'prevent', name:'æ•…æ„ã®é˜²æ­¢ç­–', cost:{money:1,labor:2,time:1}, defense:7, text:'å†…éƒ¨ä¸æ­£ã‚’æŠ‘æ­¢', synergy:'äººçš„å¯¾ç­–,é˜²å¾¡' },
  { id:'hunt', name:'ã‚¹ãƒ¬ãƒƒãƒ‰ãƒãƒ³ãƒ†ã‚£ãƒ³ã‚°', cost:{money:2,labor:2,time:2}, draw:2, text:'æ½œä¼ã™ã‚‹è„…å¨ã‚’ã‚ã¶ã‚Šå‡ºã™', synergy:'äººçš„å¯¾ç­–,æ¤œçŸ¥' },
];
const EVENT_CARD_TEMPLATES = [
  { id:'incident', name:'ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œ', cost:{money:1,labor:1,time:0}, text:'', synergy:'incident', instant: true, must: true },
  { id:'accident', name:'éšœå®³å¯¾å¿œ', cost:{money:1,labor:1,time:0}, text:'', synergy:'accident', instant: true, must: true },
  { id:'accident', name:'éšœå®³å¯¾å¿œï¼ˆåŸå› å¯¾å‡¦ï¼‰', cost:{money:1,labor:1,time:0}, text:'', synergy:'accident', instant: true}, // ç¾çŠ¶å®Ÿè£…ã ã¨ä½¿ã‚ãªã„
  { id:'customer', name:'é¡§å®¢å¯¾å¿œ', cost:{money:1,labor:1,time:0}, text:'', synergy:'customer', instant:true, must: true },
  { id:'recruit_allies', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä»²é–“ã‚’å‹Ÿé›†ï¼›é•·æœŸè‚²æˆï¼‰', cost:{money:1,labor:2,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'united_we_stand', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå›£çµã¯åŠ›ãªã‚Šï¼›æƒ…å ±äº¤æ›ã‚’æ´»ç™ºåŒ–ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'secure_partnership', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆå®‰å…¨ãªææºï¼›å…±åŒç ”ç©¶ã‚’é–‹å§‹ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'supply_chain_attack', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆç¦ç¦ã‚’å…±ã«ï¼›å³æ™‚èª¿æŸ»ï¼‰', cost:{labor:2,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'careless_member', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸æ³¨æ„ãªä»²é–“ï¼›å¯¾å¿œãƒãƒ¼ãƒ ã‚’æ´¾é£ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'temptation', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæŠ—ã„ãŒãŸã„èª˜æƒ‘ï¼›éš”é›¢ã—ã¦ä¿®å¾©ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'inappropriate', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆä¸€ä½“ä½•ã‚’ï¼›å³å¾©æ—§ä½œæ¥­ï¼‰', cost:{labor:2,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'leak_darkweb', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ³£ãã£é¢ã«èœ‚ï¼›å…¬çš„æ©Ÿé–¢ã«é€šå ±ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'stolen_redteam', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¬ãƒƒãƒ‰ãƒãƒ¼ãƒ ãƒ„ãƒ¼ãƒ«ãŒç›—ã¾ã‚ŒãŸï¼›æ—©æ€¥ã«ãƒ‘ãƒƒãƒå¯¾å¿œï¼‰', cost:{labor:2,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'stolen_redteam', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ¬ãƒƒãƒ‰ãƒãƒ¼ãƒ ãƒ„ãƒ¼ãƒ«ãŒç›—ã¾ã‚ŒãŸï¼›å¤–éƒ¨ã¸æ³¨æ„å–šèµ·ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'fake_security', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆçœŸè´‹ã®è¦‹åˆ†ã‘ãŒã¤ã‹ãªã„è£½å“ï¼›èª¿æŸ»ã—ã¦å°å…¥ä¿ç•™ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'law', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç®¡ç†æ³•ï¼›æ³•å¯¾å¿œã®ä»•çµ„ã¿å°å…¥ï¼‰', cost:{money:1,labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'gdpr', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆGDPRã®æ­£å¼ç™ºåŠ¹ï¼›GDPRæº–æ‹ ä½“åˆ¶ã‚’å°å…¥ï¼‰', cost:{money:2,labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'taiwan_policy', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè³‡å®‰å³å›½å®‰ï¼›æ”¿åºœæ–¹é‡ã«å¾“ã†ï¼‰', cost:{labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'contest_app', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆï¼›å…¨åŠ›å‚åŠ ï¼‰', cost:{labor:2,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'contest_app', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆï¼›å‚åŠ ã™ã‚‹ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'contest_device', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ãƒã‚¤ã‚¹ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆï¼›å…¨åŠ›å‚åŠ ï¼‰', cost:{labor:2,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'contest_device', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ãƒã‚¤ã‚¹ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆï¼›å‚åŠ ã™ã‚‹ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'contest_data', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆï¼›å…¨åŠ›å‚åŠ ï¼‰', cost:{labor:2,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'contest_data', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆï¼›å‚åŠ ã™ã‚‹ï¼‰', cost:{labor:1,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'meltdown', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆMeltdownè„†å¼±æ€§ç™ºç”Ÿï¼›ç·Šæ€¥ä¿®æ­£ï¼‰', cost:{labor:3,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'meltdown', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆMeltdownè„†å¼±æ€§ç™ºç”Ÿï¼›å¾Œæ—¥ä¿®æ­£ï¼‰', cost:{labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'eternalblue', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆEternalBlueè„†å¼±æ€§ç™ºç”Ÿï¼›ç·Šæ€¥ä¿®æ­£ï¼‰', cost:{labor:3,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'eternalblue', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆEternalBlueè„†å¼±æ€§ç™ºç”Ÿï¼›å¾Œæ—¥ä¿®æ­£ï¼‰', cost:{labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'shellshock', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆShellShockè„†å¼±æ€§ç™ºç”Ÿï¼›ç·Šæ€¥ä¿®æ­£ï¼‰', cost:{labor:3,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'shellshock', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆShellShockè„†å¼±æ€§ç™ºç”Ÿï¼›å¾Œæ—¥ä¿®æ­£ï¼‰', cost:{labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'spectre', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆSpectreè„†å¼±æ€§ç™ºç”Ÿï¼›ç·Šæ€¥ä¿®æ­£ï¼‰', cost:{labor:3,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'spectre', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆSpectreè„†å¼±æ€§ç™ºç”Ÿï¼›å¾Œæ—¥ä¿®æ­£ï¼‰', cost:{labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'heartbleed', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆHeartBleedè„†å¼±æ€§ç™ºç”Ÿï¼›ç·Šæ€¥ä¿®æ­£ï¼‰', cost:{labor:3,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'heartbleed', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆHeartBleedè„†å¼±æ€§ç™ºç”Ÿï¼›å¾Œæ—¥ä¿®æ­£ï¼‰', cost:{labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'zerologon', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆZerologonè„†å¼±æ€§ç™ºç”Ÿï¼›ç·Šæ€¥ä¿®æ­£ï¼‰', cost:{labor:3,time:1}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
  { id:'zerologon', name:'ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆZerologonè„†å¼±æ€§ç™ºç”Ÿï¼›å¾Œæ—¥ä¿®æ­£ï¼‰', cost:{labor:1,time:2}, text:'å®Ÿè¡Œä¸­', synergy:'', instant:true},
];


// Enemy templates (concept + ATT&CK-like theme)
const ENEMY_TEMPLATES = {
  normal:[
    {id:'vuln_exploit', name:'è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒŠ', hp:30, def:0, intent:'attack', intentValue:6, tags:['vuln']},
    {id:'phisher', name:'ã‚½ãƒ¼ã‚·ãƒ£ãƒ«ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢', hp:28, def:0, intent:'attack', intentValue:5, tags:['human']},
    {id:'worm', name:'ãƒãƒ«ã‚¦ã‚§ã‚¢é…é€', hp:32, def:2, intent:'attack', intentValue:7, tags:['malware']},
  ],
  elite:[
    {id:'apt_probe', name:'APT åµå¯Ÿ', hp:55, def:3, intent:'attack', intentValue:10, tags:['recon']},
    {id:'supply_chain', name:'ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³', hp:60, def:4, intent:'attack', intentValue:12, tags:['supply']},
  ],
  boss:[
    {id:'zero_day', name:'ã‚¼ãƒ­ãƒ‡ã‚¤æ”»æ’ƒè€…', hp:120, def:6, intent:'attack', intentValue:18, tags:['vuln','remote']},
  ]
};

const EVENT_TEMPLATES = [
  /*
  {id:'budget_cut', text:'ä¼æ¥­ãŒã‚³ã‚¹ãƒˆå‰Šæ¸›ã‚’ç™ºè¡¨ã€‚é‡‘éŠ­ã‚¨ãƒŠã‚¸ãƒ¼æ¸›å°‘', effect:()=>{ RUN.player.gold = Math.max(1, RUN.player.gold-1);} },
  {id:'investment', text:'æŠ•è³‡ãŒå…¥ã‚Šã€é‡‘éŠ­ã‚’ç²å¾—', effect:()=>{ RUN.player.gold += 20; }},
  {id:'insider', text:'å†…éƒ¨ä¸æ­£ã‚’ç™ºè¦‹ï¼äººæ‰‹ãŒæ¸›å°‘', effect:()=>{ RUN.player.maxEnergy--; RUN.player.energy--; }},
  {id:'policy', text:'ãƒãƒªã‚·ãƒ¼åˆ·æ–°ã§ä¸€æ™‚çš„ãƒãƒ•', effect:()=>{ RUN.player.defense += 6; }},
  {id:'zero_day_found', text:'ã‚¼ãƒ­ãƒ‡ã‚¤ã‚’ç™ºè¦‹ï¼ã ãŒèª¿æŸ»ã«æ™‚é–“ãŒå¿…è¦', effect:()=>{ RUN.player.energy -= 1; RUN.player.applyEffectWaiting.push({leftTime: 3, card: { id:'event', name:'Duel Zero Day Vulnerability', cost:{money:1,labor:1,time:0}, text:'ã‚¼ãƒ­ãƒ‡ã‚¤è„†å¼±æ€§å¯¾å¿œ', synergy:'vulnerability' }}); }},
  */
  // è‰¯ã„ã‚¤ãƒ™ãƒ³ãƒˆ
  {id:'recruit_allies', title:'ä»²é–“ã‚’å‹Ÿé›†', text:'', tag: 'good', choices:[
    {option:'é«˜çµ¦ã§ç«¶åˆä»–ç¤¾ã®å„ªç§€ãªäººæã‚’å³æˆ¦åŠ›ã¨ã—ã¦æ¡ç”¨', effect:()=>{ return {labor:+2, money:-2, trust:+1}; }},
    {option:'æ–°äººã‚’é›‡ã†ï¼ç ”ä¿®ã‚’è¡Œã„é•·æœŸè‚²æˆ', effect:()=>{ return {labor:+2, money:-1, time:-1, trust:+2, card:EVENT_CARD_TEMPLATES[4]}; }},
    {option:'å‹Ÿé›†ã—ãªã„', effect:()=>{ return {}; }}
  ]},
  {id:'united_we_stand', title:'å›£çµã¯åŠ›ãªã‚Š', text:'æ¥­ç•Œå›£ä½“ã«åŠ å…¥ã—ã€å”åŠ›ä½“åˆ¶ã‚’å¼·åŒ–ã—ãŸï¼', tag: 'good', choices:[
    //{option:'åŠ å…¥è²»ã‚’æ”¯æ‰•ã†', effect:()=>{ return {money:-1, trust:+2}; }},
    {option:'æƒ…å ±äº¤æ›ã‚’æ´»ç™ºåŒ–', effect:()=>{ return {labor:-1, time:-1, trust:+3, card:EVENT_CARD_TEMPLATES[5]}; }},
    {option:'äººææ´»ç”¨è¡“ã‚’ç¿’ã†', effect:()=>{ return {labor:+1}; }}
  ]},
  {id:'iso_cert', title:'ISO27001ã«åˆæ ¼', text:'æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆå›½éš›è¦æ ¼ã«èªå®šï¼', tag: 'good', choices:[
    {option:'ä¿¡é ¼ã‚’å¾—ã‚‰ã‚Œã‚‹ã‚ˆã†ã«ï¼Œåºƒå ±ã—ã¦ã‚¢ãƒ”ãƒ¼ãƒ«', effect:()=>{ return {trust:+3}; }},
    {option:'åç›Šã«ç¹‹ãŒã‚‹ã‚ˆã†ã«ï¼Œåºƒå ±ã—ã¦ã‚¢ãƒ”ãƒ¼ãƒ«', effect:()=>{ return {money:+1}; }},
    {option:'æ¡ç”¨ã«ç¹‹ãŒã‚‹ã‚ˆã†ã«ï¼Œåºƒå ±ã—ã¦ã‚¢ãƒ”ãƒ¼ãƒ«', effect:()=>{ return {labor:+1}; }}
  ]},
  {id:'bug_bounty', title:'BugBounty', text:'è„†å¼±æ€§å ±å¥¨é‡‘åˆ¶åº¦ã‚’å°å…¥ï¼', tag: 'good', choices:[
    {option:'å°å…¥ã™ã‚‹', effect:()=>{ return {money:-2}; }},
    {option:'ä½•ã‚‚ã—ãªã„', effect:()=>{ return {}; }}
    /*
    {option:'ã™ãä¿®æ­£ã«å–ã‚Šçµ„ã‚€', effect:()=>{ return {labor:-1, time:-1, money:-1, trust:+2}; }},
    {option:'å ±é…¬ã‚’å¢—é¡', effect:()=>{ return {money:-2, trust:+3}; }}
    */
  ]},
  {id:'profit_security', title:'æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã§å¤§å„²ã‘', text:'é•·å¹´ã®æŠ•è³‡ãŒå®Ÿã‚Šé¡§å®¢ä¿¡é ¼UPï¼', tag: 'good', choices:[
    {option:'é…å½“ã‚’å‡ºã™', effect:()=>{ return {money:+3, trust:+1}; }},
    {option:'å†æŠ•è³‡', effect:()=>{ return {money:+1, trust:+2}; }}
  ]},
  {id:'ai_defense', title:'AIé˜²å¾¡ã‚·ã‚¹ãƒ†ãƒ ', text:'AIãƒ™ãƒ¼ã‚¹ã®é˜²å¾¡ã‚·ã‚¹ãƒ†ãƒ ã‚’å°å…¥ã™ã‚‹ï¼Ÿ', tag: 'good', choices:[
    {option:'é«˜é¡ã ãŒå°å…¥', effect:()=>{ return {money:-2, trust:+3}; }},
    {option:'è©¦é¨“å°å…¥ã®ã¿', effect:()=>{ return {money:-1, trust:+1}; }}
  ]},
  {id:'secure_partnership', title:'å®‰å…¨ãªææº', text:'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ„è­˜ã®é«˜ã„ä¼æ¥­ã¨ææºï¼', tag: 'good', choices:[
    {option:'å…±åŒç ”ç©¶ã‚’é–‹å§‹', effect:()=>{ return {labor:-1, time:-1, trust:+3, card:EVENT_CARD_TEMPLATES[6]}; }},
    {option:'èƒ½åŠ›ç²å¾—ã‚’ç›¸äº’æ”¯æ´', effect:()=>{ return {labor:+1}; }}
  ]},
  {id:'academic_collab', title:'å¤§å­¦ã¨å…±åŒç ”ç©¶', text:'å¤§å­¦ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†é‡ã§å…±åŒç ”ç©¶ï¼', tag: 'good', choices:[
    {option:'ç ”ç©¶ã«è³‡é‡‘æä¾›', effect:()=>{ return {money:-2, labor:+1}; }}
    //{option:'', effect:()=>{ return {labor:-2, trust:+2}; }}
  ]},
  {id:'fast_response', title:'è¿…é€Ÿãªå¯¾å¿œ', text:'ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆå¯¾å¿œã®è¿…é€Ÿã•ãŒè©•ä¾¡ã•ã‚ŒãŸï¼', tag: 'good', choices:[
    {option:'ç¤¾å†…ã§å£«æ°—å‘ä¸Š', effect:()=>{ return {labor:+1, trust:+2}; }}
  ]},
  {id:'client_contract', title:'å¤§å£å¥‘ç´„ç²å¾—', text:'å¤§æ‰‹ä¼æ¥­ã¨ã®å¥‘ç´„ã‚’ç²å¾—ï¼', tag: 'good', choices:[
    {option:'çŸ­æœŸå¥‘ç´„ï¼ˆä¸€æ™‚çš„è³‡é‡‘ï¼‰', effect:()=>{ return {money:+3, trust:+2}; }},
    {option:'é•·æœŸå¥‘ç´„ï¼ˆäºˆç®—å¢—é¡ï¼‰', effect:()=>{ return {budget:+5, trust:+2}; }}
  ]},
  {id:'security_awareness', title:'å¾“æ¥­å“¡æ„è­˜å‘ä¸Š', text:'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ•™è‚²ãŒæˆåŠŸã—å¾“æ¥­å“¡ã®æ„è­˜ãŒUPï¼', tag: 'good', choices:[
    //{option:'æ•™è‚²ç¶™ç¶š', effect:()=>{ return {time:-1, labor:+2, trust:+2}; }},
    {option:'æ•™è‚²ç¶™ç¶š', effect:()=>{ return {labor:+1, trust:+2}; }}
  ]},
  {id:'cyber_insurance', title:'ã‚µã‚¤ãƒãƒ¼ä¿é™ºå°å…¥', text:'ä¿é™ºã«ã‚ˆã‚‹ãƒªã‚¹ã‚¯åˆ†æ•£ã‚’å®Ÿç¾ã§ãã‚‹', tag: 'good', choices:[
    {option:'é«˜é¡ä¿é™ºã«åŠ å…¥', effect:()=>{ return {money:-2, trust:+3}; }},
    {option:'æœ€ä½é™ã®ä¿é™ºã«åŠ å…¥', effect:()=>{ return {money:-1, trust:+1}; }},
    {option:'ä½•ã‚‚ã—ãªã„', effect:()=>{ return {trust:-2}; }}
  ]},
  {id:'global_expansion', title:'æµ·å¤–é€²å‡ºæˆåŠŸ', text:'æµ·å¤–å¸‚å ´ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ãŒè©•ä¾¡ã•ã‚ŒãŸï¼', tag: 'good', choices:[
    {option:'ç¾åœ°æ³•äººã‚’è¨­ç«‹', effect:()=>{ return {money:-3, trust:+4}; }},
    {option:'äººæã‚’æ´¾é£ã™ã‚‹', effect:()=>{ return {labor:-1, money:+2, trust:+2}; }},
    {option:'ä½•ã‚‚ã—ãªã„', effect:()=>{ return {trust:+1}; }},
  ]},
  // ===== å•é¡Œç™ºç”Ÿ =====
  {id:'supply_chain_attack', title:'ç¦ç¦ã‚’å…±ã«', text:'ã‚µãƒ—ãƒ©ã‚¤ãƒã‚§ãƒ¼ãƒ³ä¸ŠæµãŒä¾µå…¥ã•ã‚ŒãŸï¼', tag: 'bad', choices:[
    {option:'å³æ™‚èª¿æŸ»', effect:()=>{ return {labor:-2, time:-1, trust:-2, card:EVENT_CARD_TEMPLATES[7]}; }},
    {option:'å¤–éƒ¨ã‚³ãƒ³ã‚µãƒ«ä¾é ¼', effect:()=>{ return {money:-2, trust:-1}; }}
  ]},
  {id:'careless_member', title:'ä¸æ³¨æ„ãªä»²é–“', text:'PCã‚’ç´›å¤±ã—æ©Ÿå¯†æƒ…å ±æ¼æ´©ã®å±æ©Ÿï¼', tag: 'bad', choices:[
    {option:'å¯¾å¿œãƒãƒ¼ãƒ ã‚’æ´¾é£', effect:()=>{ return {labor:-1, time:-1, trust:-2, card:EVENT_CARD_TEMPLATES[8]}; }},
    {option:'æ”¾ç½®ï¼ˆéš è”½ï¼‰', effect:()=>{ return {trust:-4}; }}
  ]},
  {id:'hidden_truth', title:'éš ã•ã‚ŒãŸçœŸå®Ÿ', text:'ãƒ©ãƒ³ã‚µãƒ è¢«å®³ãŒç™ºç”Ÿï¼è©•åˆ¤ãŒä½ä¸‹â€¦', tag: 'bad', choices:[
    {option:'å…¬è¡¨ã™ã‚‹', effect:()=>{ return {trust:-2, money:-5}; }},
    {option:'éš è”½ã™ã‚‹', effect:()=>{ return {trust:-4}; }}
  ]},
  {id:'temptation', title:'æŠ—ã„ãŒãŸã„èª˜æƒ‘', text:'ãƒ¡ãƒ¼ãƒ«ã®ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ„ŸæŸ“ï¼', tag: 'bad', choices:[
    {option:'éš”é›¢ã—ã¦ä¿®å¾©', effect:()=>{ return {labor:-1, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[9]}; }}
  ]},
  {id:'inappropriate', title:'ä¸€ä½“ä½•ã‚’', text:'å°±æ¥­ä¸­ã«ã‚¢ãƒ€ãƒ«ãƒˆã‚µã‚¤ãƒˆé–²è¦§â†’ã‚·ã‚¹ãƒ†ãƒ åœæ­¢ï¼', tag: 'bad', choices:[
    {option:'å¾“æ¥­å“¡ã‚’å‡¦åˆ†', effect:()=>{ return {labor:-1, trust:-1}; }},
    {option:'å³å¾©æ—§ä½œæ¥­', effect:()=>{ return {labor:-2, time:-2, trust:-2, card:EVENT_CARD_TEMPLATES[10]}; }}
  ]},
  {id:'hire_hacker', title:'ç›®ã«ã‚‚ã®è¦‹ã›ã¦ã‚„ã‚‹', text:'ãƒãƒƒã‚«ãƒ¼ã‚’é›‡ã£ã¦ç«¶åˆã‚’æ”»æ’ƒï¼', tag: 'bad', choices:[
    {option:'å¼·è¡Œã™ã‚‹', effect:()=>{ return {trust:-4, money:-2}; }},
    {option:'è¸ã¿ã¨ã©ã¾ã‚‹', effect:()=>{ return {trust:+1}; }}
  ]},
  {id:'leak_darkweb', title:'æ³£ãã£é¢ã«èœ‚', text:'é‡è¦æƒ…å ±ãŒãƒ€ãƒ¼ã‚¯ã‚¦ã‚§ãƒ–ã§è²©å£²ï¼', tag: 'bad', choices:[
    {option:'å¼è­·å£«ã‚’é›‡ã†', effect:()=>{ return {money:-2, trust:-2}; }},
    {option:'å…¬çš„æ©Ÿé–¢ã«é€šå ±', effect:()=>{ return {labor:-1, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[11]}; }}
  ]},
  {id:'stolen_redteam', title:'ãƒ¬ãƒƒãƒ‰ãƒãƒ¼ãƒ ãƒ„ãƒ¼ãƒ«ãŒç›—ã¾ã‚ŒãŸ', text:'æ”»æ’ƒæ‰‹æ³•ãŒä¸–ç•Œã«æ‹¡æ•£ï¼', tag: 'bad', choices:[
    {option:'æ—©æ€¥ã«ãƒ‘ãƒƒãƒå¯¾å¿œ', effect:()=>{ return {labor:-2, time:-2, card:EVENT_CARD_TEMPLATES[12]}; }},
    {option:'å¤–éƒ¨ã¸æ³¨æ„å–šèµ·', effect:()=>{ return {labor:-1, time:-1, trust:-2, card:EVENT_CARD_TEMPLATES[13]}; }}
  ]},
  {id:'fake_security', title:'çœŸè´‹ã®è¦‹åˆ†ã‘ãŒã¤ã‹ãªã„è£½å“', text:'å½é€ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è£½å“ã‚’å°å…¥ã‹ï¼ï¼Ÿ', tag: 'bad', choices:[
    {option:'èª¿æŸ»ã—ã¦å°å…¥ä¿ç•™', effect:()=>{ return {labor:-1, time:-1, trust:+1, card:EVENT_CARD_TEMPLATES[14]}; }},
    {option:'ãã®ã¾ã¾åˆ©ç”¨', effect:()=>{ return {trust:-3}; }}
  ]},
  // ===== ä¿è­·æ³•ãƒ»æ”¿ç­– =====
  {id:'law', title:'æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç®¡ç†æ³•', text:'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç®¡ç†æ³•ãŒæ–½è¡Œã•ã‚ŒãŸ', tag: 'society', choices:[
    {option:'æ³•å¯¾å¿œã®ä»•çµ„ã¿å°å…¥', effect:()=>{ return {money:-1, labor:-1, time:-2, trust:+2, card:EVENT_CARD_TEMPLATES[15]}; }},
    {option:'å°å…¥è¦‹é€ã‚Š', effect:()=>{ return {trust:-1}; }}
  ]},
  {id:'gdpr', title:'GDPRã®æ­£å¼ç™ºåŠ¹', text:'EUã§å€‹äººãƒ‡ãƒ¼ã‚¿ä¿è­·æ³•ãŒæ–½è¡Œï¼', tag: 'society', choices:[
    {option:'GDPRæº–æ‹ ä½“åˆ¶ã‚’å°å…¥', effect:()=>{ return {money:-2, labor:-1, time:-2, trust:+3, card:EVENT_CARD_TEMPLATES[16]}; }},
    {option:'å°å…¥è¦‹é€ã‚Š', effect:()=>{ return {trust:-2}; }}
  ]},
  {id:'taiwan_policy', title:'è³‡å®‰å³å›½å®‰', text:'æƒ…å ±ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãŒå›½å®‰æ”¿ç­–ã«ï¼', tag: 'society', choices:[
    {option:'æ”¿åºœæ–¹é‡ã«å¾“ã†', effect:()=>{ return {labor:-1, time:-2, trust:+2, card:EVENT_CARD_TEMPLATES[17]}; }},
    {option:'å°å…¥è¦‹é€ã‚Š', effect:()=>{ return {}; }}
  ]},
  {id:'gov_grant', title:'æ”¿åºœè£œåŠ©é‡‘ç²å¾—', text:'æ”¿åºœã®ã‚µã‚¤ãƒãƒ¼ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è£œåŠ©é‡‘ã‚’ç²å¾—ï¼', tag: 'society', choices:[
    {option:'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã«æŠ•è³‡', effect:()=>{ return {money:+2, trust:+1}; }}
  ]},

  // ===== ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ =====
  {id:'contest_app', title:'ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ', text:'ã‚¢ãƒ—ãƒªé˜²å¾¡å¤§ä¼šã«å‚åŠ ï¼', tag: 'contest', choices:[
    {option:'å…¨åŠ›å‚åŠ ', effect:()=>{ return {labor:-2, time:-2, trust:+3, card:EVENT_CARD_TEMPLATES[18]}; }},
    {option:'å‚åŠ ã™ã‚‹', effect:()=>{ return {labor:-1, time:-1, trust:+1, card:EVENT_CARD_TEMPLATES[19]}; }},
    {option:'è¦‹é€ã‚Š', effect:()=>{ return {trust:-1}; }}
  ]},
  {id:'contest_device', title:'ãƒ‡ãƒã‚¤ã‚¹ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ', text:'ãƒ‡ãƒã‚¤ã‚¹é˜²å¾¡å¤§ä¼šã«å‚åŠ ï¼', tag: 'contest', choices:[
    {option:'å…¨åŠ›å‚åŠ ', effect:()=>{ return {labor:-2, time:-2, trust:+3, card:EVENT_CARD_TEMPLATES[20]}; }},
    {option:'å‚åŠ ã™ã‚‹', effect:()=>{ return {labor:-1, time:-1, trust:+1, card:EVENT_CARD_TEMPLATES[21]}; }},
    {option:'è¦‹é€ã‚Š', effect:()=>{ return {trust:-1}; }}
  ]},
  {id:'contest_data', title:'ãƒ‡ãƒ¼ã‚¿ä¿è­·ã‚³ãƒ³ãƒ†ã‚¹ãƒˆ', text:'ãƒ‡ãƒ¼ã‚¿ä¿è­·å¤§ä¼šã«å‚åŠ ï¼', tag: 'contest', choices:[
    {option:'å…¨åŠ›å‚åŠ ', effect:()=>{ return {labor:-2, time:-2, trust:+3, card:EVENT_CARD_TEMPLATES[22]}; }},
    {option:'å‚åŠ ã™ã‚‹', effect:()=>{ return {labor:-1, time:-1, trust:+1, card:EVENT_CARD_TEMPLATES[23]}; }},
    {option:'è¦‹é€ã‚Š', effect:()=>{ return {trust:-1}; }}
  ]},
  {id:'talent_award', title:'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£äººæè³', text:'å¾“æ¥­å“¡ãŒæ¥­ç•Œã®äººæè³ã‚’å—è³ï¼', tag: 'contest', choices:[
    {option:'ç¥ç¦ã—ï¼Œå£«æ°—é«˜æš', effect:()=>{ return {labor:+1, trust:+2}; }},
    {option:'ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§åºƒå ±', effect:()=>{ return {money:+1}; }}
  ]},
  {id:'award_cert', title:'æ¥­ç•Œè¡¨å½°', text:'å„ªã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‹ç”¨ã§è¡¨å½°ã•ã‚ŒãŸï¼', tag: 'contest', choices:[
    {option:'ç¥ç¦ã—ï¼Œå£«æ°—é«˜æš', effect:()=>{ return {labor:+1}; }},
    {option:'ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§åºƒå ±', effect:()=>{ return {trust:+3}; }},
  ]},

  // ===== è„†å¼±æ€§ã®ç™ºç”Ÿ =====
  {id:'meltdown', title:'Meltdownè„†å¼±æ€§ç™ºç”Ÿ', text:'CPUè¨­è¨ˆæ¬ é™¥ã«ã‚ˆã‚‹è„†å¼±æ€§ï¼', tag: 'vuln', choices:[
    {option:'ç·Šæ€¥ä¿®æ­£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[24]}; }},
    {option:'å¾Œæ—¥ä¿®æ­£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[25]}; }}
    //{option:'ãƒ‘ãƒƒãƒã‚’é©ç”¨', effect:()=>{ return {labor:-1, time:-1, trust:-1}; }}
  ]},
  {id:'eternalblue', title:'EternalBlueè„†å¼±æ€§ç™ºç”Ÿ', text:'SMBã‚µãƒ¼ãƒ“ã‚¹ã®è„†å¼±æ€§ï¼', tag: 'vuln', choices:[
    {option:'ç·Šæ€¥ä¿®æ­£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[26]}; }},
    {option:'å¾Œæ—¥ä¿®æ­£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[27]}; }}
    //{option:'ã‚·ã‚¹ãƒ†ãƒ æ›´æ–°', effect:()=>{ return {labor:-1, trust:-1}; }}
  ]},
  {id:'shellshock', title:'ShellShockè„†å¼±æ€§ç™ºç”Ÿ', text:'Bashã«æ·±åˆ»ãªè„†å¼±æ€§ï¼', tag: 'vuln', choices:[
    {option:'ç·Šæ€¥ä¿®æ­£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[28]}; }},
    {option:'å¾Œæ—¥ä¿®æ­£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[29]}; }}
    //{option:'å…¨ã‚µãƒ¼ãƒä¿®æ­£', effect:()=>{ return {labor:-2, time:-2, trust:-2}; }}
  ]},
  {id:'spectre', title:'Spectreè„†å¼±æ€§ç™ºç”Ÿ', text:'æŠ•æ©Ÿçš„å®Ÿè¡Œæ¬ é™¥ã«ã‚ˆã‚Šãƒ¡ãƒ¢ãƒªæ¼æ´©ï¼', tag: 'vuln', choices:[
    {option:'ç·Šæ€¥ä¿®æ­£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[30]}; }},
    {option:'å¾Œæ—¥ä¿®æ­£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[31]}; }}
    //{option:'æš«å®šç·©å’Œç­–ã‚’å°å…¥', effect:()=>{ return {time:-1, trust:-1}; }}
  ]},
  {id:'heartbleed', title:'HeartBleedè„†å¼±æ€§ç™ºç”Ÿ', text:'OpenSSLã®ãƒã‚°ã«ã‚ˆã‚Šæƒ…å ±æ¼æ´©ï¼', tag: 'vuln', choices:[
    {option:'ç·Šæ€¥ä¿®æ­£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[32]}; }},
    {option:'å¾Œæ—¥ä¿®æ­£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[33]}; }}
    //{option:'ç·Šæ€¥ä¿®æ­£', effect:()=>{ return {labor:-1, trust:-2}; }}
  ]},
  {id:'zerologon', title:'Zerologonè„†å¼±æ€§ç™ºç”Ÿ', text:'èªè¨¼ãƒã‚¤ãƒ‘ã‚¹ã®æ·±åˆ»ãªè„†å¼±æ€§ï¼', tag: 'vuln', choices:[
    {option:'ç·Šæ€¥ä¿®æ­£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[34]}; }},
    {option:'å¾Œæ—¥ä¿®æ­£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[35]}; }}
    //{option:'å³åº§ã«ä¿®æ­£', effect:()=>{ return {labor:-2, trust:-2}; }}
  ]},
];

// Relic templates
const RELIC_TEMPLATES = [
  {id:'inc_budget', name:'äºˆç®—å¢—é¡', desc:'äºˆç®—ã®é‡ã‚’è¿½åŠ ', effect:()=>{RUN.budget += 10;}},
  //{id:'team_hire', name:'è‡¨æ™‚è¦å“¡', desc:'åŠ´åƒåŠ›æœ€å¤§+1', effect:(player)=>{player.maxEnergy.labor++; player.energy.labor++;}},
  {id:'team_hire', name:'è‡¨æ™‚è¦å“¡', desc:'åŠ´åƒåŠ›æœ€å¤§+1', effect:()=>{RUN.player.maxEnergy.labor++; RUN.player.energy.labor++;}},
  {id:'automation', name:'è‡ªå‹•åŒ–ãƒ„ãƒ¼ãƒ«', desc:'æ¬¡å›æ¥­å‹™æ™‚,é©ç”¨å¾…ã¡ã®åŠ¹æœã‚’\n1tçµŒéã—ãŸçŠ¶æ…‹ã§é–‹å§‹ã™ã‚‹', effect:()=>{RUN.automationFlag = true;}},
  //{id:'network_expert', name:'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å°‚é–€å®¶', desc:'networkã‚·ãƒŠã‚¸ãƒ¼ã‚«ãƒ¼ãƒ‰ã®é˜²å¾¡åŠ¹æœå‘ä¸Š', effect:null},
];

/* ---------- Game State (persistent across scenes during one run) ---------- */
class RunState {
  constructor(){
    this.resetAll();
  }
  resetAll(){
    this.stageIndex = 0;
    this.map = []; // will be array of nodes
    this.debugMap = [];
    this.mapOptions = 2;
    // Player base stats / resources
    this.player = {
      maxHp: 100,
      hp: 100,
      maxHiddenHp: 10,
      hiddenHp: 10,
      defense: 0,
      gold: 10,
      drawcards: 5,
      // triple-energy
      maxEnergy: 3,
      energy: 3,
      relics: [],
      deck: [],
      discard: [],
      drawPile: [],
      applyEffect: [],
      applyEffectWaiting: []
    };
    // gold -> money resource used for shops but also energy
    this.budget = 10;
    //this.gold = 100;
    // store all-owned relic ids
    this.relicIds = new Set();
    this.automationFlag = false;
    this.playTime = 0;
    this.startTimestamp = Date.now();
  }

  applyRelic(relic){
    //if(this.relicIds.has(relic.id)) return;
    this.relicIds.add(relic.id);
    this.player.relics.push(relic);
    if(relic.effect) relic.effect(this.player);
  }

  renderCard(scene, x, y, width, height, card, onClick = null){
    const cardBg = scene.add.rectangle(x, y, width, height, 0x333333).setOrigin(0.5);
    cardBg.setStrokeStyle(2, 0xffffff);

    // ã‚«ãƒ¼ãƒ‰å
    const nameText = scene.add.text(x, y - 50, card.name, {
      fontSize: "14px",
      color: "#ffffff",
      align: "center",
      wordWrap: { width: 90 }
    }).setOrigin(0.5);

    // ã‚³ã‚¹ãƒˆè¡¨ç¤º
    const costText = scene.add.text(x, y - 20, `ğŸ’°${card.cost.money} ğŸ‘¥${card.cost.labor} â±${card.cost.time}`, {
      fontSize: "12px",
      color: "#ffcc00",
      align: "center"
    }).setOrigin(0.5);

    // åŠ¹æœèª¬æ˜
    const effectText = scene.add.text(x, y + 20, `${card.text}`, {
      fontSize: "12px",
      color: "#00ff00",
      align: "center"
    }).setOrigin(0.5);
    //const body = this.add.text(x,y-20,card.text,{fontSize:12,wordWrap:{width:160}}).setOrigin(0.5);

    // ã‚«ãƒ¼ãƒ‰ã‚’ã¾ã¨ã‚ã¦è¿”ã™ï¼ˆå‰Šé™¤ã‚„ç§»å‹•ã«ä½¿ãˆã‚‹ã‚ˆã†ã«ï¼‰
    return { cardBg, nameText, costText, effectText };
  }

  showBtn(scene, x, y, text, color, width=200,height=40){
    const Btn = scene.add.rectangle(x,y,width,height,color).setInteractive();
    const Txt = scene.add.text(x,y,text, {fontSize:16}).setOrigin(0.5);
    return {btn: Btn, txt: Txt};
  }
  showSomething(scene, text){
    const modal = scene.add.rectangle(600,360,700,420,0x000000,0.8).setDepth(10);
    const close = scene.add.rectangle(600,620,100,40,0xff7777).setInteractive().setDepth(11);
    const closeText = scene.add.text(600,620,'é–‰ã˜ã‚‹',{fontSize:16}).setOrigin(0.5).setDepth(11);
    const Txt = scene.add.text(300,240,text, {fontSize:14}).setDepth(11);
    close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
  }
  showBtns(scene, deckFlag, diccardFlag, drawFlag, effFlag, waitEffFlag){
    if(deckFlag)    this.showDeckViewBtn(scene);
    if(diccardFlag) this.showDiscardpileViewBtn(scene);
    if(drawFlag)    this.showDrawpileViewBtn(scene);
    if(effFlag)     this.showEffectBtn(scene);
    if(waitEffFlag) this.showWaitEffectBtn(scene);
  }
  showDeckViewBtn(scene, x=1100, y=20){
    //const Btn = scene.add.rectangle(x,y,200,40,0x2dcc70).setInteractive();
    //scene.add.text(x,y,'ãƒ‡ãƒƒã‚­ã‚’è¦‹ã‚‹', {fontSize:16}).setOrigin(0.5);
    const Btn = this.showBtn(scene, x, y, 'ãƒ‡ãƒƒã‚­ã‚’è¦‹ã‚‹', 0x2dcc70).btn;
    //Btn.on('pointerdown', ()=> this.showDeck(scene));
    Btn.on('pointerdown', ()=> this.showSomething(scene, `ãƒ‡ãƒƒã‚­:\n${this.player.deck.map(c=>c.name).join('\n')}\n\næ‰€æŒã‚µãƒãƒ¼ãƒˆ:\n${this.player.relics.map(r=>r.name).join(', ')||'ãªã—'}`));
  }
  /*
  showDeck(scene){
    const modal = scene.add.rectangle(600,360,700,420,0x000000,0.8).setDepth(10);
    const close = scene.add.rectangle(600,620,100,40,0xff7777).setInteractive().setDepth(11);
    const closeText = scene.add.text(600,620,'é–‰ã˜ã‚‹',{fontSize:16}).setOrigin(0.5).setDepth(11);
    const Txt = scene.add.text(300,240,`ãƒ‡ãƒƒã‚­:\n${this.player.deck.map(c=>c.name).join('\n')}\n\næ‰€æŒãƒ¬ãƒªãƒƒã‚¯:\n${this.player.relics.map(r=>r.name).join(', ')||'ãªã—'}`, {fontSize:14}).setDepth(11);
    close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
  }
  */
  showDiscardpileViewBtn(scene, x=100, y=700){
    //const Btn = scene.add.rectangle(x,y,200,40,0xff0000).setInteractive();
    //scene.add.text(x,y,'æ¨ã¦æœ­ã‚’è¦‹ã‚‹', {fontSize:16}).setOrigin(0.5);
    const Btn = this.showBtn(scene, x, y, 'æ¨ã¦æœ­ã‚’è¦‹ã‚‹', 0xff0000).btn;
    Btn.on('pointerdown', ()=> this.showSomething(scene, `æ¨ã¦æœ­:\n${this.player.discard.map(c=>c.name).join('\n')}\n`));
    /*
    Btn.on('pointerdown', ()=> {
      const modal = scene.add.rectangle(600,360,700,420,0x000000,0.8).setDepth(10);
      const close = scene.add.rectangle(600,620,100,40,0xff7777).setInteractive().setDepth(11);
      const closeText = scene.add.text(600,620,'é–‰ã˜ã‚‹',{fontSize:16}).setOrigin(0.5).setDepth(11);
      const Txt = scene.add.text(300,240,`æ¨ã¦æœ­:\n${this.player.discard.map(c=>c.name).join('\n')}\n`, {fontSize:14}).setDepth(11);
      close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
    });
    */
  }
  showDrawpileViewBtn(scene, x=1100, y=700){
    //const Btn = scene.add.rectangle(x,y,200,40,0x0070ff).setInteractive();
    //scene.add.text(x,y,'å±±æœ­ã‚’è¦‹ã‚‹', {fontSize:16}).setOrigin(0.5);
    const Btn = this.showBtn(scene, x, y, 'å±±æœ­ã‚’è¦‹ã‚‹', 0x0070ff).btn;
    Btn.on('pointerdown', ()=> this.showSomething(scene, `å±±æœ­:\n${this.player.drawPile.map(c=>c.name).join('\n')}\n`));
    /*
    Btn.on('pointerdown', ()=> {
      const modal = scene.add.rectangle(600,360,700,420,0x000000,0.8).setDepth(10);
      const close = scene.add.rectangle(600,620,100,40,0xff7777).setInteractive().setDepth(11);
      const closeText = scene.add.text(600,620,'é–‰ã˜ã‚‹',{fontSize:16}).setOrigin(0.5).setDepth(11);
      const Txt = scene.add.text(300,240,`å±±æœ­:\n${this.player.drawPile.map(c=>c.name).join('\n')}\n`, {fontSize:14}).setDepth(11);
      close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
    });
    */
  }
  showEffectBtn(scene, x=1100, y=100){
    //const Btn = scene.add.rectangle(x,y,200,40,0xffff00).setInteractive();
    //scene.add.text(x,y,'ã‹ã‹ã£ã¦ã„ã‚‹åŠ¹æœ', {fontSize:16, color: "#88f"}).setOrigin(0.5);
    const Btn = this.showBtn(scene, x, y, 'ã‹ã‹ã£ã¦ã„ã‚‹åŠ¹æœ', 0x66ff00).btn;
    Btn.on('pointerdown', ()=> this.showSomething(scene, `åŠ¹æœ:\n${this.player.applyEffect.map((c)=>`${c.card.name} Ã— ${c.stack}`).join('\n')}\n`));
  }
  showWaitEffectBtn(scene, x=1100, y=160){
    const Btn = this.showBtn(scene, x, y, 'é©ç”¨å¾…ã¡ã®åŠ¹æœ', 0xffcc00).btn;
    Btn.on('pointerdown', ()=> this.showSomething(scene, `é©ç”¨å¾…ã¡ã®åŠ¹æœ:\n${this.player.applyEffectWaiting.map((c)=>`${c.card.name} : æ®‹ã‚Š${c.leftTime}ã‚¿ãƒ¼ãƒ³, ã‹ã‹ã£ã¦ã‚‹äººæ‰‹: ${c.card.cost.labor}`).join('\n')}\n`));
  }

  showPlayerStatusChangeST(scene, st){
    return this.showPlayerStatus(scene,30,10,18,st,this.formatMoney(),this.formatPassive());
  }
  showPlayerStatusChangeMT(scene, mt){
    return this.showPlayerStatus(scene,30,10,18,this.formatStatus(),mt,this.formatPassive());
  }
  showPlayerStatusChangePT(scene, pt){
    return this.showPlayerStatus(scene,30,10,18,this.formatStatus(),this.formatMoney(),pt);
  }
  showPlayerStatus(scene, x=30, y=10, pix=18, st=this.formatStatus(), mt=this.formatMoney(), pt=this.formatPassive()){
    /*
    const statusText = scene.add.text(30,600,`HP: ${RUN.player.hp}/${RUN.player.maxHp}    è³‡é‡‘: ${RUN.player.gold}, äºˆç®—: ${RUN.budget}`, {fontSize:18});
    const passiveText = scene.add.text(30,620,`æ©Ÿæãƒ»ã‚¹ã‚­ãƒ«: ${RUN.player.relics.map(r=>r.name).join(', ')||'ãªã—'}`, {fontSize:14});
    */
    const statusText = scene.add.text(x,y,st, {fontSize:pix});
    const moneyText = scene.add.text(x,y+20,mt, {fontSize:pix});
    const passiveText = scene.add.text(x,y+40,pt, {fontSize:pix});
    return { statusText, moneyText, passiveText }
  }
  formatStatus(){
    const p = RUN.player;
    let txt;
    if(debugMode) txt = `HP: ${p.hp}  äººæ‰‹: ${p.energy}/${p.maxEnergy}  é˜²å¾¡åŠ›: ${p.defense}`;
    else txt = `HP: ${p.hp}  äººæ‰‹: ${p.energy}/${p.maxEnergy}`;
    return txt;
  }
  formatMoney(){
    return `è³‡é‡‘: ${RUN.player.gold}, äºˆç®—: ${RUN.budget}`;
  }
  formatPassive(){
    return   `æ©Ÿæãƒ»ã‚¹ã‚­ãƒ«: ${RUN.player.relics.map(r=>r.name).join(', ')||'ãªã—'}`;
  }
}

const RUN = new RunState();

/* ---------- Phaser Config ---------- */
const config = {
  type: Phaser.AUTO,
  width: 1200,
  height: 720,
  parent: 'game-container',
  backgroundColor: '#1a1a1a',
  scene: []
};

/* ---------- Scenes ---------- */

/* OpeningScene */
class OpeningScene extends Phaser.Scene {
  constructor(){ super({key:'OpeningScene'}); }
  create(){
    RUN.resetAll();
    this.add.text(600,120,'Security Card Defense', {fontSize:36}).setOrigin(0.5);
    this.add.text(600,180,'ã‚ãªãŸã¯ä¸­å°ä¼æ¥­ã®æ–°ç±³ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼Tã€‚ä¸€å®šæœŸé–“ã‚’å®ˆã‚Šåˆ‡ã‚Œï¼', {fontSize:20}).setOrigin(0.5);
    const startBtn = this.add.rectangle(600,360,300,70,0x2d8cff).setInteractive();
    const startText = this.add.text(600,360,'ã‚²ãƒ¼ãƒ é–‹å§‹', {fontSize:24}).setOrigin(0.5);
    startBtn.on('pointerdown', ()=>{
      // prepare starting deck
      RUN.player.deck = [];
      // start with basic cards
      /*
      for(let i=0;i<4;i++) RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[0]))); // firewall
      for(let i=0;i<4;i++) RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[1]))); // patch
      RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[3]))); // monitor
      */
      for(let i=0;i<3;i++) RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[2]))); // firewall
      for(let i=0;i<3;i++) RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[10]))); // patch
      RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[25]))); // audit
      // shuffle and init map
      RUN.player.discard = [];
      RUN.player.drawPile = Util.shuffle(RUN.player.deck.slice());
      this.scene.start('MapScene');
    });
    if(debugMode){
      // show sample run info
      this.add.text(60,560,'ä»•æ§˜ãƒ¡ãƒ¢ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰', {fontSize:14});
      this.add.text(60,590,'- 3ç¨®é¡ã‚¨ãƒŠã‚¸ãƒ¼: é‡‘éŠ­/åŠ´åƒåŠ›/æ™‚é–“', {fontSize:12});
      this.add.text(60,610,'- 10ã‚¹ãƒ†ãƒ¼ã‚¸ ãƒãƒƒãƒ—ç”Ÿæˆ -> é¸æŠ -> ã‚¤ãƒ™ãƒ³ãƒˆ/æ•µ/ä¼‘æ†©ç­‰', {fontSize:12});
    }
  }
}

/* MapScene */
class MapScene extends Phaser.Scene {
  //*
  constructor(){ super({key:'MapScene'}); }
  create(){
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    //RUN.showEffectBtn(this);
    this.cameras.main.setBackgroundColor('#121212');
    this.add.text(30,100,'ãƒãƒƒãƒ—', {fontSize:28});
    // If map not generated, generate
    if(RUN.map.length===0) this.generateMap();
    this.drawMap();
    if(debugMode) this.drawDebugMap();
  }

  generateMap(){
    // 10 stages: index 1..10 (we store 0..9)
    const nodes = [];
    for(let i=0;i<10;i++){
      let kind = 'enemy';
      let confirmed = false;
      if(i===0) kind='enemy', confirmed=true;
      else if(i===4) kind='chest', confirmed=true;
      //else if(i===9) kind='boss', confirmed=true;
      else if(i===9) kind='chest', confirmed=true;
      else kind = 'unknown';
      nodes.push({index:i+1, kind:kind, chosen:false, confirmed: confirmed});
    }
    RUN.map = nodes;
    RUN.debugMap[0] = {index:0, kind:'enemy', chosen:false, confirmed:true};
    RUN.debugMap[1] = {index:0, kind:'elite', chosen:false, confirmed:true};
    RUN.debugMap[2] = {index:0, kind:'rest', chosen:false, confirmed:true};
    RUN.debugMap[3] = {index:0, kind:'chest', chosen:false, confirmed:true};
    RUN.debugMap[4] = {index:0, kind:'shop', chosen:false, confirmed:true};
    RUN.debugMap[5] = {index:0, kind:'event', chosen:false, confirmed:true};
    RUN.debugMap[6] = {index:0, kind:'boss', chosen:false, confirmed:true};
    //return nodes;
  }
  drawMap(){
    const baseX = 100;
    const baseY = 200;
    const gap = 90;
    // show nodes in a row; if too many, allow paging (simple)
    const viewStart = 0;
    for(let i=0;i<RUN.map.length;i++){
      const node = RUN.map[i];
      const x = baseX + i*gap;
      if(i != RUN.stageIndex){
        const y = baseY;
        const rect = this.add.rectangle(x, y, 80, 80, node.chosen?0x4444ff:0x333333).setStrokeStyle(2, 0xffffff);
        const t = this.add.text(x, y-8, `${node.index}`, {fontSize:16}).setOrigin(0.5);
        //const k = this.add.text(x, y+12, `${node.kind}`, {fontSize:12}).setOrigin(0.5);
      } else {
        let selectable;
        if(node.confirmed){
          selectable = 1;
        }else{
          selectable = RUN.mapOptions;
        }
        for(let j=0;j<selectable;j++){
          const y = baseY + j*gap;
          const rect = this.add.rectangle(x, y, 80, 80, node.chosen?0x4444ff:0x333333).setStrokeStyle(2, 0xffffff).setInteractive();
          const t = this.add.text(x, y-8, `${node.index}`, {fontSize:16}).setOrigin(0.5);
          let kind = node.kind;
          //let kind = node.kind;
          if(node.kind == 'unknown'){
            kind = ['rest','event'][j];
            /*
            if(i>=5) {
              // 6-9 random from elite, rest, chest, shop, event
              kind = Util.randChoice(['elite','rest','chest','shop','event']);
            } else {
              kind = Util.randChoice(['enemy','rest','chest','shop','event']);
            }  
            //*/
          }
          //const k = this.add.text(x, y+12, `${node.kind}`, {fontSize:12}).setOrigin(0.5);
          if(!node.confirmed) this.add.text(x, y+12, `${kind}`, {fontSize:12}).setOrigin(0.5);
          rect.on('pointerdown', ()=>{
            node.chosen = true;
            RUN.stageIndex = node.index;
            node.kind = kind;
            node.confirmed = true;
            // go to correct scene
            if(node.kind==='enemy') startBattle(this, false);
            else if(node.kind==='elite') startBattle(this, true);
            else if(node.kind==='boss') startBattle(this,'boss');
            else if(node.kind==='rest') this.scene.start('RestScene');
            else if(node.kind==='chest') this.scene.start('ChestScene');
            else if(node.kind==='shop') this.scene.start('ShopScene');
            else if(node.kind==='event') this.scene.start('EventScene');
          });
        }
      }
    }
    // legend
    this.add.text(900,50,'ä¼èª¬: æ•µ/ã‚¨ãƒªãƒ¼ãƒˆ/ãƒœã‚¹/ä¼‘æ†©/å®ç®±/ã‚·ãƒ§ãƒƒãƒ—/ã‚¤ãƒ™ãƒ³ãƒˆ', {fontSize:12});
    this.add.text(900,80,'é’ãŒé¸æŠæ¸ˆ', {fontSize:12}).setColor('#88f');
    // show remaining count
    const remaining = RUN.map.filter(n=>!n.chosen).length;
    this.add.text(900,110,`æ®‹ã‚Šã‚¹ãƒ†ãƒ¼ã‚¸: ${remaining}`, {fontSize:14});
  }
  drawDebugMap(){
    this.add.text(30,300,'ãƒ‡ãƒãƒƒã‚°ç”¨ãƒãƒƒãƒ—', {fontSize:28});
    const baseX = 100;
    const baseY = 400;
    const gap = 90;
    // show nodes in a row; if too many, allow paging (simple)
    for(let i=0;i<RUN.debugMap.length;i++){
      const node = RUN.debugMap[i];
      const x = baseX + i*gap;
      const y = baseY;
      const rect = this.add.rectangle(x, y, 80, 80, node.chosen?0x4444ff:0x333333).setStrokeStyle(2, 0xffffff).setInteractive();
      const t = this.add.text(x, y-8, `${node.index}`, {fontSize:16}).setOrigin(0.5);
      const k = this.add.text(x, y+12, `${node.kind}`, {fontSize:12}).setOrigin(0.5);
      rect.on('pointerdown', ()=>{
        //if(node.chosen) return; // already passed
        node.chosen = true;
        node.confirmed = true;
        // go to correct scene
        if(node.kind==='enemy') startBattle(this, false);
        else if(node.kind==='elite') startBattle(this, true);
        else if(node.kind==='boss') startBattle(this, 'boss');
        else if(node.kind==='rest') this.scene.start('RestScene');
        else if(node.kind==='chest') this.scene.start('ChestScene');
        else if(node.kind==='shop') this.scene.start('ShopScene');
        else if(node.kind==='event') this.scene.start('EventScene');
        });
    }
  }
}

/* BattleScene */
class BattleScene extends Phaser.Scene {
  constructor(){ super({key:'BattleScene'}); }
  init(data){
    this.elite = data.elite;
  }
  create(){
    RUN.showBtns(this,true,true,true,true,false);
    //RUN.showDeckViewBtn(this);
    //RUN.showDiscardpileViewBtn(this);
    //RUN.showDrawpileViewBtn(this);    
    this.turn = 'player';
    this.countTurn = 0;
    this.turnText = this.add.text(600,40,'Turn 1', {fontSize:18}).setOrigin(0.5);
    this.messageText = this.add.text(600,60,'', {fontSize:18}).setOrigin(0.5);
    // Display player info area
    this.playerInfo = this.add.text(30,30,this.formatPlayer(), {fontSize:16});
    // Enemy info
    if(debugMode) this.enemyInfo = this.add.text(880,30,this.formatEnemy(), {fontSize:16});
    if(RUN.automationFlag){
      this.delayApplyEffects();
      RUN.automationFlag = false;
    }
    // card area
    this.cardGroup = this.add.group();
    this.applyWaitsGroup = this.add.group();
    // utility buttons
    const endBtn = this.add.rectangle(600,630,140,50,0xff9933).setInteractive();
    this.add.text(600,630,'æ¬¡ã®ã‚¿ãƒ¼ãƒ³ã¸', {fontSize:18}).setOrigin(0.5);
    endBtn.on('pointerdown', ()=> this.endTurn());
    // draw and start
    this.startPlayerTurn();
  }

  formatPlayer(){
    const p = RUN.player;
    //return `ãƒ—ãƒ¬ã‚¤ãƒ¤\nHP:${p.hp}\né˜²å¾¡:${p.defense}\näººæ‰‹:${p.energy}/${p.maxEnergy}\nè³‡é‡‘:${RUN.player.gold}`;
    return `ãƒ—ãƒ¬ã‚¤ãƒ¤\nHP:${p.hp}\näººæ‰‹:${p.energy}/${p.maxEnergy}\nè³‡é‡‘:${RUN.player.gold}`;
  }
  formatEnemy(){
    const e = RUN.currentEnemy;
    return `æ•µ: ${e.name}\nHP:${e.hp} DEF:${e.def}\næ¬¡: ${e.intent} ${e.intentValue}`;
  }

  startPlayerTurn(){
    this.turn='player';
    this.turnText.setText(`Turn ${++this.countTurn}`);
    this.messageText.setText('ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³');
    if(this.countTurn != 1){
      if(this.incidentFlag){
        this.happenIncident();
      }else{
        this.eventFlag = Util.randChoice([false,false,false,'c','a']);
        if(this.eventFlag == 'a'){
          this.happenAccident();
        }else if (this.eventFlag == 'c'){
          this.happenCustomerOrder();
        }
      }
    }
    // reset player defense to 0 per spec
    //RUN.player.defense = 0;
    // recover energy to max
    /*
    // delay apply effect
    this.delayApplyEffects();
    */
    // draw 5 cards
    this.hand = [];
    for(let i=this.hand.length;i<RUN.player.drawcards;i++) this.drawCard();
    this.renderHand();
    this.updateInfo();
    this.renderApplyWaits();
  }

  drawCard(){
    if(RUN.player.drawPile.length===0){
      // shuffle discard into draw if available
      RUN.player.drawPile = Util.shuffle(RUN.player.discard.slice());
      RUN.player.discard = [];
    }
    if(RUN.player.drawPile.length===0) return; // no cards
    const card = RUN.player.drawPile.pop();
    this.hand.push(card);
  }

  renderHand(){
    // clear previous
    this.cardGroup.clear(true,true);
    const startX = 200;
    const y = 480;
    for(let i=0;i<this.hand.length;i++){
      const card = this.hand[i];
      const x = startX + i*200;
      const re = RUN.renderCard(this, x, y, 180, 260, card);
      const box = re.cardBg;
      this.cardGroup.addMultiple([box,re.nameText,re.costText,re.effectText]);
      box.setInteractive();
      box.on('pointerdown', ()=> this.playCard(card, i));
    }
  }

  playCard(card, index){
    // check cost
    const p = RUN.player;
    //if((e.money < (card.cost.money||0)) || (e.labor < (card.cost.labor||0)) || (e.time < (card.cost.time||0))){
    if((p.gold < (card.cost.money||0)) || (p.energy < card.cost.labor || 0) ){
      this.messageText.setText('ã‚³ã‚¹ãƒˆä¸è¶³ã§ä½¿ç”¨ã§ãã¾ã›ã‚“');
      return;
    }
    // pay cost
    p.energy -= card.cost.labor;
    p.gold -= card.cost.money;
    /*
    e.money -= (card.cost.money||0);
    e.labor -= (card.cost.labor||0);
    e.time -= (card.cost.time||0);
    */
    // delay apply effect
    RUN.player.applyEffectWaiting.push({leftTime: card.cost.time, card: card});
    /*
    if(card.cost.time > 0){
      RUN.player.applyEffectWaiting.push({leftTime: card.cost.time, card: card});
    }else{
      p.energy += card.cost.labor;
      this.applyEffect(card);
    }
    */
    // move card to discard
    RUN.player.discard.push(card);
    // remove from hand
    this.hand.splice(index,1);
    this.renderHand();
    this.updateInfo();
    this.renderApplyWaits();

    // check enemy death
    if(RUN.currentEnemy.hp <= 0){
      this.onEnemyDefeated();
    }
  }

  endTurn(){
    // delay apply effect
    this.delayApplyEffects();
    this.renderApplyWaits();
    // discard all hand
    for(const c of this.hand){
      if(c.must){
        this.messageText.setText('å¯¾å¿œã™ã¹ãäº‹æŸ„ãŒå¯¾å‡¦ã•ã‚Œãªã‹ã£ãŸ\nä¿¡é ¼æå¤±ï¼ˆ-20ï¼‰');
      }
      if(c.instant != true){
        RUN.player.discard.push(c);
      }
    } 
    this.hand = [];
    this.renderHand();
    this.updateInfo();
    // enemy turn
    // this.scene.pause();
    this.enemyTurn();
  }

  enemyTurn(){
    const e = RUN.currentEnemy;
    // reset enemy defense to 0
    e.def = Math.max(0, e.def);
    // apply intent
    if(debugMode) this.messageText.setText(`æ•µã®ã‚¿ãƒ¼ãƒ³: ${e.name} ãŒ ${e.intent} ã‚’å®Ÿè¡Œ`);
    if(e.intent === 'attack' && e.hp > 0){
      let dmg = e.intentValue;
      // check player defense
      if(dmg <= RUN.player.defense){
        RUN.player.defense -= dmg;
      } else {
        const over = dmg - RUN.player.defense;
        RUN.player.defense = 0;
        RUN.player.hiddenHp -= over;
      }
    }
    // simulate enemy taking any DOT? (simplified) -> we'll deduct small decay
    /*
    if(e.tags.includes('recon')){
      // recon applies weak DOT to itself: simulate "time" reduces attacker persistence
      e.hp -= 2;
    }
    //*/
    // compute next intent (random small)
    e.intentValue = Math.max(3, e.intentValue + Util.randChoice([-2,0,1]));
    if(e.hp >= 0){
      e.intent = Util.randChoice(['attack','attack','attack','weaken']); // bias attack
    }else{
      e.intent = 'nothing';
    }
    // if next is weaken, intentValue reduces player's max energy next turn? We'll show as hint
    e.intentDisplay = e.intent;
    // check player death
    if(RUN.player.hp <= 0){
      this.scene.start('GameOverScene');
      return;
    }
    if(RUN.player.hiddenHp <= 0){
      this.incidentFlag = true;
      RUN.player.hiddenHp = RUN.player.maxHiddenHp;
    }
    // after enemy turn, show updated info, delay and resume player
    if(debugMode) this.enemyInfo.setText(this.formatEnemy());
    this.playerInfo.setText(this.formatPlayer());
    this.time.delayedCall(1000, ()=> {
      // proceed to next player turn
      this.scene.resume();
      // if enemy still alive, start player turn
      /*
      if(RUN.currentEnemy.hp>0) this.startPlayerTurn();
      else this.onEnemyDefeated();
      */
      if(this.countTurn > 3) this.onEnemyDefeated();
      else this.startPlayerTurn();
    });
  }

  updateInfo(){
    this.playerInfo.setText(this.formatPlayer());
    if(debugMode) this.enemyInfo.setText(this.formatEnemy());
  }

  onEnemyDefeated(){
    // reward for non-boss
    const isBoss = (this.elite === 'boss');
    if(isBoss){
      // victory -> go to GameOver as win
      RUN.playTime = (Date.now() - RUN.startTimestamp)/1000;
      this.scene.start('GameOverScene', {victory:true});
      return;
    }
    /*
    // grant gold: simple formula
    const gained = Math.floor(10 + (this.elite?10:0) + Math.random()*10);
    RUN.player.gold += gained;
    */
    // put remaining discard/draw into RUN.player.discard
    RUN.player.discard = RUN.player.discard.concat(this.hand || []);
    // clear currentEnemy
    delete RUN.currentEnemy;
    // go to reward scene
    //this.scene.start('RewardScene', {gold:gained});
    this.scene.start('RewardScene');
  }

  delayApplyEffects(){
    for(let i=0; i<RUN.player.applyEffectWaiting.length; i++){
      const duel = RUN.player.applyEffectWaiting[i];
      if(duel.leftTime <= 0){
        if(duel.card.must != true){
          this.applyEffect(duel.card);
        }
        /*
        else if(dual.card.id == 'incident'){
        }else if(dual.card.id == 'accident'){
        }else if(dual.card.id == 'customer'){         
        }
        */
        RUN.player.energy += duel.card.cost.labor;
        RUN.player.applyEffectWaiting.splice(i, 1);
        i--;
      }
      duel.leftTime--;
    }
  }
  applyEffect(card){
    const find = RUN.player.applyEffect.find(e => e.id === card.id)
    if(find === undefined){
      RUN.player.applyEffect.push({id: card.id, card: card, stack: 1});
    }else{
      find.stack++;;
    }

    // apply effects (simplified)
    // defense
    if(card.defense){
      let defGain = card.defense;
      // relic synergy: network_expert doubles network synergy defense
      if(card.synergy === 'network' && RUN.relicIds.has('network_expert')) defGain = Math.floor(defGain*1.5);
      RUN.player.defense += defGain;
    }
    // damage to enemy
    if(card.damageToVuln){
      // check enemy def first
      let dmg = card.damageToVuln;
      // if enemy has defense reduce
      const eDef = RUN.currentEnemy.def;
      if(dmg <= eDef){
        // reduce enemy def
        RUN.currentEnemy.def -= dmg;
      } else {
        const over = dmg - RUN.currentEnemy.def;
        RUN.currentEnemy.def = 0;
        RUN.currentEnemy.hp -= over;
      }
    }
    // heal
    if(card.heal){
      RUN.player.hp = RUN.player.hp + card.heal;
    }
    // draw
    if(card.draw){
      for(let i=0;i<card.draw;i++) this.drawCard();
    }
    // buff enemy or debuff
    if(card.debuffEnemy){
      RUN.currentEnemy.def = Math.max(0, RUN.currentEnemy.def - card.debuffEnemy);
    }
    if(card.buffDefense){
      RUN.player.defense += card.buffDefense;
    }
  }
  renderApplyWaits(){
    // clear previous
    const applyWaits = RUN.player.applyEffectWaiting;
    this.applyWaitsGroup.clear(true,true);
    const mid = 600, edge = 100;
    const startX = mid - (applyWaits.length-1) * edge/2;
    const y = 200;
    for(let i=0;i<applyWaits.length;i++){
      const leftTime = applyWaits[i].leftTime;
      const card = applyWaits[i].card;
      const x = startX + i* 100;

      let timeText;
      if(leftTime>0){
        timeText = this.add.text(x, y-70, `é©å¿œã¾ã§æ®‹ã‚Š\n${leftTime}ã‚¿ãƒ¼ãƒ³`, {
          fontSize: "12px",
          color: "#ffffff",
          align: "center",
        }).setOrigin(0.5);  
      }else{
        timeText = this.add.text(x, y-70, `ã“ã®ã‚¿ãƒ¼ãƒ³\né©ç”¨`, {
          fontSize: "12px",
          color: "#ffffff",
          align: "center",
        }).setOrigin(0.5);  
      }
      
      const waitBg = this.add.rectangle(x, y, edge, edge, 0x333333).setOrigin(0.5);
      waitBg.setStrokeStyle(2, 0xffffff);

      // ã‚«ãƒ¼ãƒ‰å
      const nameText = this.add.text(x, y - 20, card.name, {
        fontSize: "10px",
        color: "#ffffff",
        align: "center",
        wordWrap: { width: 90 }
      }).setOrigin(0.5);
      // ã‚³ã‚¹ãƒˆè¡¨ç¤º
      const costText = this.add.text(x, y, `ğŸ’°${card.cost.money} ğŸ‘¥${card.cost.labor} â±${card.cost.time}`, {
        fontSize: "8px",
        color: "#ffcc00",
        align: "center"
      }).setOrigin(0.5);
      // åŠ¹æœèª¬æ˜
      const effectText = this.add.text(x, y + 20, `${card.text}`, {
        fontSize: "8px",
        color: "#00ff00",
        align: "center"
      }).setOrigin(0.5);
      //const body = this.add.text(x,y-20,card.text,{fontSize:12,wordWrap:{width:160}}).setOrigin(0.5);

      //const re = RUN.renderCard(this, x, y, 180, 260, card);
      this.applyWaitsGroup.addMultiple([timeText,waitBg,nameText,costText,effectText]);
      //box.setInteractive();
      //box.on('pointerdown', ()=> this.playCard(card, i));
    }
  }
  happenIncident(){
    this.messageText.setText('ã‚¤ãƒ³ã‚·ãƒ‡ãƒ³ãƒˆãŒç™ºç”Ÿï¼ç¤¾ä¼šçš„ä¿¡é ¼ãŒä½ä¸‹(HP-40)\nå¯¾å¿œãŒæ±‚ã‚ã‚‰ã‚Œã‚‹');
    RUN.player.hp -= 40;
    RUN.player.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[0])));
  }
  happenAccident(){
    this.messageText.setText('éšœå®³ãŒç™ºç”Ÿï¼ç¤¾ä¼šçš„ä¿¡é ¼ãŒä½ä¸‹(HP-20)\nå¯¾å¿œãŒæ±‚ã‚ã‚‰ã‚Œã‚‹');
    RUN.player.hp -= 20;
    RUN.player.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[1])));
  }
  happenCustomerOrder(){
    this.messageText.setText('é¡§å®¢ã‹ã‚‰ã®ã‚ªãƒ¼ãƒ€ãƒ¼ãŒç™ºç”Ÿ\nå¯¾å¿œãŒæ±‚ã‚ã‚‰ã‚Œã‚‹');
    RUN.player.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[3])));    
  }
}

/* RewardScene */
class RewardScene extends Phaser.Scene {
  constructor(){ super({key:'RewardScene'}); }
  init(data){ this.gained = data.gold || 0; }
  create(){
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.selectCardGroup = this.add.group();
    this.selectCardGroup.clear(true,true);
    this.add.text(600,80,'æ¥­å‹™é‚è¡Œï¼\n ç²å¾—ã™ã‚‹æŠ€è¡“ã‚„æ©Ÿèƒ½', {fontSize:26}).setOrigin(0.5);
    //this.add.text(600,120,`äºˆç®— +${this.gained}`, {fontSize:18}).setOrigin(0.5);
    // show 3 random cards to choose from
    const choices = Util.shuffle(CARD_TEMPLATES).slice(0,3).map(c => JSON.parse(JSON.stringify(c)));
    const selectCardText = this.add.text(450,200,'ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãƒ‡ãƒƒã‚­ã«è¿½åŠ ', {fontSize:18});
    this.selectCardGroup.add(selectCardText)
    for(let i=0;i<choices.length;i++){
      const c = choices[i];
      const x = 300 + i*300;
      const card = RUN.renderCard(this, x, 350, 240, 140, c);
      const box = card.cardBg;
      this.selectCardGroup.addMultiple([box,card.nameText,card.costText,card.effectText]);
      box.setInteractive();
      box.on('pointerdown', ()=>{
        RUN.player.deck.push(c);
        //this.finishRewards();
        this.selectRelics();
      });
    }
    // skip button
    /*
    const skip = this.add.rectangle(600,520,160,50,0x666666).setInteractive();
    const skipText = this.add.text(600,520,'ã‚¹ã‚­ãƒƒãƒ—', {fontSize:18}).setOrigin(0.5);
    */
    const skip = this.add.rectangle(600,560,160,50,0x666666).setInteractive();
    const skipText = this.add.text(600,560,'ã‚¹ã‚­ãƒƒãƒ—', {fontSize:18}).setOrigin(0.5);
    skip.on('pointerdown', ()=> this.selectRelics());
    this.selectCardGroup.addMultiple([skip,skipText]);
  }

  selectRelics(){
    this.selectCardGroup.clear(true,true);
    // Next: relic selection (unowned)
    this.relicChoices = Util.shuffle(RELIC_TEMPLATES.filter(r=>!RUN.relicIds.has(r.id))).slice(0,3);
    this.relicTexts = [];
    this.add.text(450,200,'æ¥­å‹™ã«å½¹ç«‹ã¤ã‚‚ã®ã‚’1ã¤é¸æŠï¼ˆã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰', {fontSize:18});
    for(let i=0;i<this.relicChoices.length;i++){
      const r = this.relicChoices[i];
      const x = 300 + i*300;
      const box = this.add.rectangle(x,360,240,120,0x222222).setStrokeStyle(2,0xffffff).setInteractive();
      this.add.text(x-100,340,r.name,{fontSize:14}).setOrigin(0);
      this.add.text(x,360,r.desc,{fontSize:12,wordWrap:{width:200}}).setOrigin(0.5);
      box.on('pointerdown', ()=> {
        RUN.applyRelic(r);
        this.finishRewards();
      });
    }
    // skip relic
    /*
    const skipRel = this.add.rectangle(600,620,160,40,0x444444).setInteractive();
    this.add.text(600,620,'ãƒ¬ãƒªãƒƒã‚¯ã‚’å–ã‚‰ãªã„', {fontSize:14}).setOrigin(0.5);
    */
    const skipRel = this.add.rectangle(600,560,160,40,0x444444).setInteractive();
    this.add.text(600,560,'ã‚¹ã‚­ãƒƒãƒ—', {fontSize:14}).setOrigin(0.5);
    skipRel.on('pointerdown', ()=> this.finishRewards());
  }

  finishRewards(){
    this.scene.start('MapScene');
  }
}

/* ChestScene */
class ChestScene extends Phaser.Scene {
  constructor(){ super({key:'ChestScene'}); }
  create(){
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.add.text(600,80,'ç‰¹åˆ¥æ‰‹å½“ï¼', {fontSize:28}).setOrigin(0.5);
    const goldGain = Math.floor(10 + Math.random()*30);
    RUN.player.gold += goldGain;
    this.add.text(600,120,`è³‡é‡‘ +${goldGain}`, {fontSize:18}).setOrigin(0.5);
    // relics choices
    const relics = Util.shuffle(RELIC_TEMPLATES.filter(r=>!RUN.relicIds.has(r.id))).slice(0,3);
    this.add.text(450,200,'æ¥­å‹™ã«å½¹ç«‹ã¤ã‚‚ã®ã‚’1ã¤é¸æŠï¼ˆã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰', {fontSize:18});
    for(let i=0;i<relics.length;i++){
      const r = relics[i];
      const x = 300 + i*300;
      const box = this.add.rectangle(x,360,240,140,0x222222).setStrokeStyle(2,0xffffff).setInteractive();
      this.add.text(x-100,360,r.name,{fontSize:14}).setOrigin(0);
      this.add.text(x,340,r.desc,{fontSize:12,wordWrap:{width:200}}).setOrigin(0.5);
      box.on('pointerdown', ()=> {
        RUN.applyRelic(r);
        this.scene.start('MapScene');
      });
    }
    const skip = this.add.rectangle(600,560,160,40,0x666666).setInteractive();
    this.add.text(600,560,'ã‚¹ã‚­ãƒƒãƒ—', {fontSize:16}).setOrigin(0.5);
    //skip.on('pointerdown', ()=> this.scene.start('MapScene'));
    skip.on('pointerdown', ()=> this.scene.start('ShopScene'));
  }
}

/* RestScene */
class RestScene extends Phaser.Scene {
  constructor(){ super({key:'RestScene'}); }
  create(){    
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.add.text(600,120,'ä¼‘æ†©', {fontSize:28}).setOrigin(0.5);
    // three choices: rest(heal), upgrade(random card), skip
    const restBtn = this.add.rectangle(300,320,240,100,0x77cc77).setInteractive();
    this.add.text(300,320,'ä¼‘æ¯: ä½“åŠ›å›å¾©', {fontSize:18}).setOrigin(0.5);
    restBtn.on('pointerdown', ()=> {
      RUN.player.hp = RUN.player.hp + 20;
      this.endRestScene();
    });

    const upgradeBtn = this.add.rectangle(600,320,240,100,0x7799ff).setInteractive();
    this.add.text(600,320,'æ”¹è‰¯: ãƒ‡ãƒƒã‚­ã®æ–½ç­–å¼·åŒ–', {fontSize:18}).setOrigin(0.5);
    upgradeBtn.on('pointerdown', ()=> {
      if(RUN.player.deck.length===0) { this.scene.start('MapScene'); return; }
      const toUpgrade = Util.randChoice(RUN.player.deck);
      // simple upgrade: increase defense/heal/damage by 50%
      if(toUpgrade.defense) toUpgrade.defense = Math.ceil(toUpgrade.defense*1.5);
      if(toUpgrade.heal) toUpgrade.heal = Math.ceil(toUpgrade.heal*1.5);
      if(toUpgrade.damageToVuln) toUpgrade.damageToVuln = Math.ceil(toUpgrade.damageToVuln*1.5);
      toUpgrade.name = toUpgrade.name+"+";
      this.add.text(600,430,`æ”¹è‰¯ï¼š ${toUpgrade.name} ã‚’å¾—ãŸ`, {fontSize:14});
      this.time.delayedCall(1000, ()=> this.endRestScene());
    });

    const skipBtn = this.add.rectangle(900,320,240,100,0x666666).setInteractive();
    this.add.text(900,320,'ã‚¹ã‚­ãƒƒãƒ—', {fontSize:18}).setOrigin(0.5);
    //skipBtn.on('pointerdown', ()=> this.scene.start('MapScene'));
    skipBtn.on('pointerdown', ()=> this.endRestScene());
  }
  endRestScene(){
    this.scene.start('ShopScene');
  }
}

/* ShopScene */
class ShopScene extends Phaser.Scene {
  constructor(){ super({key:'ShopScene'}); }
  create(){
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.add.text(600,80,'ã‚·ãƒ§ãƒƒãƒ—', {fontSize:28}).setOrigin(0.5);
    RUN.player.gold += RUN.budget;
    //RUN.showPlayerStatus(this);
    //this.goldText = this.add.text(80,120,`è³‡é‡‘: ${RUN.player.gold} (äºˆç®—ç²å¾—: +${RUN.budget})`, {fontSize:18});
    this.goldText = RUN.showPlayerStatusChangeMT(this, `è³‡é‡‘: ${RUN.player.gold} (äºˆç®—ç²å¾—: +${RUN.budget})`).moneyText;
    // items: 5 random cards, 3 relics, delete card option(1)
    const cardOffers = Util.shuffle(CARD_TEMPLATES).slice(0,5).map(c=>({card:JSON.parse(JSON.stringify(c)), price: Math.floor(5 + Math.random()*8)}));
    //const cardOffers = Util.shuffle(CARD_TEMPLATES).slice(0,5);
    for(let i=0;i<cardOffers.length;i++){
      const o = cardOffers[i];
      const x = 120 + i*200;
      //const box = RUN.renderCard(this, x, 260, 180, 140, o).cardBg;
      const box = RUN.renderCard(this, x, 260, 180, 140, o.card).cardBg;
      //this.add.text(x+70,230,`Â¥${o.price}`,{fontSize:12}).setOrigin(1,0);
      this.add.text(x,340,`Â¥${o.price}`,{fontSize:12}).setOrigin(1,0);
      box.setInteractive();
      box.on('pointerdown', ()=>{
        if(RUN.player.gold < o.price) return;
        RUN.player.gold -= o.price;
        this.goldText.setText(`è³‡é‡‘: ${RUN.player.gold}`, {fontSize:18});
        RUN.player.deck.push(o.card);
        box.fillColor = 0x444444;
      });
    }
    // relic offers
    const relicOffers = Util.shuffle(RELIC_TEMPLATES.filter(r=>!RUN.relicIds.has(r.id))).slice(0,3);
    for(let i=0;i<relicOffers.length;i++){
      const r = relicOffers[i];
      const x = 200 + i*300;
      const box = this.add.rectangle(x,460,240,120,0x222222).setStrokeStyle(2,0xffffff).setInteractive();
      const price = 15;
      this.add.text(x-100,432,r.name,{fontSize:14}).setOrigin(0);
      this.add.text(x+100,432,`Â¥${price}`,{fontSize:12}).setOrigin(1,0);
      this.add.text(x,460,r.desc,{fontSize:12,wordWrap:{width:200}}).setOrigin(0.5);
      box.on('pointerdown', ()=>{
        if(RUN.player.gold < price) return;
        RUN.player.gold -= price;
        this.goldText.setText(`è³‡é‡‘: ${RUN.player.gold}`, {fontSize:18});
        RUN.applyRelic(r);
        box.fillColor = 0x444444;
      });
    }
    // delete card option (one-time)
    const delBox = this.add.rectangle(900,560,240,120,0xaa4444).setStrokeStyle(2,0xffffff).setInteractive();
    this.add.text(900,540,'ã‚«ãƒ¼ãƒ‰å‰Šé™¤ (Â¥20)', {fontSize:14}).setOrigin(0.5);
    delBox.on('pointerdown', ()=>{
      if(RUN.player.gold < 20) return;
      if(RUN.player.deck.length<=1) return;
      RUN.player.gold -= 20;
      this.goldText.setText(`è³‡é‡‘: ${RUN.player.gold}`, {fontSize:18});
      // remove a random non-basic card (try to remove strongest)
      RUN.player.deck.sort((a,b)=> (b.defense||0 + b.damageToVuln||0) - (a.defense||0 + a.damageToVuln||0));
      RUN.player.deck.pop();
      this.add.text(900,620,'ã‚«ãƒ¼ãƒ‰ã‚’1æšå‰Šé™¤ã—ã¾ã—ãŸ', {fontSize:12}).setOrigin(0.5);
    });

    const leave = this.add.rectangle(600,680,160,40,0x666666).setInteractive();
    this.add.text(600,680,'åº—ã‚’å‡ºã‚‹', {fontSize:16}).setOrigin(0.5);
    //leave.on('pointerdown', ()=> this.startBattle());
    leave.on('pointerdown', ()=> startBattle(this));
  }
  /*
  startBattle(){
    if(RUN.stageIndex < 5){
      this.startBattle(false);
    }else if(RUN.stageIndex == 9){
      this.startBattle('boss');
    }else{
      this.startBattle(true);
    }
  }
  startBattle(eliteFlag){
    // prepare enemy from templates based on type & stage
    let enemy;
    if(eliteFlag==='boss') enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.boss)));
    else if(eliteFlag===true) enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.elite)));
    else enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.normal)));
    // store battle state in RUN
    RUN.currentEnemy = {
      ...enemy,
      hp: enemy.hp,
      def: enemy.def,
      intent: enemy.intent,
      intentValue: enemy.intentValue,
      tags: enemy.tags || []
    };
    // prepare player draw pile if empty
    if(RUN.player.drawPile.length===0) RUN.player.drawPile = Util.shuffle(RUN.player.deck.slice());
    // reset temporary player values
    RUN.player.defense = 0;
    //RUN.player.energy = RUN.player.maxEnergy;
    RUN.player.status = {}; // status effects
    this.scene.start('BattleScene', {elite: eliteFlag});
  }
  //*/

}

/* EventScene */
class EventScene extends Phaser.Scene {
  constructor(){ super({key:'EventScene'}); }
  create(){
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.add.text(600,80,'ã‚¤ãƒ™ãƒ³ãƒˆ', {fontSize:28}).setOrigin(0.5);
    let ev;
    //const ev = Util.randChoice(events);
    if(debugMode){
      //ev = Util.randChoice(EVENT_TEMPLATES);
      ev = EVENT_TEMPLATES[debugIndex++];
    }else{
      ev = Util.randChoice(EVENT_TEMPLATES);
    }
    this.add.text(600,140,ev.title, {fontSize:20}).setOrigin(0.5);
    this.add.text(600,160,ev.text, {fontSize:18}).setOrigin(0.5);
    /*
    if(ev.id==='insider'){
      // start battle immediately with an enemy
      RUN.currentEnemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.normal)));
      RUN.currentEnemy.hp = RUN.currentEnemy.hp;
      this.time.delayedCall(1200, ()=> this.scene.start('BattleScene', {elite:false}));
      return;
    } else {
      ev.effect();
      const skip = this.add.rectangle(600,560,160,40,0x666666).setInteractive();
      this.add.text(600,560,'æ¬¡ã¸', {fontSize:16}).setOrigin(0.5);
      skip.on('pointerdown', ()=> this.scene.start('MapScene'));
      //this.time.delayedCall(1200, ()=> this.scene.start('MapScene'));
    }
    */
    const choiceBtns = [];
    let startY = 300;
    //const choice = this.add.text(600,startY+20,`${ev.choices.length}`, {fontSize:18}).setOrigin(0.5);
    //RUN.showBtn(this, 600, startY+80, "a", 0xffffff);
    for(let i=0; i<ev.choices.length; i++){
      //const choiceBlk = this.add.rectangle();
      //const choice = this.add.text(600,startY+i*20,ev.choices[i].option, {fontSize:18}).setOrigin(0.5);
      const Btn = RUN.showBtn(this, 600, startY+i*100, ev.choices[i].option, 0x666666, 400,40);
      //const Btn = RUN.showBtn(this, 600, startY+i*20, "a", 0xffffff);
      Btn.btn.on('pointerdown', ()=> { this.applyEvent(ev.choices[i].effect()); this.destroyBtns(choiceBtns); this.endScene(); });
      choiceBtns.push(Btn);
    }
    //close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
  }
  applyEvent(ret){
    if(ret.card != null){
      RUN.player.applyEffectWaiting.push({leftTime: ret.card.cost.time, card: ret.card});
    }
    if(ret.labor != null){
      if(ret.labor > 0){
        if(ret.time == null){
          RUN.player.energy += ret.labor;
        }
        RUN.player.maxEnergy += ret.labor;     
      }else{
        if(ret.time == null){
          RUN.player.maxEnergy += ret.labor;
        }
        RUN.player.energy += ret.labor;
      }
    }
    if(ret.money != null){
      RUN.player.gold += ret.money*5;
    }
    if(ret.budget != null){
      RUN.budget += ret.budget*5;
    }
    if(ret.trust != null){
      RUN.player.hp +=ret.trust*5;
    }
  }
  destroyBtns(Btns){
    for(let i=0; i<Btns.length; i++){
      Btns[i].btn.destroy();
      Btns[i].txt.destroy();
    }
  }
  endScene(){    
    const skip = this.add.rectangle(600,560,160,40,0x666666).setInteractive();
    this.add.text(600,560,'æ¬¡ã¸', {fontSize:16}).setOrigin(0.5);
    if(debugMode){
      if(debugIndex == EVENT_TEMPLATES.length){
        skip.on('pointerdown', ()=> this.scene.start('ShopScene'));
      }else{
        skip.on('pointerdown', ()=> this.scene.start('EventScene'));
      }
    }else{
      skip.on('pointerdown', ()=> this.scene.start('ShopScene'));
    }
  }
}

/* GameOverScene */
class GameOverScene extends Phaser.Scene {
  constructor(){ super({key:'GameOverScene'}); }
  init(data){ this.victory = data && data.victory; }
  create(){
    this.add.text(600,120, this.victory ? 'æ¥­å‹™ç¶™ç¶šæˆåŠŸï¼' : 'ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼', {fontSize:34}).setOrigin(0.5);
    this.add.text(600,180,`ãƒ—ãƒ¬ã‚¤æ™‚é–“: ${Math.floor((Date.now()-RUN.startTimestamp)/1000)}ç§’`, {fontSize:16}).setOrigin(0.5);
    this.add.text(600,220,`æœ€çµ‚è³‡é‡‘: ${RUN.player.gold}`, {fontSize:16}).setOrigin(0.5);
    this.add.text(600,260,`ãƒ‡ãƒƒã‚­: ${RUN.player.deck.map(c=>c.name).join(', ')}`, {fontSize:12}).setOrigin(0.5);
    this.add.text(600,300,`ã‚µãƒãƒ¼ãƒˆ: ${RUN.player.relics.map(r=>r.name).join(', ')}`, {fontSize:12}).setOrigin(0.5);
    const nextBtn = this.add.rectangle(600,500,220,60,0x2d8cff).setInteractive();
    this.add.text(600,500,'ã‚¿ã‚¤ãƒˆãƒ«ã«æˆ»ã‚‹', {fontSize:20}).setOrigin(0.5);
    nextBtn.on('pointerdown', ()=> this.scene.start('OpeningScene'));
  }
}

/* ---------- Register scenes and start ---------- */
config.scene = [OpeningScene, MapScene, BattleScene, RewardScene, ChestScene, RestScene, ShopScene, EventScene, GameOverScene];
const game = new Phaser.Game(config);

/* ---------- End of file ---------- */

</script>
</body>
</html>
