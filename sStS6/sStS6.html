<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>CSIRT: Card Defense (Prototype)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.60.0/phaser.min.js"></script>
<style>
  body { margin:0; background:#111; color:#eee; font-family: "Noto Sans JP", sans-serif; }
  #game-container { width:100%; height:100vh; overflow:hidden; }
  .small { font-size:12px; }
</style>
</head>
<body>
<div id="game-container"></div>

<script>
/*
  CSIRT Card Game - Phaser prototype
  - One-file Phaser 3 game implementing main flows from the spec.
  - Triple-energy system: gold (money), labor (people), time
  - Scenes: Opening, Map, Battle, Reward, Chest, Rest, Shop, Event, GameOver
  - Simplified UI using Phaser text & rectangles
*/

/* ---------- Utility ---------- */
const Util = {
  randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; },
  shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; },
  clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
};
const debugMode = true;
let debugIndex = 0;
//*
function startBattle(Scene){
  if(RUN.stageIndex < 5){
    startBattle(Scene, false);
  }else if(RUN.stageIndex == 9){
    startBattle(Scene, 'boss');
  }else{
    startBattle(Scene, true);
  }  
}
function startBattle(Scene, eliteFlag){
  // prepare enemy from templates based on type & stage
  let enemy;
  if(eliteFlag==='boss') enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.boss)));
  else if(eliteFlag===true) enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.elite)));
  else enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.normal)));
  // store battle state in RUN
  RUN.currentEnemy = {
    ...enemy,
    hp: enemy.hp,
    def: enemy.def,
    intent: enemy.intent,
    intentValue: enemy.intentValue,
    tags: enemy.tags || []
  };
  // prepare player draw pile if empty
  if(RUN.player.drawPile.length===0) RUN.player.drawPile = Util.shuffle(RUN.player.deck.slice());
  // reset temporary player values
  RUN.player.defense = 0;
  //RUN.player.energy = RUN.player.maxEnergy;
  RUN.player.status = {}; // status effects
  Scene.scene.start('BattleScene', {elite: eliteFlag});
}
//*/


/* ---------- Game Data Templates ---------- */

// Sample Cards (costs: money, labor, time)
const CARD_TEMPLATES = [
  /*
  { id:'fw', name:'Firewall Deployment', cost:{money:1,labor:1,time:0}, defense:8, text:'Èò≤Âæ°+8 (network)', synergy:'network' },
  { id:'patch', name:'Apply Patch', cost:{money:0,labor:1,time:1}, damageToVuln:12, text:'ËÑÜÂº±ÊÄßÊÇ™Áî®„ÇíÈòªÊ≠¢(„ÉÄ„É°„Éº„Ç∏12)', synergy:'vuln' },
  { id:'backup', name:'Offsite Backup', cost:{money:2,labor:0,time:1}, heal:10, text:'Ë≥áÁî£ÂõûÂæ©+10', synergy:'backup' },
  { id:'monitor', name:'IDS Monitoring', cost:{money:1,labor:0,time:1}, draw:1, text:'„Ç´„Éº„Éâ„Éâ„É≠„Éº1', synergy:'network' },
  { id:'train', name:'Employee Training', cost:{money:0,labor:2,time:0}, buffDefense:4, text:'Ê¨°„Çø„Éº„É≥Èò≤Âæ°+4 (human)', synergy:'human' },
  { id:'audit', name:'Security Audit', cost:{money:1,labor:1,time:1}, debuffEnemy:2, text:'ÊïµÈò≤Âæ°-2 (policy)', synergy:'policy' },
  */

  // ÊäÄË°ìÁöÑÂØæÁ≠ñ:19
  { id:'pw', name:'Âº∑Âõ∫„Å™„Éë„Çπ„ÉØ„Éº„ÉâÈÅãÁî®', cost:{money:0,labor:1,time:0}, defense:4, text:'„Éë„Çπ„ÉØ„Éº„ÉâÂº∑Âåñ„ÅßÊîªÊíÉ„ÇíÂõ∞Èõ£„Å´„Åô„Çã', synergy:'Ë≠òÂà•,‰∫∫ÁöÑÂØæÁ≠ñ' },
  { id:'encrypt', name:'„Éá„Éº„ÇøÊöóÂè∑Âåñ', cost:{money:2,labor:1,time:1}, defense:7, text:'ÊöóÂè∑Âåñ„ÅßÊÉÖÂ†±ÊºèÊ¥©„ÇíÈò≤„Åê', synergy:'„Éá„Éº„Çø,ÊäÄË°ìÁöÑÂØæÁ≠ñ' },
  { id:'fw', name:'„Éï„Ç°„Ç§„Ç¢„Ç¶„Ç©„Éº„É´Ë®≠ÁΩÆ', cost:{money:1,labor:1,time:0}, defense:8, text:'‰∏çÊ≠£„Ç¢„ÇØ„Çª„Çπ„ÇíÈò≤Âæ°', synergy:'„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ,Èò≤Âæ°' },
  { id:'accessctrl', name:'„Ç¢„ÇØ„Çª„ÇπÁÆ°ÁêÜ', cost:{money:1,labor:1,time:1}, defense:6, text:'Ê®©Èôê„ÇíÂà∂Âæ°„Åó„É™„Çπ„ÇØ„ÇíÊ∏õ„Çâ„Åô', synergy:'Ë≠òÂà•,ÊäÄË°ìÁöÑÂØæÁ≠ñ' },
  { id:'av', name:'„Ç¶„Ç§„É´„ÇπÂØæÁ≠ñ„ÇΩ„Éï„ÉàÂ∞éÂÖ•', cost:{money:1,labor:1,time:0}, defense:6, text:'„Éû„É´„Ç¶„Çß„Ç¢„ÇíÊ§úÁü•„Åó„Å¶Èò≤„Åê', synergy:'„Éá„Éê„Ç§„Çπ,Èò≤Âæ°' },
  { id:'ips', name:'IPSÂ∞éÂÖ•', cost:{money:2,labor:2,time:1}, defense:10, text:'‰æµÂÖ•„ÇíÊú™ÁÑ∂„Å´Èò≤Ê≠¢', synergy:'„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ,Ê§úÁü•' },
  { id:'ids', name:'IDSÂ∞éÂÖ•', cost:{money:1,labor:1,time:1}, draw:1, text:'‰æµÂÖ•„ÇíÊ§úÁü•„Åß„Åç„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã', synergy:'„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ,Ê§úÁü•' },
  { id:'tls', name:'ÈÄö‰ø°ÊöóÂè∑Âåñ(TLS)', cost:{money:1,labor:1,time:1}, defense:7, text:'ÁõóËÅ¥„ÇíÈò≤Ê≠¢„Åô„Çã', synergy:'„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ,‰øùË≠∑' }, //
  { id:'backup', name:'„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó', cost:{money:2,labor:0,time:1}, heal:10, text:'Âæ©Êóß„ÅÆ„Åü„ÇÅ„ÅÆ‰øùÈô∫', synergy:'Âæ©Êóß,„Éá„Éº„Çø' },
  { id:'logmon', name:'„É≠„Ç∞Áõ£Ë¶ñ', cost:{money:1,labor:1,time:1}, draw:1, text:'Áï∞Â∏∏„ÇíÊ§úÂá∫„Åô„Çã„Éí„É≥„Éà„ÇíÂæó„Çã', synergy:'Ê§úÁü•,ÈÅãÁî®' },
  { id:'patch', name:'„Éë„ÉÉ„ÉÅÈÅ©Áî®', cost:{money:0,labor:1,time:1}, defense:12, text:'ËÑÜÂº±ÊÄß„ÇíÂ°û„Åê', synergy:'Èò≤Âæ°,ÊäÄË°ìÁöÑÂØæÁ≠ñ' },
  { id:'2fa', name:'‰∫åÊÆµÈöéË™çË®ºÂ∞éÂÖ•', cost:{money:1,labor:1,time:1}, defense:8, text:'‰∏çÊ≠£„É≠„Ç∞„Ç§„É≥„ÇíÂõ∞Èõ£„Å´„Åô„Çã', synergy:'Ë≠òÂà•,Èò≤Âæ°' },
  { id:'sso', name:'SSOÂ∞éÂÖ•', cost:{money:2,labor:2,time:2}, defense:6, text:'Ë™çË®ºÁÆ°ÁêÜ„ÇíÂäπÁéáÂåñ', synergy:'Ë≠òÂà•,Áµ±Ê≤ª' }, //
  { id:'edr', name:'EDRÂ∞éÂÖ•', cost:{money:3,labor:2,time:2}, defense:12, text:'„Ç®„É≥„Éâ„Éù„Ç§„É≥„Éà„ÅÆËÑÖÂ®Å„ÇíÁõ£Ë¶ñ„ÉªÈò≤Âæ°', synergy:'„Éá„Éê„Ç§„Çπ,Ê§úÁü•' },
  { id:'ueba', name:'UEBA', cost:{money:3,labor:2,time:2}, debuffEnemy:3, text:'Áï∞Â∏∏Ë°åÂãï„ÇíÊ§úÁü•', synergy:'Ê§úÁü•,„É¶„Éº„Ç∂' }, //
  { id:'ndr', name:'NDRÂ∞éÂÖ•', cost:{money:3,labor:2,time:2}, defense:10, text:'„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÁï∞Â∏∏„ÇíÁõ£Ë¶ñ', synergy:'„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ,Ê§úÁü•' }, //
  { id:'cdn', name:'CDNÂ∞éÂÖ•', cost:{money:2,labor:1,time:2}, defense:6, text:'DDoS„Åã„Çâ„ÅÆËÄêÊÄß„ÇíÂº∑Âåñ', synergy:'„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ,Èò≤Âæ°' }, //
  { id:'dynana', name:'ÂãïÁöÑËß£Êûê„Çµ„Éº„Éì„Çπ', cost:{money:2,labor:1,time:1}, draw:1, text:'Êú™Áü•„ÅÆËÑÖÂ®Å„ÇíÊ§úÂá∫', synergy:'Ê§úÁü•,„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥' }, //
  { id:'staticana', name:'ÈùôÁöÑËß£Êûê„Çµ„Éº„Éì„Çπ', cost:{money:2,labor:1,time:1}, defense:6, text:'„ÇΩ„Éº„Çπ„Ç≥„Éº„Éâ„Åã„ÇâËÑÜÂº±ÊÄßÁô∫Ë¶ã', synergy:'Ê§úÁü•,„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥' }, //

  // Áâ©ÁêÜÁöÑÂØæÁ≠ñ
  { id:'lock', name:'„Ç™„Éï„Ç£„ÇπÊñΩÈå†', cost:{money:1,labor:1,time:0}, defense:5, text:'Áâ©ÁêÜÁöÑ‰æµÂÖ•„ÇíÈò≤„Åê', synergy:'Áâ©ÁêÜÁöÑÂØæÁ≠ñ,Èò≤Âæ°' },
  { id:'antitheft', name:'ÁõóÈõ£ÂØæÁ≠ñ', cost:{money:1,labor:1,time:1}, defense:5, text:'Ë≥áÁî£„ÇíÂÆà„Çã', synergy:'Áâ©ÁêÜÁöÑÂØæÁ≠ñ,‰øùË≠∑' },
  { id:'shred', name:'„Ç∑„É•„É¨„ÉÉ„ÉÄ„Éº', cost:{money:1,labor:0,time:0}, defense:4, text:'ÊÉÖÂ†±ÊºèÊ¥©„ÇíÁâ©ÁêÜÁöÑ„Å´Èò≤„Åê', synergy:'„Éá„Éº„Çø,Áâ©ÁêÜÁöÑÂØæÁ≠ñ' },
  { id:'destroy', name:'Áâ©ÁêÜÁöÑÁ†¥Â£ä', cost:{money:1,labor:1,time:0}, defense:8, text:'Ê©üÂØÜ„ÇíÁ¢∫ÂÆü„Å´Ê∂àÂéª', synergy:'Âæ©Êóß,Áâ©ÁêÜÁöÑÂØæÁ≠ñ' },

  // ÁµÑÁπîÁöÑÂØæÁ≠ñ
  { id:'policy', name:'„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Éù„É™„Ç∑„ÉºÊï¥ÂÇô', cost:{money:0,labor:2,time:2}, buffDefense:5, text:'„É´„Éº„É´„ÇíÁ≠ñÂÆö„Åó„Å¶ÈÅµÂÆà„Åï„Åõ„Çã', synergy:'Áµ±Ê≤ª,ÁµÑÁπîÁöÑÂØæÁ≠ñ' },
  { id:'team', name:'„Ç§„É≥„Ç∑„Éá„É≥„ÉàÂØæÂøú„ÉÅ„Éº„É†Ë®≠ÁΩÆ', cost:{money:2,labor:2,time:2}, heal:10, text:'Ë¢´ÂÆ≥„ÇíÊúÄÂ∞èÂåñ„Åô„Çã‰ΩìÂà∂', synergy:'ÂØæÂøú,ÁµÑÁπîÁöÑÂØæÁ≠ñ' },
  { id:'audit', name:'Áõ£Êüª', cost:{money:1,labor:1,time:1}, debuffEnemy:2, text:'ËÑÜÂº±„Å™ÁÇπ„ÇíÊ¥ó„ÅÑÂá∫„Åô', synergy:'Ê§úÁü•,ÁµÑÁπîÁöÑÂØæÁ≠ñ' },
  { id:'threatintel', name:'ËÑÖÂ®Å„Ç§„É≥„ÉÜ„É™„Ç∏„Çß„É≥„ÇπÊ¥ªÁî®', cost:{money:2,labor:1,time:1}, draw:1, text:'ÊîªÊíÉ„ÅÆÂÖÜÂÄô„ÇíÂÖàÂèñ„Çä', synergy:'Ê§úÁü•,Áµ±Ê≤ª' },
  { id:'insure', name:'„Çª„Ç≠„É•„É™„ÉÜ„Ç£‰øùÈô∫', cost:{money:3,labor:0,time:0}, heal:15, text:'ÊêçÂÆ≥„ÇíË£úÂÑü', synergy:'Âæ©Êóß,ÁµÑÁπîÁöÑÂØæÁ≠ñ' },
  { id:'authctrl', name:'Ê®©ÈôêÁÆ°ÁêÜ', cost:{money:1,labor:1,time:1}, defense:6, text:'Ê®©Èôê„ÇíÊúÄÂ∞èÂåñ„Åó„Å¶„É™„Çπ„ÇØ‰ΩéÊ∏õ', synergy:'Ë≠òÂà•,ÁµÑÁπîÁöÑÂØæÁ≠ñ' }, //
  { id:'vulnscan', name:'ËÑÜÂº±ÊÄßË®∫Êñ≠', cost:{money:2,labor:2,time:2}, debuffEnemy:3, text:'Âº±ÁÇπ„ÇíÁ™Å„Åã„Çå„ÇãÂâç„Å´Áô∫Ë¶ã', synergy:'Ê§úÁü•,Èò≤Âæ°' },
  { id:'redblue', name:'„É¨„ÉÉ„Éâ/„Éñ„É´„Éº„ÉÅ„Éº„É†ÊºîÁøí', cost:{money:2,labor:3,time:2}, buffDefense:6, text:'Ê®°Êì¨ÊîªÈò≤„ÅßÂÇô„Åà„Çã', synergy:'Ê§úÁü•,ÂØæÂøú' },
  { id:'soc', name:'SOCË®≠Á´ã', cost:{money:3,labor:3,time:3}, defense:15, text:'Â∏∏ÊôÇÁõ£Ë¶ñ‰ΩìÂà∂„ÇíÊï¥„Åà„Çã', synergy:'Ê§úÁü•,ÁµÑÁπîÁöÑÂØæÁ≠ñ' }, //
  { id:'dlp', name:'DLPÂ∞éÂÖ•', cost:{money:2,labor:2,time:2}, defense:10, text:'ÊÉÖÂ†±ÊºèÊ¥©„ÇíÊú™ÁÑ∂„Å´Èò≤„Åê', synergy:'„Éá„Éº„Çø,Èò≤Âæ°' }, //

  // ‰∫∫ÁöÑÂØæÁ≠ñ
  { id:'edu', name:'ÊÉÖÂ†±ÊïôËÇ≤', cost:{money:0,labor:2,time:1}, buffDefense:4, text:'Á§æÂì°„ÅÆÊÑèË≠ò„ÇíÈ´ò„ÇÅ„Çã', synergy:'‰∫∫ÁöÑÂØæÁ≠ñ,Áµ±Ê≤ª' },
  { id:'manual', name:'„Éû„Éã„É•„Ç¢„É´Âåñ', cost:{money:0,labor:1,time:1}, defense:4, text:'ÂØæÂøú„ÇíÊ®ôÊ∫ñÂåñ„Åó„Éü„Çπ„ÇíÊ∏õ„Çâ„Åô', synergy:'‰∫∫ÁöÑÂØæÁ≠ñ,ÂØæÂøú' },
  { id:'check', name:'Áõ∏‰∫íÁ¢∫Ë™ç„ÉªÁõ£Ë¶ñ', cost:{money:0,labor:2,time:0}, defense:5, text:'‰∏çÊ≠£„ÇÑË™§„Çä„ÇíÊó©ÊúüÁô∫Ë¶ã', synergy:'‰∫∫ÁöÑÂØæÁ≠ñ,Ê§úÁü•' },
  { id:'prevent', name:'ÊïÖÊÑè„ÅÆÈò≤Ê≠¢Á≠ñ', cost:{money:1,labor:2,time:1}, defense:7, text:'ÂÜÖÈÉ®‰∏çÊ≠£„ÇíÊäëÊ≠¢', synergy:'‰∫∫ÁöÑÂØæÁ≠ñ,Èò≤Âæ°' },
  { id:'hunt', name:'„Çπ„É¨„ÉÉ„Éâ„Éè„É≥„ÉÜ„Ç£„É≥„Ç∞', cost:{money:2,labor:2,time:2}, draw:2, text:'ÊΩú‰ºè„Åô„ÇãËÑÖÂ®Å„Çí„ÅÇ„Å∂„ÇäÂá∫„Åô', synergy:'‰∫∫ÁöÑÂØæÁ≠ñ,Ê§úÁü•' },
];
const EVENT_CARD_TEMPLATES = [
  { id:'incident', name:'„Ç§„É≥„Ç∑„Éá„É≥„ÉàÂØæÂøú', cost:{money:1,labor:1,time:0}, text:'', synergy:'incident', instant: true, must: true },
  { id:'accident', name:'ÈöúÂÆ≥ÂØæÂøú', cost:{money:1,labor:1,time:0}, text:'', synergy:'accident', instant: true, must: true },
  { id:'accident', name:'ÈöúÂÆ≥ÂØæÂøúÔºàÂéüÂõ†ÂØæÂá¶Ôºâ', cost:{money:1,labor:1,time:0}, text:'', synergy:'accident', instant: true}, // ÁèæÁä∂ÂÆüË£Ö„Å†„Å®‰Ωø„Çè„Å™„ÅÑ
  { id:'customer', name:'È°ßÂÆ¢ÂØæÂøú', cost:{money:1,labor:1,time:0}, text:'', synergy:'customer', instant:true, must: true },
  { id:'recruit_allies', name:'„Ç§„Éô„É≥„ÉàÔºà‰ª≤Èñì„ÇíÂãüÈõÜÔºõÈï∑ÊúüËÇ≤ÊàêÔºâ', cost:{money:1,labor:2,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'united_we_stand', name:'„Ç§„Éô„É≥„ÉàÔºàÂõ£Áµê„ÅØÂäõ„Å™„ÇäÔºõÊÉÖÂ†±‰∫§Êèõ„ÇíÊ¥ªÁô∫ÂåñÔºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'secure_partnership', name:'„Ç§„Éô„É≥„ÉàÔºàÂÆâÂÖ®„Å™ÊèêÊê∫ÔºõÂÖ±ÂêåÁ†îÁ©∂„ÇíÈñãÂßãÔºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'supply_chain_attack', name:'„Ç§„Éô„É≥„ÉàÔºàÁ¶çÁ¶è„ÇíÂÖ±„Å´ÔºõÂç≥ÊôÇË™øÊüªÔºâ', cost:{labor:2,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'careless_member', name:'„Ç§„Éô„É≥„ÉàÔºà‰∏çÊ≥®ÊÑè„Å™‰ª≤ÈñìÔºõÂØæÂøú„ÉÅ„Éº„É†„ÇíÊ¥æÈÅ£Ôºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'temptation', name:'„Ç§„Éô„É≥„ÉàÔºàÊäó„ÅÑ„Åå„Åü„ÅÑË™òÊÉëÔºõÈöîÈõ¢„Åó„Å¶‰øÆÂæ©Ôºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'inappropriate', name:'„Ç§„Éô„É≥„ÉàÔºà‰∏Ä‰Ωì‰Ωï„ÇíÔºõÂç≥Âæ©Êóß‰ΩúÊ•≠Ôºâ', cost:{labor:2,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'leak_darkweb', name:'„Ç§„Éô„É≥„ÉàÔºàÊ≥£„Åç„Å£Èù¢„Å´ËúÇÔºõÂÖ¨ÁöÑÊ©üÈñ¢„Å´ÈÄöÂ†±Ôºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'stolen_redteam', name:'„Ç§„Éô„É≥„ÉàÔºà„É¨„ÉÉ„Éâ„ÉÅ„Éº„É†„ÉÑ„Éº„É´„ÅåÁõó„Åæ„Çå„ÅüÔºõÊó©ÊÄ•„Å´„Éë„ÉÉ„ÉÅÂØæÂøúÔºâ', cost:{labor:2,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'stolen_redteam', name:'„Ç§„Éô„É≥„ÉàÔºà„É¨„ÉÉ„Éâ„ÉÅ„Éº„É†„ÉÑ„Éº„É´„ÅåÁõó„Åæ„Çå„ÅüÔºõÂ§ñÈÉ®„Å∏Ê≥®ÊÑèÂñöËµ∑Ôºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'fake_security', name:'„Ç§„Éô„É≥„ÉàÔºàÁúüË¥ã„ÅÆË¶ãÂàÜ„Åë„Åå„Å§„Åã„Å™„ÅÑË£ΩÂìÅÔºõË™øÊüª„Åó„Å¶Â∞éÂÖ•‰øùÁïôÔºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'law', name:'„Ç§„Éô„É≥„ÉàÔºàÊÉÖÂ†±„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÁÆ°ÁêÜÊ≥ïÔºõÊ≥ïÂØæÂøú„ÅÆ‰ªïÁµÑ„ÅøÂ∞éÂÖ•Ôºâ', cost:{money:1,labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'gdpr', name:'„Ç§„Éô„É≥„ÉàÔºàGDPR„ÅÆÊ≠£ÂºèÁô∫ÂäπÔºõGDPRÊ∫ñÊã†‰ΩìÂà∂„ÇíÂ∞éÂÖ•Ôºâ', cost:{money:2,labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'taiwan_policy', name:'„Ç§„Éô„É≥„ÉàÔºàË≥áÂÆâÂç≥ÂõΩÂÆâÔºõÊîøÂ∫úÊñπÈáù„Å´Âæì„ÅÜÔºâ', cost:{labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'contest_app', name:'„Ç§„Éô„É≥„ÉàÔºà„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„ÉàÔºõÂÖ®ÂäõÂèÇÂä†Ôºâ', cost:{labor:2,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'contest_app', name:'„Ç§„Éô„É≥„ÉàÔºà„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„ÉàÔºõÂèÇÂä†„Åô„ÇãÔºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'contest_device', name:'„Ç§„Éô„É≥„ÉàÔºà„Éá„Éê„Ç§„Çπ‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„ÉàÔºõÂÖ®ÂäõÂèÇÂä†Ôºâ', cost:{labor:2,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'contest_device', name:'„Ç§„Éô„É≥„ÉàÔºà„Éá„Éê„Ç§„Çπ‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„ÉàÔºõÂèÇÂä†„Åô„ÇãÔºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'contest_data', name:'„Ç§„Éô„É≥„ÉàÔºà„Éá„Éº„Çø‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„ÉàÔºõÂÖ®ÂäõÂèÇÂä†Ôºâ', cost:{labor:2,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'contest_data', name:'„Ç§„Éô„É≥„ÉàÔºà„Éá„Éº„Çø‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„ÉàÔºõÂèÇÂä†„Åô„ÇãÔºâ', cost:{labor:1,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'meltdown', name:'„Ç§„Éô„É≥„ÉàÔºàMeltdownËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÁ∑äÊÄ•‰øÆÊ≠£Ôºâ', cost:{labor:3,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'meltdown', name:'„Ç§„Éô„É≥„ÉàÔºàMeltdownËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÂæåÊó•‰øÆÊ≠£Ôºâ', cost:{labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'eternalblue', name:'„Ç§„Éô„É≥„ÉàÔºàEternalBlueËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÁ∑äÊÄ•‰øÆÊ≠£Ôºâ', cost:{labor:3,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'eternalblue', name:'„Ç§„Éô„É≥„ÉàÔºàEternalBlueËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÂæåÊó•‰øÆÊ≠£Ôºâ', cost:{labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'shellshock', name:'„Ç§„Éô„É≥„ÉàÔºàShellShockËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÁ∑äÊÄ•‰øÆÊ≠£Ôºâ', cost:{labor:3,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'shellshock', name:'„Ç§„Éô„É≥„ÉàÔºàShellShockËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÂæåÊó•‰øÆÊ≠£Ôºâ', cost:{labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'spectre', name:'„Ç§„Éô„É≥„ÉàÔºàSpectreËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÁ∑äÊÄ•‰øÆÊ≠£Ôºâ', cost:{labor:3,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'spectre', name:'„Ç§„Éô„É≥„ÉàÔºàSpectreËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÂæåÊó•‰øÆÊ≠£Ôºâ', cost:{labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'heartbleed', name:'„Ç§„Éô„É≥„ÉàÔºàHeartBleedËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÁ∑äÊÄ•‰øÆÊ≠£Ôºâ', cost:{labor:3,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'heartbleed', name:'„Ç§„Éô„É≥„ÉàÔºàHeartBleedËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÂæåÊó•‰øÆÊ≠£Ôºâ', cost:{labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'zerologon', name:'„Ç§„Éô„É≥„ÉàÔºàZerologonËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÁ∑äÊÄ•‰øÆÊ≠£Ôºâ', cost:{labor:3,time:1}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
  { id:'zerologon', name:'„Ç§„Éô„É≥„ÉàÔºàZerologonËÑÜÂº±ÊÄßÁô∫ÁîüÔºõÂæåÊó•‰øÆÊ≠£Ôºâ', cost:{labor:1,time:2}, text:'ÂÆüË°å‰∏≠', synergy:'', instant:true},
];


// Enemy templates (concept + ATT&CK-like theme)
const ENEMY_TEMPLATES = {
  normal:[
    {id:'vuln_exploit', name:'ËÑÜÂº±ÊÄß„Çπ„Ç≠„É£„Éä', hp:30, def:0, intent:'attack', intentValue:6, tags:['vuln']},
    {id:'phisher', name:'„ÇΩ„Éº„Ç∑„É£„É´„Ç®„É≥„Ç∏„Éã„Ç¢', hp:28, def:0, intent:'attack', intentValue:5, tags:['human']},
    {id:'worm', name:'„Éû„É´„Ç¶„Çß„Ç¢ÈÖçÈÄÅ', hp:32, def:2, intent:'attack', intentValue:7, tags:['malware']},
  ],
  elite:[
    {id:'apt_probe', name:'APT ÂÅµÂØü', hp:55, def:3, intent:'attack', intentValue:10, tags:['recon']},
    {id:'supply_chain', name:'„Çµ„Éó„É©„Ç§„ÉÅ„Çß„Éº„É≥', hp:60, def:4, intent:'attack', intentValue:12, tags:['supply']},
  ],
  boss:[
    {id:'zero_day', name:'„Çº„É≠„Éá„Ç§ÊîªÊíÉËÄÖ', hp:120, def:6, intent:'attack', intentValue:18, tags:['vuln','remote']},
  ]
};

const EVENT_TEMPLATES = [
  /*
  {id:'budget_cut', text:'‰ºÅÊ•≠„Åå„Ç≥„Çπ„ÉàÂâäÊ∏õ„ÇíÁô∫Ë°®„ÄÇÈáëÈä≠„Ç®„Éä„Ç∏„ÉºÊ∏õÂ∞ë', effect:()=>{ RUN.player.gold = Math.max(1, RUN.player.gold-1);} },
  {id:'investment', text:'ÊäïË≥á„ÅåÂÖ•„Çä„ÄÅÈáëÈä≠„ÇíÁç≤Âæó', effect:()=>{ RUN.player.gold += 20; }},
  {id:'insider', text:'ÂÜÖÈÉ®‰∏çÊ≠£„ÇíÁô∫Ë¶ãÔºÅ‰∫∫Êâã„ÅåÊ∏õÂ∞ë', effect:()=>{ RUN.player.maxEnergy--; RUN.player.energy--; }},
  {id:'policy', text:'„Éù„É™„Ç∑„ÉºÂà∑Êñ∞„Åß‰∏ÄÊôÇÁöÑ„Éê„Éï', effect:()=>{ RUN.player.defense += 6; }},
  {id:'zero_day_found', text:'„Çº„É≠„Éá„Ç§„ÇíÁô∫Ë¶ãÔºÅ„Å†„ÅåË™øÊüª„Å´ÊôÇÈñì„ÅåÂøÖË¶Å', effect:()=>{ RUN.player.energy -= 1; RUN.player.applyEffectWaiting.push({leftTime: 3, card: { id:'event', name:'Duel Zero Day Vulnerability', cost:{money:1,labor:1,time:0}, text:'„Çº„É≠„Éá„Ç§ËÑÜÂº±ÊÄßÂØæÂøú', synergy:'vulnerability' }}); }},
  */
  // ËâØ„ÅÑ„Ç§„Éô„É≥„Éà
  {id:'recruit_allies', title:'‰ª≤Èñì„ÇíÂãüÈõÜ', text:'', tag: 'good', choices:[
    {option:'È´òÁµ¶„ÅßÁ´∂Âêà‰ªñÁ§æ„ÅÆÂÑ™ÁßÄ„Å™‰∫∫Êùê„ÇíÂç≥Êà¶Âäõ„Å®„Åó„Å¶Êé°Áî®', effect:()=>{ return {labor:+2, money:-2, trust:+1}; }},
    {option:'Êñ∞‰∫∫„ÇíÈõá„ÅÜÔºéÁ†î‰øÆ„ÇíË°å„ÅÑÈï∑ÊúüËÇ≤Êàê', effect:()=>{ return {labor:+2, money:-1, time:-1, trust:+2, card:EVENT_CARD_TEMPLATES[4]}; }},
    {option:'ÂãüÈõÜ„Åó„Å™„ÅÑ', effect:()=>{ return {}; }}
  ]},
  {id:'united_we_stand', title:'Âõ£Áµê„ÅØÂäõ„Å™„Çä', text:'Ê•≠ÁïåÂõ£‰Ωì„Å´Âä†ÂÖ•„Åó„ÄÅÂçîÂäõ‰ΩìÂà∂„ÇíÂº∑Âåñ„Åó„ÅüÔºÅ', tag: 'good', choices:[
    //{option:'Âä†ÂÖ•Ë≤ª„ÇíÊîØÊâï„ÅÜ', effect:()=>{ return {money:-1, trust:+2}; }},
    {option:'ÊÉÖÂ†±‰∫§Êèõ„ÇíÊ¥ªÁô∫Âåñ', effect:()=>{ return {labor:-1, time:-1, trust:+3, card:EVENT_CARD_TEMPLATES[5]}; }},
    {option:'‰∫∫ÊùêÊ¥ªÁî®Ë°ì„ÇíÁøí„ÅÜ', effect:()=>{ return {labor:+1}; }}
  ]},
  {id:'iso_cert', title:'ISO27001„Å´ÂêàÊ†º', text:'ÊÉÖÂ†±„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Éû„Éç„Ç∏„É°„É≥„ÉàÂõΩÈöõË¶èÊ†º„Å´Ë™çÂÆöÔºÅ', tag: 'good', choices:[
    {option:'‰ø°È†º„ÇíÂæó„Çâ„Çå„Çã„Çà„ÅÜ„Å´ÔºåÂ∫ÉÂ†±„Åó„Å¶„Ç¢„Éî„Éº„É´', effect:()=>{ return {trust:+3}; }},
    {option:'ÂèéÁõä„Å´Áπã„Åå„Çã„Çà„ÅÜ„Å´ÔºåÂ∫ÉÂ†±„Åó„Å¶„Ç¢„Éî„Éº„É´', effect:()=>{ return {money:+1}; }},
    {option:'Êé°Áî®„Å´Áπã„Åå„Çã„Çà„ÅÜ„Å´ÔºåÂ∫ÉÂ†±„Åó„Å¶„Ç¢„Éî„Éº„É´', effect:()=>{ return {labor:+1}; }}
  ]},
  {id:'bug_bounty', title:'BugBounty', text:'ËÑÜÂº±ÊÄßÂ†±Â•®ÈáëÂà∂Â∫¶„ÇíÂ∞éÂÖ•ÔºÅ', tag: 'good', choices:[
    {option:'Â∞éÂÖ•„Åô„Çã', effect:()=>{ return {money:-2}; }},
    {option:'‰Ωï„ÇÇ„Åó„Å™„ÅÑ', effect:()=>{ return {}; }}
    /*
    {option:'„Åô„Åê‰øÆÊ≠£„Å´Âèñ„ÇäÁµÑ„ÇÄ', effect:()=>{ return {labor:-1, time:-1, money:-1, trust:+2}; }},
    {option:'Â†±ÈÖ¨„ÇíÂ¢óÈ°ç', effect:()=>{ return {money:-2, trust:+3}; }}
    */
  ]},
  {id:'profit_security', title:'ÊÉÖÂ†±„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅßÂ§ßÂÑ≤„Åë', text:'Èï∑Âπ¥„ÅÆÊäïË≥á„ÅåÂÆü„ÇäÈ°ßÂÆ¢‰ø°È†ºUPÔºÅ', tag: 'good', choices:[
    {option:'ÈÖçÂΩì„ÇíÂá∫„Åô', effect:()=>{ return {money:+3, trust:+1}; }},
    {option:'ÂÜçÊäïË≥á', effect:()=>{ return {money:+1, trust:+2}; }}
  ]},
  {id:'ai_defense', title:'AIÈò≤Âæ°„Ç∑„Çπ„ÉÜ„É†', text:'AI„Éô„Éº„Çπ„ÅÆÈò≤Âæ°„Ç∑„Çπ„ÉÜ„É†„ÇíÂ∞éÂÖ•„Åô„ÇãÔºü', tag: 'good', choices:[
    {option:'È´òÈ°ç„Å†„ÅåÂ∞éÂÖ•', effect:()=>{ return {money:-2, trust:+3}; }},
    {option:'Ë©¶È®ìÂ∞éÂÖ•„ÅÆ„Åø', effect:()=>{ return {money:-1, trust:+1}; }}
  ]},
  {id:'secure_partnership', title:'ÂÆâÂÖ®„Å™ÊèêÊê∫', text:'„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÊÑèË≠ò„ÅÆÈ´ò„ÅÑ‰ºÅÊ•≠„Å®ÊèêÊê∫ÔºÅ', tag: 'good', choices:[
    {option:'ÂÖ±ÂêåÁ†îÁ©∂„ÇíÈñãÂßã', effect:()=>{ return {labor:-1, time:-1, trust:+3, card:EVENT_CARD_TEMPLATES[6]}; }},
    {option:'ËÉΩÂäõÁç≤Âæó„ÇíÁõ∏‰∫íÊîØÊè¥', effect:()=>{ return {labor:+1}; }}
  ]},
  {id:'academic_collab', title:'Â§ßÂ≠¶„Å®ÂÖ±ÂêåÁ†îÁ©∂', text:'Â§ßÂ≠¶„Å®„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÂàÜÈáé„ÅßÂÖ±ÂêåÁ†îÁ©∂ÔºÅ', tag: 'good', choices:[
    {option:'Á†îÁ©∂„Å´Ë≥áÈáëÊèê‰æõ', effect:()=>{ return {money:-2, labor:+1}; }}
    //{option:'', effect:()=>{ return {labor:-2, trust:+2}; }}
  ]},
  {id:'fast_response', title:'ËøÖÈÄü„Å™ÂØæÂøú', text:'„Ç§„É≥„Ç∑„Éá„É≥„ÉàÂØæÂøú„ÅÆËøÖÈÄü„Åï„ÅåË©ï‰æ°„Åï„Çå„ÅüÔºÅ', tag: 'good', choices:[
    {option:'Á§æÂÜÖ„ÅßÂ£´Ê∞óÂêë‰∏ä', effect:()=>{ return {labor:+1, trust:+2}; }}
  ]},
  {id:'client_contract', title:'Â§ßÂè£Â•ëÁ¥ÑÁç≤Âæó', text:'Â§ßÊâã‰ºÅÊ•≠„Å®„ÅÆÂ•ëÁ¥Ñ„ÇíÁç≤ÂæóÔºÅ', tag: 'good', choices:[
    {option:'Áü≠ÊúüÂ•ëÁ¥ÑÔºà‰∏ÄÊôÇÁöÑË≥áÈáëÔºâ', effect:()=>{ return {money:+3, trust:+2}; }},
    {option:'Èï∑ÊúüÂ•ëÁ¥ÑÔºà‰∫àÁÆóÂ¢óÈ°çÔºâ', effect:()=>{ return {budget:+5, trust:+2}; }}
  ]},
  {id:'security_awareness', title:'ÂæìÊ•≠Âì°ÊÑèË≠òÂêë‰∏ä', text:'„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÊïôËÇ≤„ÅåÊàêÂäü„ÅóÂæìÊ•≠Âì°„ÅÆÊÑèË≠ò„ÅåUPÔºÅ', tag: 'good', choices:[
    //{option:'ÊïôËÇ≤Á∂ôÁ∂ö', effect:()=>{ return {time:-1, labor:+2, trust:+2}; }},
    {option:'ÊïôËÇ≤Á∂ôÁ∂ö', effect:()=>{ return {labor:+1, trust:+2}; }}
  ]},
  {id:'cyber_insurance', title:'„Çµ„Ç§„Éê„Éº‰øùÈô∫Â∞éÂÖ•', text:'‰øùÈô∫„Å´„Çà„Çã„É™„Çπ„ÇØÂàÜÊï£„ÇíÂÆüÁèæ„Åß„Åç„Çã', tag: 'good', choices:[
    {option:'È´òÈ°ç‰øùÈô∫„Å´Âä†ÂÖ•', effect:()=>{ return {money:-2, trust:+3}; }},
    {option:'ÊúÄ‰ΩéÈôê„ÅÆ‰øùÈô∫„Å´Âä†ÂÖ•', effect:()=>{ return {money:-1, trust:+1}; }},
    {option:'‰Ωï„ÇÇ„Åó„Å™„ÅÑ', effect:()=>{ return {trust:-2}; }}
  ]},
  {id:'global_expansion', title:'Êµ∑Â§ñÈÄ≤Âá∫ÊàêÂäü', text:'Êµ∑Â§ñÂ∏ÇÂ†¥„Åß„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ„ÅåË©ï‰æ°„Åï„Çå„ÅüÔºÅ', tag: 'good', choices:[
    {option:'ÁèæÂú∞Ê≥ï‰∫∫„ÇíË®≠Á´ã', effect:()=>{ return {money:-3, trust:+4}; }},
    {option:'‰∫∫Êùê„ÇíÊ¥æÈÅ£„Åô„Çã', effect:()=>{ return {labor:-1, money:+2, trust:+2}; }},
    {option:'‰Ωï„ÇÇ„Åó„Å™„ÅÑ', effect:()=>{ return {trust:+1}; }},
  ]},
  // ===== ÂïèÈ°åÁô∫Áîü =====
  {id:'supply_chain_attack', title:'Á¶çÁ¶è„ÇíÂÖ±„Å´', text:'„Çµ„Éó„É©„Ç§„ÉÅ„Çß„Éº„É≥‰∏äÊµÅ„Åå‰æµÂÖ•„Åï„Çå„ÅüÔºÅ', tag: 'bad', choices:[
    {option:'Âç≥ÊôÇË™øÊüª', effect:()=>{ return {labor:-2, time:-1, trust:-2, card:EVENT_CARD_TEMPLATES[7]}; }},
    {option:'Â§ñÈÉ®„Ç≥„É≥„Çµ„É´‰æùÈ†º', effect:()=>{ return {money:-2, trust:-1}; }}
  ]},
  {id:'careless_member', title:'‰∏çÊ≥®ÊÑè„Å™‰ª≤Èñì', text:'PC„ÇíÁ¥õÂ§±„ÅóÊ©üÂØÜÊÉÖÂ†±ÊºèÊ¥©„ÅÆÂç±Ê©üÔºÅ', tag: 'bad', choices:[
    {option:'ÂØæÂøú„ÉÅ„Éº„É†„ÇíÊ¥æÈÅ£', effect:()=>{ return {labor:-1, time:-1, trust:-2, card:EVENT_CARD_TEMPLATES[8]}; }},
    {option:'ÊîæÁΩÆÔºàÈö†ËîΩÔºâ', effect:()=>{ return {trust:-4}; }}
  ]},
  {id:'hidden_truth', title:'Èö†„Åï„Çå„ÅüÁúüÂÆü', text:'„É©„É≥„Çµ„É†Ë¢´ÂÆ≥„ÅåÁô∫ÁîüÔºÅË©ïÂà§„Åå‰Ωé‰∏ã‚Ä¶', tag: 'bad', choices:[
    {option:'ÂÖ¨Ë°®„Åô„Çã', effect:()=>{ return {trust:-2, money:-5}; }},
    {option:'Èö†ËîΩ„Åô„Çã', effect:()=>{ return {trust:-4}; }}
  ]},
  {id:'temptation', title:'Êäó„ÅÑ„Åå„Åü„ÅÑË™òÊÉë', text:'„É°„Éº„É´„ÅÆ„É™„É≥„ÇØ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶ÊÑüÊüìÔºÅ', tag: 'bad', choices:[
    {option:'ÈöîÈõ¢„Åó„Å¶‰øÆÂæ©', effect:()=>{ return {labor:-1, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[9]}; }}
  ]},
  {id:'inappropriate', title:'‰∏Ä‰Ωì‰Ωï„Çí', text:'Â∞±Ê•≠‰∏≠„Å´„Ç¢„ÉÄ„É´„Éà„Çµ„Ç§„ÉàÈñ≤Ë¶ß‚Üí„Ç∑„Çπ„ÉÜ„É†ÂÅúÊ≠¢ÔºÅ', tag: 'bad', choices:[
    {option:'ÂæìÊ•≠Âì°„ÇíÂá¶ÂàÜ', effect:()=>{ return {labor:-1, trust:-1}; }},
    {option:'Âç≥Âæ©Êóß‰ΩúÊ•≠', effect:()=>{ return {labor:-2, time:-2, trust:-2, card:EVENT_CARD_TEMPLATES[10]}; }}
  ]},
  {id:'hire_hacker', title:'ÁõÆ„Å´„ÇÇ„ÅÆË¶ã„Åõ„Å¶„ÇÑ„Çã', text:'„Éè„ÉÉ„Ç´„Éº„ÇíÈõá„Å£„Å¶Á´∂Âêà„ÇíÊîªÊíÉÔºÅ', tag: 'bad', choices:[
    {option:'Âº∑Ë°å„Åô„Çã', effect:()=>{ return {trust:-4, money:-2}; }},
    {option:'Ë∏è„Åø„Å®„Å©„Åæ„Çã', effect:()=>{ return {trust:+1}; }}
  ]},
  {id:'leak_darkweb', title:'Ê≥£„Åç„Å£Èù¢„Å´ËúÇ', text:'ÈáçË¶ÅÊÉÖÂ†±„Åå„ÉÄ„Éº„ÇØ„Ç¶„Çß„Éñ„ÅßË≤©Â£≤ÔºÅ', tag: 'bad', choices:[
    {option:'ÂºÅË≠∑Â£´„ÇíÈõá„ÅÜ', effect:()=>{ return {money:-2, trust:-2}; }},
    {option:'ÂÖ¨ÁöÑÊ©üÈñ¢„Å´ÈÄöÂ†±', effect:()=>{ return {labor:-1, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[11]}; }}
  ]},
  {id:'stolen_redteam', title:'„É¨„ÉÉ„Éâ„ÉÅ„Éº„É†„ÉÑ„Éº„É´„ÅåÁõó„Åæ„Çå„Åü', text:'ÊîªÊíÉÊâãÊ≥ï„Åå‰∏ñÁïå„Å´Êã°Êï£ÔºÅ', tag: 'bad', choices:[
    {option:'Êó©ÊÄ•„Å´„Éë„ÉÉ„ÉÅÂØæÂøú', effect:()=>{ return {labor:-2, time:-2, card:EVENT_CARD_TEMPLATES[12]}; }},
    {option:'Â§ñÈÉ®„Å∏Ê≥®ÊÑèÂñöËµ∑', effect:()=>{ return {labor:-1, time:-1, trust:-2, card:EVENT_CARD_TEMPLATES[13]}; }}
  ]},
  {id:'fake_security', title:'ÁúüË¥ã„ÅÆË¶ãÂàÜ„Åë„Åå„Å§„Åã„Å™„ÅÑË£ΩÂìÅ', text:'ÂÅΩÈÄ†„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë£ΩÂìÅ„ÇíÂ∞éÂÖ•„ÅãÔºÅÔºü', tag: 'bad', choices:[
    {option:'Ë™øÊüª„Åó„Å¶Â∞éÂÖ•‰øùÁïô', effect:()=>{ return {labor:-1, time:-1, trust:+1, card:EVENT_CARD_TEMPLATES[14]}; }},
    {option:'„Åù„ÅÆ„Åæ„ÅæÂà©Áî®', effect:()=>{ return {trust:-3}; }}
  ]},
  // ===== ‰øùË≠∑Ê≥ï„ÉªÊîøÁ≠ñ =====
  {id:'law', title:'ÊÉÖÂ†±„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÁÆ°ÁêÜÊ≥ï', text:'„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÁÆ°ÁêÜÊ≥ï„ÅåÊñΩË°å„Åï„Çå„Åü', tag: 'society', choices:[
    {option:'Ê≥ïÂØæÂøú„ÅÆ‰ªïÁµÑ„ÅøÂ∞éÂÖ•', effect:()=>{ return {money:-1, labor:-1, time:-2, trust:+2, card:EVENT_CARD_TEMPLATES[15]}; }},
    {option:'Â∞éÂÖ•Ë¶ãÈÄÅ„Çä', effect:()=>{ return {trust:-1}; }}
  ]},
  {id:'gdpr', title:'GDPR„ÅÆÊ≠£ÂºèÁô∫Âäπ', text:'EU„ÅßÂÄã‰∫∫„Éá„Éº„Çø‰øùË≠∑Ê≥ï„ÅåÊñΩË°åÔºÅ', tag: 'society', choices:[
    {option:'GDPRÊ∫ñÊã†‰ΩìÂà∂„ÇíÂ∞éÂÖ•', effect:()=>{ return {money:-2, labor:-1, time:-2, trust:+3, card:EVENT_CARD_TEMPLATES[16]}; }},
    {option:'Â∞éÂÖ•Ë¶ãÈÄÅ„Çä', effect:()=>{ return {trust:-2}; }}
  ]},
  {id:'taiwan_policy', title:'Ë≥áÂÆâÂç≥ÂõΩÂÆâ', text:'ÊÉÖÂ†±„Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÅåÂõΩÂÆâÊîøÁ≠ñ„Å´ÔºÅ', tag: 'society', choices:[
    {option:'ÊîøÂ∫úÊñπÈáù„Å´Âæì„ÅÜ', effect:()=>{ return {labor:-1, time:-2, trust:+2, card:EVENT_CARD_TEMPLATES[17]}; }},
    {option:'Â∞éÂÖ•Ë¶ãÈÄÅ„Çä', effect:()=>{ return {}; }}
  ]},
  {id:'gov_grant', title:'ÊîøÂ∫úË£úÂä©ÈáëÁç≤Âæó', text:'ÊîøÂ∫ú„ÅÆ„Çµ„Ç§„Éê„Éº„Çª„Ç≠„É•„É™„ÉÜ„Ç£Ë£úÂä©Èáë„ÇíÁç≤ÂæóÔºÅ', tag: 'society', choices:[
    {option:'„Çª„Ç≠„É•„É™„ÉÜ„Ç£Âº∑Âåñ„Å´ÊäïË≥á', effect:()=>{ return {money:+2, trust:+1}; }}
  ]},

  // ===== „Ç≥„É≥„ÉÜ„Çπ„Éà =====
  {id:'contest_app', title:'„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„Éà', text:'„Ç¢„Éó„É™Èò≤Âæ°Â§ß‰ºö„Å´ÂèÇÂä†ÔºÅ', tag: 'contest', choices:[
    {option:'ÂÖ®ÂäõÂèÇÂä†', effect:()=>{ return {labor:-2, time:-2, trust:+3, card:EVENT_CARD_TEMPLATES[18]}; }},
    {option:'ÂèÇÂä†„Åô„Çã', effect:()=>{ return {labor:-1, time:-1, trust:+1, card:EVENT_CARD_TEMPLATES[19]}; }},
    {option:'Ë¶ãÈÄÅ„Çä', effect:()=>{ return {trust:-1}; }}
  ]},
  {id:'contest_device', title:'„Éá„Éê„Ç§„Çπ‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„Éà', text:'„Éá„Éê„Ç§„ÇπÈò≤Âæ°Â§ß‰ºö„Å´ÂèÇÂä†ÔºÅ', tag: 'contest', choices:[
    {option:'ÂÖ®ÂäõÂèÇÂä†', effect:()=>{ return {labor:-2, time:-2, trust:+3, card:EVENT_CARD_TEMPLATES[20]}; }},
    {option:'ÂèÇÂä†„Åô„Çã', effect:()=>{ return {labor:-1, time:-1, trust:+1, card:EVENT_CARD_TEMPLATES[21]}; }},
    {option:'Ë¶ãÈÄÅ„Çä', effect:()=>{ return {trust:-1}; }}
  ]},
  {id:'contest_data', title:'„Éá„Éº„Çø‰øùË≠∑„Ç≥„É≥„ÉÜ„Çπ„Éà', text:'„Éá„Éº„Çø‰øùË≠∑Â§ß‰ºö„Å´ÂèÇÂä†ÔºÅ', tag: 'contest', choices:[
    {option:'ÂÖ®ÂäõÂèÇÂä†', effect:()=>{ return {labor:-2, time:-2, trust:+3, card:EVENT_CARD_TEMPLATES[22]}; }},
    {option:'ÂèÇÂä†„Åô„Çã', effect:()=>{ return {labor:-1, time:-1, trust:+1, card:EVENT_CARD_TEMPLATES[23]}; }},
    {option:'Ë¶ãÈÄÅ„Çä', effect:()=>{ return {trust:-1}; }}
  ]},
  {id:'talent_award', title:'„Çª„Ç≠„É•„É™„ÉÜ„Ç£‰∫∫ÊùêË≥û', text:'ÂæìÊ•≠Âì°„ÅåÊ•≠Áïå„ÅÆ‰∫∫ÊùêË≥û„ÇíÂèóË≥ûÔºÅ', tag: 'contest', choices:[
    {option:'Á•ùÁ¶è„ÅóÔºåÂ£´Ê∞óÈ´òÊèö', effect:()=>{ return {labor:+1, trust:+2}; }},
    {option:'„Éã„É•„Éº„Çπ„ÅßÂ∫ÉÂ†±', effect:()=>{ return {money:+1}; }}
  ]},
  {id:'award_cert', title:'Ê•≠ÁïåË°®ÂΩ∞', text:'ÂÑ™„Çå„Åü„Çª„Ç≠„É•„É™„ÉÜ„Ç£ÈÅãÁî®„ÅßË°®ÂΩ∞„Åï„Çå„ÅüÔºÅ', tag: 'contest', choices:[
    {option:'Á•ùÁ¶è„ÅóÔºåÂ£´Ê∞óÈ´òÊèö', effect:()=>{ return {labor:+1}; }},
    {option:'„Éã„É•„Éº„Çπ„ÅßÂ∫ÉÂ†±', effect:()=>{ return {trust:+3}; }},
  ]},

  // ===== ËÑÜÂº±ÊÄß„ÅÆÁô∫Áîü =====
  {id:'meltdown', title:'MeltdownËÑÜÂº±ÊÄßÁô∫Áîü', text:'CPUË®≠Ë®àÊ¨†Èô•„Å´„Çà„ÇãËÑÜÂº±ÊÄßÔºÅ', tag: 'vuln', choices:[
    {option:'Á∑äÊÄ•‰øÆÊ≠£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[24]}; }},
    {option:'ÂæåÊó•‰øÆÊ≠£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[25]}; }}
    //{option:'„Éë„ÉÉ„ÉÅ„ÇíÈÅ©Áî®', effect:()=>{ return {labor:-1, time:-1, trust:-1}; }}
  ]},
  {id:'eternalblue', title:'EternalBlueËÑÜÂº±ÊÄßÁô∫Áîü', text:'SMB„Çµ„Éº„Éì„Çπ„ÅÆËÑÜÂº±ÊÄßÔºÅ', tag: 'vuln', choices:[
    {option:'Á∑äÊÄ•‰øÆÊ≠£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[26]}; }},
    {option:'ÂæåÊó•‰øÆÊ≠£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[27]}; }}
    //{option:'„Ç∑„Çπ„ÉÜ„É†Êõ¥Êñ∞', effect:()=>{ return {labor:-1, trust:-1}; }}
  ]},
  {id:'shellshock', title:'ShellShockËÑÜÂº±ÊÄßÁô∫Áîü', text:'Bash„Å´Ê∑±Âàª„Å™ËÑÜÂº±ÊÄßÔºÅ', tag: 'vuln', choices:[
    {option:'Á∑äÊÄ•‰øÆÊ≠£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[28]}; }},
    {option:'ÂæåÊó•‰øÆÊ≠£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[29]}; }}
    //{option:'ÂÖ®„Çµ„Éº„Éê‰øÆÊ≠£', effect:()=>{ return {labor:-2, time:-2, trust:-2}; }}
  ]},
  {id:'spectre', title:'SpectreËÑÜÂº±ÊÄßÁô∫Áîü', text:'ÊäïÊ©üÁöÑÂÆüË°åÊ¨†Èô•„Å´„Çà„Çä„É°„É¢„É™ÊºèÊ¥©ÔºÅ', tag: 'vuln', choices:[
    {option:'Á∑äÊÄ•‰øÆÊ≠£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[30]}; }},
    {option:'ÂæåÊó•‰øÆÊ≠£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[31]}; }}
    //{option:'Êö´ÂÆöÁ∑©ÂíåÁ≠ñ„ÇíÂ∞éÂÖ•', effect:()=>{ return {time:-1, trust:-1}; }}
  ]},
  {id:'heartbleed', title:'HeartBleedËÑÜÂº±ÊÄßÁô∫Áîü', text:'OpenSSL„ÅÆ„Éê„Ç∞„Å´„Çà„ÇäÊÉÖÂ†±ÊºèÊ¥©ÔºÅ', tag: 'vuln', choices:[
    {option:'Á∑äÊÄ•‰øÆÊ≠£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[32]}; }},
    {option:'ÂæåÊó•‰øÆÊ≠£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[33]}; }}
    //{option:'Á∑äÊÄ•‰øÆÊ≠£', effect:()=>{ return {labor:-1, trust:-2}; }}
  ]},
  {id:'zerologon', title:'ZerologonËÑÜÂº±ÊÄßÁô∫Áîü', text:'Ë™çË®º„Éê„Ç§„Éë„Çπ„ÅÆÊ∑±Âàª„Å™ËÑÜÂº±ÊÄßÔºÅ', tag: 'vuln', choices:[
    {option:'Á∑äÊÄ•‰øÆÊ≠£', effect:()=>{ return {labor:-3, time:-1, trust:-1, card:EVENT_CARD_TEMPLATES[34]}; }},
    {option:'ÂæåÊó•‰øÆÊ≠£', effect:()=>{ return {labor:-1, time:-2, trust:-3, card:EVENT_CARD_TEMPLATES[35]}; }}
    //{option:'Âç≥Â∫ß„Å´‰øÆÊ≠£', effect:()=>{ return {labor:-2, trust:-2}; }}
  ]},
];

// Relic templates
const RELIC_TEMPLATES = [
  {id:'inc_budget', name:'‰∫àÁÆóÂ¢óÈ°ç', desc:'‰∫àÁÆó„ÅÆÈáè„ÇíËøΩÂä†', effect:()=>{RUN.budget += 5;}},
  //{id:'team_hire', name:'Ëá®ÊôÇË¶ÅÂì°', desc:'Âä¥ÂÉçÂäõÊúÄÂ§ß+1', effect:(player)=>{player.maxEnergy.labor++; player.energy.labor++;}},
  {id:'team_hire', name:'Ëá®ÊôÇË¶ÅÂì°', desc:'Âä¥ÂÉçÂäõÊúÄÂ§ß+1', effect:()=>{RUN.player.maxEnergy.labor++; RUN.player.energy.labor++;}},
  {id:'automation', name:'Ëá™ÂãïÂåñ„ÉÑ„Éº„É´', desc:'Ê¨°ÂõûÊ•≠ÂãôÊôÇ,ÈÅ©Áî®ÂæÖ„Å°„ÅÆÂäπÊûú„Çí\n1tÁµåÈÅé„Åó„ÅüÁä∂ÊÖã„ÅßÈñãÂßã„Åô„Çã', effect:()=>{RUN.automationFlag = true;}},
  //{id:'network_expert', name:'„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÂ∞ÇÈñÄÂÆ∂', desc:'network„Ç∑„Éä„Ç∏„Éº„Ç´„Éº„Éâ„ÅÆÈò≤Âæ°ÂäπÊûúÂêë‰∏ä', effect:null},
];

/* ---------- Game State (persistent across scenes during one run) ---------- */
class RunState {
  constructor(){
    this.resetAll();
  }
  resetAll(){
    this.stageIndex = 0;
    this.map = []; // will be array of nodes
    this.debugMap = [];
    this.mapOptions = 2;
    // Player base stats / resources
    this.player = {
      maxHp: 100,
      hp: 100,
      maxHiddenHp: 30,
      hiddenHp: 30,
      defense: 0,
      gold: 10,
      drawcards: 5,
      // triple-energy
      maxEnergy: 3,
      energy: 3,
      relics: [],
      deck: [],
      discard: [],
      drawPile: [],
      applyEffect: [],
      applyEffectWaiting: []
    };
    // gold -> money resource used for shops but also energy
    this.budget = 10;
    //this.gold = 100;
    // store all-owned relic ids
    this.relicIds = new Set();
    this.automationFlag = false;
    this.playTime = 0;
    this.startTimestamp = Date.now();
  }

  applyRelic(relic){
    //if(this.relicIds.has(relic.id)) return;
    this.relicIds.add(relic.id);
    this.player.relics.push(relic);
    if(relic.effect) relic.effect(this.player);
  }

  renderCard(scene, x, y, width, height, card, onClick = null){
    const cardBg = scene.add.rectangle(x, y, width, height, 0x333333).setOrigin(0.5);
    cardBg.setStrokeStyle(2, 0xffffff);
    //const image = this.add.image(x,y,card.id).setInteractive();
    //const image = scene.add.image(x,y,card.id).setScale(0.5);
    const image = scene.add.image(x,y,card.id).setDisplaySize(64,64);

    // „Ç´„Éº„ÉâÂêç
    const nameText = scene.add.text(x, y - 50, card.name, {
      fontSize: "14px",
      color: "#ffffff",
      align: "center",
      wordWrap: { width: 90 }
    }).setOrigin(0.5);

    // „Ç≥„Çπ„ÉàË°®Á§∫
    //const costText = scene.add.text(x, y - 20, `üí∞${card.cost.money} üë•${card.cost.labor} ‚è±${card.cost.time}`, {
    const costText = scene.add.text(x, y + 50, `üí∞${card.cost.money} üë•${card.cost.labor} ‚è±${card.cost.time}`, {
      fontSize: "12px",
      color: "#ffcc00",
      align: "center"
    }).setOrigin(0.5);

    // ÂäπÊûúË™¨Êòé
    //const effectText = scene.add.text(x, y + 20, `${card.text}`, {
    const effectText = scene.add.text(x, y + 80, `${card.text}`, {
      fontSize: "12px",
      color: "#00ff00",
      align: "center"
    }).setOrigin(0.5);
    //const body = this.add.text(x,y-20,card.text,{fontSize:12,wordWrap:{width:160}}).setOrigin(0.5);

    // „Ç´„Éº„Éâ„Çí„Åæ„Å®„ÇÅ„Å¶Ëøî„ÅôÔºàÂâäÈô§„ÇÑÁßªÂãï„Å´‰Ωø„Åà„Çã„Çà„ÅÜ„Å´Ôºâ
    return { cardBg, nameText, costText, effectText, image };
  }

  showBtn(scene, x, y, text, color, width=200,height=40){
    const Btn = scene.add.rectangle(x,y,width,height,color).setInteractive();
    const Txt = scene.add.text(x,y,text, {fontSize:16}).setOrigin(0.5);
    return {btn: Btn, txt: Txt};
  }
  showSomething(scene, text){
    const modal = scene.add.rectangle(600,360,700,420,0x000000,0.8).setDepth(10);
    const close = scene.add.rectangle(600,620,100,40,0xff7777).setInteractive().setDepth(11);
    const closeText = scene.add.text(600,620,'Èñâ„Åò„Çã',{fontSize:16}).setOrigin(0.5).setDepth(11);
    const Txt = scene.add.text(300,240,text, {fontSize:14}).setDepth(11);
    close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
  }
  showBtns(scene, deckFlag, diccardFlag, drawFlag, effFlag, waitEffFlag){
    if(deckFlag)    this.showDeckViewBtn(scene);
    if(diccardFlag) this.showDiscardpileViewBtn(scene);
    if(drawFlag)    this.showDrawpileViewBtn(scene);
    if(effFlag)     this.showEffectBtn(scene);
    if(waitEffFlag) this.showWaitEffectBtn(scene);
  }
  showDeckViewBtn(scene, x=1100, y=20){
    //const Btn = scene.add.rectangle(x,y,200,40,0x2dcc70).setInteractive();
    //scene.add.text(x,y,'„Éá„ÉÉ„Ç≠„ÇíË¶ã„Çã', {fontSize:16}).setOrigin(0.5);
    const Btn = this.showBtn(scene, x, y, '„Éá„ÉÉ„Ç≠„ÇíË¶ã„Çã', 0x2dcc70).btn;
    //Btn.on('pointerdown', ()=> this.showDeck(scene));
    Btn.on('pointerdown', ()=> this.showSomething(scene, `„Éá„ÉÉ„Ç≠:\n${this.player.deck.map(c=>c.name).join('\n')}\n\nÊâÄÊåÅ„Çµ„Éù„Éº„Éà:\n${this.player.relics.map(r=>r.name).join(', ')||'„Å™„Åó'}`));
  }
  /*
  showDeck(scene){
    const modal = scene.add.rectangle(600,360,700,420,0x000000,0.8).setDepth(10);
    const close = scene.add.rectangle(600,620,100,40,0xff7777).setInteractive().setDepth(11);
    const closeText = scene.add.text(600,620,'Èñâ„Åò„Çã',{fontSize:16}).setOrigin(0.5).setDepth(11);
    const Txt = scene.add.text(300,240,`„Éá„ÉÉ„Ç≠:\n${this.player.deck.map(c=>c.name).join('\n')}\n\nÊâÄÊåÅ„É¨„É™„ÉÉ„ÇØ:\n${this.player.relics.map(r=>r.name).join(', ')||'„Å™„Åó'}`, {fontSize:14}).setDepth(11);
    close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
  }
  */
  showDiscardpileViewBtn(scene, x=100, y=700){
    //const Btn = scene.add.rectangle(x,y,200,40,0xff0000).setInteractive();
    //scene.add.text(x,y,'Êç®„Å¶Êú≠„ÇíË¶ã„Çã', {fontSize:16}).setOrigin(0.5);
    const Btn = this.showBtn(scene, x, y, 'Êç®„Å¶Êú≠„ÇíË¶ã„Çã', 0xff0000).btn;
    Btn.on('pointerdown', ()=> this.showSomething(scene, `Êç®„Å¶Êú≠:\n${this.player.discard.map(c=>c.name).join('\n')}\n`));
    /*
    Btn.on('pointerdown', ()=> {
      const modal = scene.add.rectangle(600,360,700,420,0x000000,0.8).setDepth(10);
      const close = scene.add.rectangle(600,620,100,40,0xff7777).setInteractive().setDepth(11);
      const closeText = scene.add.text(600,620,'Èñâ„Åò„Çã',{fontSize:16}).setOrigin(0.5).setDepth(11);
      const Txt = scene.add.text(300,240,`Êç®„Å¶Êú≠:\n${this.player.discard.map(c=>c.name).join('\n')}\n`, {fontSize:14}).setDepth(11);
      close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
    });
    */
  }
  showDrawpileViewBtn(scene, x=1100, y=700){
    //const Btn = scene.add.rectangle(x,y,200,40,0x0070ff).setInteractive();
    //scene.add.text(x,y,'Â±±Êú≠„ÇíË¶ã„Çã', {fontSize:16}).setOrigin(0.5);
    const Btn = this.showBtn(scene, x, y, 'Â±±Êú≠„ÇíË¶ã„Çã', 0x0070ff).btn;
    Btn.on('pointerdown', ()=> this.showSomething(scene, `Â±±Êú≠:\n${this.player.drawPile.map(c=>c.name).join('\n')}\n`));
    /*
    Btn.on('pointerdown', ()=> {
      const modal = scene.add.rectangle(600,360,700,420,0x000000,0.8).setDepth(10);
      const close = scene.add.rectangle(600,620,100,40,0xff7777).setInteractive().setDepth(11);
      const closeText = scene.add.text(600,620,'Èñâ„Åò„Çã',{fontSize:16}).setOrigin(0.5).setDepth(11);
      const Txt = scene.add.text(300,240,`Â±±Êú≠:\n${this.player.drawPile.map(c=>c.name).join('\n')}\n`, {fontSize:14}).setDepth(11);
      close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
    });
    */
  }
  showEffectBtn(scene, x=1100, y=100){
    //const Btn = scene.add.rectangle(x,y,200,40,0xffff00).setInteractive();
    //scene.add.text(x,y,'„Åã„Åã„Å£„Å¶„ÅÑ„ÇãÂäπÊûú', {fontSize:16, color: "#88f"}).setOrigin(0.5);
    const Btn = this.showBtn(scene, x, y, '„Åã„Åã„Å£„Å¶„ÅÑ„ÇãÂäπÊûú', 0x66ff00).btn;
    Btn.on('pointerdown', ()=> this.showSomething(scene, `ÂäπÊûú:\n${this.player.applyEffect.map((c)=>`${c.card.name} √ó ${c.stack}`).join('\n')}\n`));
  }
  showWaitEffectBtn(scene, x=1100, y=160){
    const Btn = this.showBtn(scene, x, y, 'ÈÅ©Áî®ÂæÖ„Å°„ÅÆÂäπÊûú', 0xffcc00).btn;
    Btn.on('pointerdown', ()=> this.showSomething(scene, `ÈÅ©Áî®ÂæÖ„Å°„ÅÆÂäπÊûú:\n${this.player.applyEffectWaiting.map((c)=>`${c.card.name} : ÊÆã„Çä${c.leftTime}„Çø„Éº„É≥, „Åã„Åã„Å£„Å¶„Çã‰∫∫Êâã: ${c.card.cost.labor}`).join('\n')}\n`));
  }

  showPlayerStatusChangeST(scene, st){
    return this.showPlayerStatus(scene,30,10,18,st,this.formatMoney(),this.formatPassive());
  }
  showPlayerStatusChangeMT(scene, mt){
    return this.showPlayerStatus(scene,30,10,18,this.formatStatus(),mt,this.formatPassive());
  }
  showPlayerStatusChangePT(scene, pt){
    return this.showPlayerStatus(scene,30,10,18,this.formatStatus(),this.formatMoney(),pt);
  }
  showPlayerStatus(scene, x=30, y=10, pix=18, st=this.formatStatus(), mt=this.formatMoney(), pt=this.formatPassive()){
    /*
    const statusText = scene.add.text(30,600,`HP: ${RUN.player.hp}/${RUN.player.maxHp}    Ë≥áÈáë: ${RUN.player.gold}, ‰∫àÁÆó: ${RUN.budget}`, {fontSize:18});
    const passiveText = scene.add.text(30,620,`Ê©üÊùê„Éª„Çπ„Ç≠„É´: ${RUN.player.relics.map(r=>r.name).join(', ')||'„Å™„Åó'}`, {fontSize:14});
    */
    const statusText = scene.add.text(x,y,st, {fontSize:pix});
    const moneyText = scene.add.text(x,y+20,mt, {fontSize:pix});
    const passiveText = scene.add.text(x,y+40,pt, {fontSize:pix});
    return { statusText, moneyText, passiveText }
  }
  formatStatus(){
    const p = RUN.player;
    let txt;
    if(debugMode) txt = `HP: ${p.hp}  ‰∫∫Êâã: ${p.energy}/${p.maxEnergy}  Èò≤Âæ°Âäõ: ${p.defense}`;
    else txt = `HP: ${p.hp}  ‰∫∫Êâã: ${p.energy}/${p.maxEnergy}`;
    return txt;
  }
  formatMoney(){
    return `Ë≥áÈáë: ${RUN.player.gold}, ‰∫àÁÆó: ${RUN.budget}`;
  }
  formatPassive(){
    return   `Ê©üÊùê„Éª„Çπ„Ç≠„É´: ${RUN.player.relics.map(r=>r.name).join(', ')||'„Å™„Åó'}`;
  }
}

const RUN = new RunState();

/* ---------- Phaser Config ---------- */
const config = {
  type: Phaser.AUTO,
  width: 1200,
  height: 720,
  parent: 'game-container',
  backgroundColor: '#1a1a1a',
  scene: []
};

/* ---------- Scenes ---------- */

/* OpeningScene */
class OpeningScene extends Phaser.Scene {
  constructor(){ super({key:'OpeningScene'}); }
  preload(){
    //this.load.image("", "img/.png");
    /*
    this.load.image("pw", "img/pw.png");
    this.load.image("encrypt", "img/encrypt.png");
    this.load.image("fw", "img/.png");
    this.load.image("accesscntl", "img/accesscntl.png");
    this.load.image("av", "img/av.png");
    this.load.image("ips", "img/ips.png");
    this.load.image("ids", "img/ids.png");
    this.load.image("tls", "img/tls.png");
    this.load.image("backup", "img/backup.png");
    this.load.image("logmon", "img/logmon.png");
    this.load.image("patch", "img/patch.png");
    this.load.image("2fa", "img/2fa.png");
    this.load.image("sso", "img/sso.png");
    this.load.image("edr", "img/edr.png");
    this.load.image("ueba", "img/ueba.png");
    this.load.image("ndr", "img/ndr.png");
    this.load.image("cdn", "img/cdn.png");
    this.load.image("dynana", "img/dynana.png");
    this.load.image("staticana", "img/staticana.png");
    this.load.image("lock", "img/lock.png");
    this.load.image("antitheft", "img/antitheft.png");
    this.load.image("shred", "img/shred.png");
    this.load.image("destroy", "img/destroy.png");
    this.load.image("policy", "img/policy.png");
    this.load.image("team", "img/team.png");
    this.load.image("audit", "img/audit.png");
    this.load.image("threatintel", "img/threadintel.png");
    this.load.image("vulnscan", "img/vulnscan.png");
    this.load.image("redblue", "img/redblue.png");
    this.load.image("soc", "img/soc.png");
    this.load.image("dlp", "img/dlp.png");
    this.load.image("edu", "img/edu.png");
    this.load.image("manual", "img/manual.png");
    this.load.image("check", "img/check.png");
    this.load.image("prevent", "img/prevent.png");
    this.load.image("hunt", "img/hunt.png");
    */
    /*
    this.load.image("pw",           "");
    this.load.image("encrypt",      "");
    this.load.image("fw",           "data:image/png;base64,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");
    this.load.image("accesscntl",   "");
    this.load.image("av",           "");
    this.load.image("ips",          "");
    this.load.image("ids",          "");
    this.load.image("tls",          "");
    this.load.image("backup",       "");
    this.load.image("logmon",       "");
    this.load.image("patch",        "data:image/png;base64,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");
    this.load.image("2fa",          "");
    this.load.image("sso",          "");
    this.load.image("edr",          "");
    this.load.image("ueba",         "");
    this.load.image("ndr",          "");
    this.load.image("cdn",          "");
    this.load.image("dynana",       "");
    this.load.image("staticana",    "");
    this.load.image("lock",         "");
    this.load.image("antitheft",    "");
    this.load.image("shred",        "");
    this.load.image("destroy",      "");
    this.load.image("policy",       "");
    this.load.image("team",         "");
    this.load.image("audit",        "data:image/png;base64,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");
    this.load.image("threatintel",  "");
    this.load.image("vulnscan",     "");
    this.load.image("redblue",      "");
    this.load.image("soc",          "");
    this.load.image("dlp",          "");
    this.load.image("edu",          "");
    this.load.image("manual",       "");
    this.load.image("check",        "");
    this.load.image("prevent",      "");
    this.load.image("hunt",         "");
    */
  }
  create(){
    const BASE64_IMAGES = {
      fw:     "data:image/png;base64,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",
      patch:  "data:image/png;base64,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",
      audit:  "data:image/png;base64,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"
    };
    const keys = Object.keys(BASE64_IMAGES);
    let loadedCount = 0;
    //const img = new Image();
    keys.forEach(key => {
      const img = new Image();
      img.onload = () => {
        this.textures.addImage(key, img); // Phaser„Å´ÁôªÈå≤
        loadedCount++;

        // ÂÖ®ÈÉ®ÁµÇ„Çè„Å£„Åü„ÇâÊ¨°„ÅÆ„Ç∑„Éº„É≥„Å∏
        if (loadedCount === keys.length) {
          console.log("All Base64 images loaded!");
          const startBtn = this.add.rectangle(600,360,300,70,0x2d8cff).setInteractive();
          const startText = this.add.text(600,360,'„Ç≤„Éº„É†ÈñãÂßã', {fontSize:24}).setOrigin(0.5);
          startBtn.on('pointerdown', ()=>{
            this.scene.start('MapScene');
          });
        }
      };
      img.src = BASE64_IMAGES[key];
    });


    RUN.resetAll();
    this.add.text(600,120,'Security Card Defense', {fontSize:36}).setOrigin(0.5);
    this.add.text(600,180,'„ÅÇ„Å™„Åü„ÅØ‰∏≠Â∞è‰ºÅÊ•≠„ÅÆÊñ∞Á±≥„Çª„Ç≠„É•„É™„ÉÜ„Ç£„Éû„Éç„Éº„Ç∏„É£„Éº„ÄÇ‰∏ÄÂÆöÊúüÈñì„ÇíËá™Á§æ„ÇíÂÆà„ÇäÂàá„ÇåÔºÅ', {fontSize:20}).setOrigin(0.5);

    RUN.player.deck = [];
    // start with basic cards
    /*
    for(let i=0;i<4;i++) RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[0]))); // firewall
    for(let i=0;i<4;i++) RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[1]))); // patch
    RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[3]))); // monitor
    */
    for(let i=0;i<3;i++) RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[2]))); // firewall
    for(let i=0;i<3;i++) RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[10]))); // patch
    RUN.player.deck.push(JSON.parse(JSON.stringify(CARD_TEMPLATES[25]))); // audit
    // shuffle and init map
    RUN.player.discard = [];
    RUN.player.drawPile = Util.shuffle(RUN.player.deck.slice());

    /*
    const startBtn = this.add.rectangle(600,360,300,70,0x2d8cff).setInteractive();
    const startText = this.add.text(600,360,'„Ç≤„Éº„É†ÈñãÂßã', {fontSize:24}).setOrigin(0.5);
    startBtn.on('pointerdown', ()=>{
      // prepare starting deck
      this.scene.start('MapScene');
    });
    */
    if(debugMode){
      // show sample run info
      this.add.text(60,560,'‰ªïÊßò„É°„É¢Ôºà„Éó„É≠„Éà„Çø„Ç§„ÉóÔºâ', {fontSize:14});
      this.add.text(60,590,'- 3Á®ÆÈ°û„Ç®„Éä„Ç∏„Éº: ÈáëÈä≠/Âä¥ÂÉçÂäõ/ÊôÇÈñì', {fontSize:12});
      this.add.text(60,610,'- 10„Çπ„ÉÜ„Éº„Ç∏ „Éû„ÉÉ„ÉóÁîüÊàê -> ÈÅ∏Êäû -> „Ç§„Éô„É≥„Éà/Êïµ/‰ºëÊÜ©Á≠â', {fontSize:12});
    }

  }
}

/* MapScene */
class MapScene extends Phaser.Scene {
  //*
  constructor(){ super({key:'MapScene'}); }
  create(){
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    //RUN.showEffectBtn(this);
    this.cameras.main.setBackgroundColor('#121212');
    this.add.text(30,100,'„Éû„ÉÉ„Éó', {fontSize:28});
    // If map not generated, generate
    if(RUN.map.length===0) this.generateMap();
    this.drawMap();
    if(debugMode) this.drawDebugMap();
  }

  generateMap(){
    // 10 stages: index 1..10 (we store 0..9)
    const nodes = [];
    for(let i=0;i<10;i++){
      let kind = 'enemy';
      let confirmed = false;
      if(i===0) kind='enemy', confirmed=true;
      else if(i===4) kind='chest', confirmed=true;
      //else if(i===9) kind='boss', confirmed=true;
      else if(i===9) kind='chest', confirmed=true;
      else kind = 'unknown';
      nodes.push({index:i+1, kind:kind, chosen:false, confirmed: confirmed});
    }
    RUN.map = nodes;
    RUN.debugMap[0] = {index:0, kind:'enemy', chosen:false, confirmed:true};
    RUN.debugMap[1] = {index:0, kind:'elite', chosen:false, confirmed:true};
    RUN.debugMap[2] = {index:0, kind:'rest', chosen:false, confirmed:true};
    RUN.debugMap[3] = {index:0, kind:'chest', chosen:false, confirmed:true};
    RUN.debugMap[4] = {index:0, kind:'shop', chosen:false, confirmed:true};
    RUN.debugMap[5] = {index:0, kind:'event', chosen:false, confirmed:true};
    RUN.debugMap[6] = {index:0, kind:'boss', chosen:false, confirmed:true};
    //return nodes;
  }
  drawMap(){
    const baseX = 120;
    const baseY = 250;
    const edge = 150;
    const gap = edge * 1.2;
    //const baseX = 100;
    //const baseY = 200;
    //const edge = 80;
    //const gap = 90;
    // show nodes in a row; if too many, allow paging (simple)
    const viewStart = 0;
    for(let i=0;i<RUN.map.length;i++){
      const node = RUN.map[i];
      const x = baseX + (i%(RUN.map.length/2))*gap;
      if(i != RUN.stageIndex){
        const y = baseY + (Math.floor(i/(RUN.map.length/2)) * gap);
        const rect = this.add.rectangle(x, y, edge, edge, node.chosen?0x4444ff:0x333333).setStrokeStyle(2, 0xffffff);
        const t = this.add.text(x, y-8, `„Çπ„ÉÜ„Éº„Ç∏${node.index}`, {fontSize:16}).setOrigin(0.5);
        //const k = this.add.text(x, y+12, `${node.kind}`, {fontSize:12}).setOrigin(0.5);
      } else {
        let selectable;
        if(node.confirmed){
          selectable = 1;
        }else{
          selectable = RUN.mapOptions;
        }
        for(let j=0;j<selectable;j++){
          let y = baseY;
          if(selectable != 1) y = baseY + j*gap/selectable - gap/selectable/selectable;
          const rect = this.add.rectangle(x, y, edge, edge/selectable, node.chosen?0x4444ff:0x333333).setStrokeStyle(2, 0xffffff).setInteractive();
          const t = this.add.text(x, y-8, `„Çπ„ÉÜ„Éº„Ç∏${node.index}`, {fontSize:16}).setOrigin(0.5);
          let kind = node.kind;
          //let kind = node.kind;
          if(node.kind == 'unknown'){
            kind = ['rest','event'][j];
            /*
            if(i>=5) {
              // 6-9 random from elite, rest, chest, shop, event
              kind = Util.randChoice(['elite','rest','chest','shop','event']);
            } else {
              kind = Util.randChoice(['enemy','rest','chest','shop','event']);
            }  
            //*/
          }
          //const k = this.add.text(x, y+12, `${node.kind}`, {fontSize:12}).setOrigin(0.5);
          if(!node.confirmed) this.add.text(x, y+12, `${kind}`, {fontSize:12}).setOrigin(0.5);
          rect.on('pointerdown', ()=>{
            node.chosen = true;
            RUN.stageIndex = node.index;
            node.kind = kind;
            node.confirmed = true;
            // go to correct scene
            if(node.kind==='enemy') startBattle(this, false);
            else if(node.kind==='elite') startBattle(this, true);
            else if(node.kind==='boss') startBattle(this,'boss');
            else if(node.kind==='rest') this.scene.start('RestScene');
            else if(node.kind==='chest') this.scene.start('ChestScene');
            else if(node.kind==='shop') this.scene.start('ShopScene');
            else if(node.kind==='event') this.scene.start('EventScene');
          });
        }
      }
    }
    // legend
    if(debugMode) this.add.text(800,110,'‰ºùË™¨: Êïµ/„Ç®„É™„Éº„Éà/„Éú„Çπ/‰ºëÊÜ©/ÂÆùÁÆ±/„Ç∑„Éß„ÉÉ„Éó/„Ç§„Éô„É≥„Éà', {fontSize:12});
    this.add.text(800,50,'Èùí„ÅåÈÅ∏ÊäûÊ∏à', {fontSize:12}).setColor('#88f');
    // show remaining count
    const remaining = RUN.map.filter(n=>!n.chosen).length;
    this.add.text(800,80,`ÊÆã„Çä„Çπ„ÉÜ„Éº„Ç∏: ${remaining}`, {fontSize:14});
  }
  drawDebugMap(){
    this.add.text(30,550,'„Éá„Éê„ÉÉ„Ç∞Áî®„Éû„ÉÉ„Éó', {fontSize:28});
    const baseX = 100;
    const baseY = 650;
    const gap = 90;
    // show nodes in a row; if too many, allow paging (simple)
    for(let i=0;i<RUN.debugMap.length;i++){
      const node = RUN.debugMap[i];
      const x = baseX + i*gap;
      const y = baseY;
      const rect = this.add.rectangle(x, y, 80, 80, node.chosen?0x4444ff:0x333333).setStrokeStyle(2, 0xffffff).setInteractive();
      const t = this.add.text(x, y-8, `${node.index}`, {fontSize:16}).setOrigin(0.5);
      const k = this.add.text(x, y+12, `${node.kind}`, {fontSize:12}).setOrigin(0.5);
      rect.on('pointerdown', ()=>{
        //if(node.chosen) return; // already passed
        node.chosen = true;
        node.confirmed = true;
        // go to correct scene
        if(node.kind==='enemy') startBattle(this, false);
        else if(node.kind==='elite') startBattle(this, true);
        else if(node.kind==='boss') startBattle(this, 'boss');
        else if(node.kind==='rest') this.scene.start('RestScene');
        else if(node.kind==='chest') this.scene.start('ChestScene');
        else if(node.kind==='shop') this.scene.start('ShopScene');
        else if(node.kind==='event') this.scene.start('EventScene');
        });
    }
  }
}

/* BattleScene */
class BattleScene extends Phaser.Scene {
  constructor(){ super({key:'BattleScene'}); }
  init(data){
    this.elite = data.elite;
  }
  create(){
    RUN.showBtns(this,true,true,true,true,false);
    //RUN.showDeckViewBtn(this);
    //RUN.showDiscardpileViewBtn(this);
    //RUN.showDrawpileViewBtn(this);    
    this.turn = 'player';
    this.countTurn = 0;
    this.turnText = this.add.text(600,40,'Turn 1', {fontSize:18}).setOrigin(0.5);
    this.messageText = this.add.text(600,60,'', {fontSize:18}).setOrigin(0.5);
    // Display player info area
    this.playerInfo = this.add.text(30,30,this.formatPlayer(), {fontSize:16});
    // Enemy info
    if(debugMode) this.enemyInfo = this.add.text(880,30,this.formatEnemy(), {fontSize:16});
    if(RUN.automationFlag){
      this.delayApplyEffects();
      RUN.automationFlag = false;
    }
    // card area
    this.cardGroup = this.add.group();
    this.applyWaitsGroup = this.add.group();
    // utility buttons
    const endBtn = this.add.rectangle(600,630,140,50,0xff9933).setInteractive();
    this.add.text(600,630,'Ê¨°„ÅÆ„Çø„Éº„É≥„Å∏', {fontSize:18}).setOrigin(0.5);
    endBtn.on('pointerdown', ()=> this.endTurn());
    // draw and start
    this.startPlayerTurn();
  }

  formatPlayer(){
    const p = RUN.player;
    if(debugMode) return `„Éó„É¨„Ç§„É§\nHP:${p.hp} Èö†„ÇåHP:${p.hiddenHp} def:${p.defense}\n‰∫∫Êâã:${p.energy}/${p.maxEnergy}\nË≥áÈáë:${RUN.player.gold}`;
    else return `„Éó„É¨„Ç§„É§\nHP:${p.hp}\n‰∫∫Êâã:${p.energy}/${p.maxEnergy}\nË≥áÈáë:${RUN.player.gold}`; 
    //return `„Éó„É¨„Ç§„É§\nHP:${p.hp}\nÈò≤Âæ°:${p.defense}\n‰∫∫Êâã:${p.energy}/${p.maxEnergy}\nË≥áÈáë:${RUN.player.gold}`;
  }
  formatEnemy(){
    const e = RUN.currentEnemy;
    return `Êïµ: ${e.name}\nHP:${e.hp} DEF:${e.def}\nÊ¨°: ${e.intent} ${e.intentValue}`;
  }

  startPlayerTurn(){
    this.turn='player';
    this.turnText.setText(`Turn ${++this.countTurn}`);
    this.messageText.setText('„ÅÇ„Å™„Åü„ÅÆ„Çø„Éº„É≥');
    // reset player defense to 0 per spec
    //RUN.player.defense = 0;
    // recover energy to max
    /*
    // delay apply effect
    this.delayApplyEffects();
    */
    // draw 5 cards
    this.hand = [];

    if(this.countTurn != 1){
      if(this.incidentFlag){
        this.happenIncident();
      }else{
        this.eventFlag = Util.randChoice([false,false,false,'c','a']);
        if(this.eventFlag == 'a'){
          this.happenAccident();
        }else if (this.eventFlag == 'c'){
          this.happenCustomerOrder();
        }
      }
    }

    for(let i=this.hand.length;i<RUN.player.drawcards;i++) this.drawCard();
    this.renderHand();
    this.updateInfo();
    this.renderApplyWaits();
  }

  drawCard(){
    if(RUN.player.drawPile.length===0){
      // shuffle discard into draw if available
      RUN.player.drawPile = Util.shuffle(RUN.player.discard.slice());
      RUN.player.discard = [];
    }
    if(RUN.player.drawPile.length===0) return; // no cards
    const card = RUN.player.drawPile.pop();
    this.hand.push(card);
  }

  renderHand(){
    // clear previous
    this.cardGroup.clear(true,true);
    const startX = 200;
    const y = 480;
    for(let i=0;i<this.hand.length;i++){
      const card = this.hand[i];
      const x = startX + i*200;
      const re = RUN.renderCard(this, x, y, 180, 260, card);
      const box = re.cardBg;
      this.cardGroup.addMultiple([box,re.nameText,re.costText,re.effectText,re.image]);
      box.setInteractive();
      box.on('pointerdown', ()=> this.playCard(card, i));
    }
  }

  playCard(card, index){
    // check cost
    const p = RUN.player;
    //if((e.money < (card.cost.money||0)) || (e.labor < (card.cost.labor||0)) || (e.time < (card.cost.time||0))){
    if((p.gold < (card.cost.money||0)) || (p.energy < card.cost.labor || 0) ){
      this.messageText.setText('„Ç≥„Çπ„Éà‰∏çË∂≥„Åß‰ΩøÁî®„Åß„Åç„Åæ„Åõ„Çì');
      return;
    }
    // pay cost
    p.energy -= card.cost.labor;
    p.gold -= card.cost.money;
    /*
    e.money -= (card.cost.money||0);
    e.labor -= (card.cost.labor||0);
    e.time -= (card.cost.time||0);
    */
    // delay apply effect
    RUN.player.applyEffectWaiting.push({leftTime: card.cost.time, card: card});
    /*
    if(card.cost.time > 0){
      RUN.player.applyEffectWaiting.push({leftTime: card.cost.time, card: card});
    }else{
      p.energy += card.cost.labor;
      this.applyEffect(card);
    }
    */
    // move card to discard
    RUN.player.discard.push(card);
    // remove from hand
    this.hand.splice(index,1);
    this.renderHand();
    this.updateInfo();
    this.renderApplyWaits();

    // check enemy death
    if(RUN.currentEnemy.hp <= 0){
      this.onEnemyDefeated();
    }
  }

  endTurn(){
    // delay apply effect
    this.delayApplyEffects();
    this.renderApplyWaits();
    // discard all hand
    for(const c of this.hand){
      if(c.must){
        this.messageText.setText('ÂØæÂøú„Åô„Åπ„Åç‰∫ãÊüÑ„ÅåÂØæÂá¶„Åï„Çå„Å™„Åã„Å£„Åü.‰ø°È†ºÊêçÂ§±ÔºàHP-20Ôºâ');
      }
      if(c.instant != true){
        RUN.player.discard.push(c);
      }
    } 
    this.hand = [];
    this.renderHand();
    this.updateInfo();
    // enemy turn
    // this.scene.pause();
    this.enemyTurn();
  }

  enemyTurn(){
    const e = RUN.currentEnemy;
    // reset enemy defense to 0
    e.def = Math.max(0, e.def);
    // apply intent
    if(debugMode) this.messageText.setText(`Êïµ„ÅÆ„Çø„Éº„É≥: ${e.name} „Åå ${e.intent} „ÇíÂÆüË°å`);
    if(e.intent === 'attack' && e.hp > 0){
      let dmg = e.intentValue;
      // check player defense
      if(dmg <= RUN.player.defense){
        RUN.player.defense -= dmg;
      } else {
        const over = dmg - RUN.player.defense;
        RUN.player.defense = 0;
        RUN.player.hiddenHp -= over;
      }
    }
    // simulate enemy taking any DOT? (simplified) -> we'll deduct small decay
    /*
    if(e.tags.includes('recon')){
      // recon applies weak DOT to itself: simulate "time" reduces attacker persistence
      e.hp -= 2;
    }
    //*/
    // compute next intent (random small)
    e.intentValue = Math.max(3, e.intentValue + Util.randChoice([-2,0,1]));
    if(e.hp >= 0){
      e.intent = Util.randChoice(['attack','attack','attack','weaken']); // bias attack
    }else{
      e.intent = 'nothing';
    }
    // if next is weaken, intentValue reduces player's max energy next turn? We'll show as hint
    e.intentDisplay = e.intent;
    // check player death
    if(RUN.player.hp <= 0){
      this.scene.start('GameOverScene');
      return;
    }
    if(RUN.player.hiddenHp <= 0){
      this.incidentFlag = true;
      RUN.player.hiddenHp = RUN.player.maxHiddenHp;
    }
    // after enemy turn, show updated info, delay and resume player
    if(debugMode) this.enemyInfo.setText(this.formatEnemy());
    this.playerInfo.setText(this.formatPlayer());
    this.time.delayedCall(1000, ()=> {
      // proceed to next player turn
      this.scene.resume();
      // if enemy still alive, start player turn
      /*
      if(RUN.currentEnemy.hp>0) this.startPlayerTurn();
      else this.onEnemyDefeated();
      */
      if(this.countTurn > 3) this.onEnemyDefeated();
      else this.startPlayerTurn();
    });
  }

  updateInfo(){
    this.playerInfo.setText(this.formatPlayer());
    if(debugMode) this.enemyInfo.setText(this.formatEnemy());
  }

  onEnemyDefeated(){
    // reward for non-boss
    const isBoss = (this.elite === 'boss');
    if(isBoss){
      // victory -> go to GameOver as win
      RUN.playTime = (Date.now() - RUN.startTimestamp)/1000;
      this.scene.start('GameOverScene', {victory:true});
      return;
    }
    /*
    // grant gold: simple formula
    const gained = Math.floor(10 + (this.elite?10:0) + Math.random()*10);
    RUN.player.gold += gained;
    */
    // put remaining discard/draw into RUN.player.discard
    RUN.player.discard = RUN.player.discard.concat(this.hand || []);
    // clear currentEnemy
    delete RUN.currentEnemy;
    // go to reward scene
    //this.scene.start('RewardScene', {gold:gained});
    this.scene.start('RewardScene');
  }

  delayApplyEffects(){
    for(let i=0; i<RUN.player.applyEffectWaiting.length; i++){
      const duel = RUN.player.applyEffectWaiting[i];
      if(duel.leftTime <= 0){
        if(duel.card.must != true){
          this.applyEffect(duel.card);
        }
        /*
        else if(dual.card.id == 'incident'){
        }else if(dual.card.id == 'accident'){
        }else if(dual.card.id == 'customer'){         
        }
        */
        RUN.player.energy += duel.card.cost.labor;
        RUN.player.applyEffectWaiting.splice(i, 1);
        i--;
      }
      duel.leftTime--;
    }
  }
  applyEffect(card){
    const find = RUN.player.applyEffect.find(e => e.id === card.id)
    if(find === undefined){
      RUN.player.applyEffect.push({id: card.id, card: card, stack: 1});
    }else{
      find.stack++;;
    }

    // apply effects (simplified)
    // defense
    if(card.defense){
      let defGain = card.defense;
      // relic synergy: network_expert doubles network synergy defense
      if(card.synergy === 'network' && RUN.relicIds.has('network_expert')) defGain = Math.floor(defGain*1.5);
      RUN.player.defense += defGain;
    }
    // damage to enemy
    if(card.damageToVuln){
      // check enemy def first
      let dmg = card.damageToVuln;
      // if enemy has defense reduce
      const eDef = RUN.currentEnemy.def;
      if(dmg <= eDef){
        // reduce enemy def
        RUN.currentEnemy.def -= dmg;
      } else {
        const over = dmg - RUN.currentEnemy.def;
        RUN.currentEnemy.def = 0;
        RUN.currentEnemy.hp -= over;
      }
    }
    // heal
    if(card.heal){
      RUN.player.hp = RUN.player.hp + card.heal;
    }
    // draw
    if(card.draw){
      for(let i=0;i<card.draw;i++) this.drawCard();
    }
    // buff enemy or debuff
    if(card.debuffEnemy){
      RUN.currentEnemy.def = Math.max(0, RUN.currentEnemy.def - card.debuffEnemy);
    }
    if(card.buffDefense){
      RUN.player.defense += card.buffDefense;
    }
  }
  renderApplyWaits(){
    // clear previous
    const applyWaits = RUN.player.applyEffectWaiting;
    this.applyWaitsGroup.clear(true,true);
    const mid = 600, edge = 100;
    const startX = mid - (applyWaits.length-1) * edge/2;
    const y = 200;
    for(let i=0;i<applyWaits.length;i++){
      const leftTime = applyWaits[i].leftTime;
      const card = applyWaits[i].card;
      const x = startX + i* 100;

      let timeText;
      if(leftTime>0){
        timeText = this.add.text(x, y-70, `ÈÅ©Âøú„Åæ„ÅßÊÆã„Çä\n${leftTime}„Çø„Éº„É≥`, {
          fontSize: "12px",
          color: "#ffffff",
          align: "center",
        }).setOrigin(0.5);  
      }else{
        timeText = this.add.text(x, y-70, `„Åì„ÅÆ„Çø„Éº„É≥\nÈÅ©Áî®`, {
          fontSize: "12px",
          color: "#ffffff",
          align: "center",
        }).setOrigin(0.5);  
      }
      
      const waitBg = this.add.rectangle(x, y, edge, edge, 0x333333).setOrigin(0.5);
      waitBg.setStrokeStyle(2, 0xffffff);

      // „Ç´„Éº„ÉâÂêç
      const nameText = this.add.text(x, y - 20, card.name, {
        fontSize: "10px",
        color: "#ffffff",
        align: "center",
        wordWrap: { width: 90 }
      }).setOrigin(0.5);
      // „Ç≥„Çπ„ÉàË°®Á§∫
      const costText = this.add.text(x, y, `üí∞${card.cost.money} üë•${card.cost.labor} ‚è±${card.cost.time}`, {
        fontSize: "8px",
        color: "#ffcc00",
        align: "center"
      }).setOrigin(0.5);
      // ÂäπÊûúË™¨Êòé
      const effectText = this.add.text(x, y + 20, `${card.text}`, {
        fontSize: "8px",
        color: "#00ff00",
        align: "center"
      }).setOrigin(0.5);
      //const body = this.add.text(x,y-20,card.text,{fontSize:12,wordWrap:{width:160}}).setOrigin(0.5);

      //const re = RUN.renderCard(this, x, y, 180, 260, card);
      this.applyWaitsGroup.addMultiple([timeText,waitBg,nameText,costText,effectText]);
      //box.setInteractive();
      //box.on('pointerdown', ()=> this.playCard(card, i));
    }
  }
  happenIncident(){
    this.messageText.setText('„Ç§„É≥„Ç∑„Éá„É≥„Éà„ÅåÁô∫ÁîüÔºÅÁ§æ‰ºöÁöÑ‰ø°È†º„Åå‰Ωé‰∏ã(HP-40).ÂØæÂøú„ÅåÊ±Ç„ÇÅ„Çâ„Çå„Çã');
    RUN.player.hp -= 40;
    //RUN.player.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[0])));
    this.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[0])));
  }
  happenAccident(){
    this.messageText.setText('ÈöúÂÆ≥„ÅåÁô∫ÁîüÔºÅÁ§æ‰ºöÁöÑ‰ø°È†º„Åå‰Ωé‰∏ã(HP-20).ÂØæÂøú„ÅåÊ±Ç„ÇÅ„Çâ„Çå„Çã');
    RUN.player.hp -= 20;
    //RUN.player.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[1])));
    this.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[1])));
  }
  happenCustomerOrder(){
    this.messageText.setText('È°ßÂÆ¢„Åã„Çâ„ÅÆ„Ç™„Éº„ÉÄ„Éº„ÅåÁô∫Áîü.ÂØæÂøú„ÅåÊ±Ç„ÇÅ„Çâ„Çå„Çã');
    //RUN.player.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[3])));    
    this.hand.push(JSON.parse(JSON.stringify(EVENT_CARD_TEMPLATES[3])));    
  }
}

/* RewardScene */
class RewardScene extends Phaser.Scene {
  constructor(){ super({key:'RewardScene'}); }
  init(data){ this.gained = data.gold || 0; }
  create(){
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.selectCardGroup = this.add.group();
    this.selectCardGroup.clear(true,true);
    this.add.text(600,80,'Ê•≠ÂãôÈÅÇË°åÔºÅ\n Áç≤Âæó„Åô„ÇãÊäÄË°ì„ÇÑÊ©üËÉΩ', {fontSize:26}).setOrigin(0.5);
    //this.add.text(600,120,`‰∫àÁÆó +${this.gained}`, {fontSize:18}).setOrigin(0.5);
    // show 3 random cards to choose from
    const choices = Util.shuffle(CARD_TEMPLATES).slice(0,3).map(c => JSON.parse(JSON.stringify(c)));
    const selectCardText = this.add.text(450,200,'„Ç´„Éº„Éâ„ÇíÈÅ∏Êäû„Åó„Å¶„Éá„ÉÉ„Ç≠„Å´ËøΩÂä†', {fontSize:18});
    this.selectCardGroup.add(selectCardText)
    for(let i=0;i<choices.length;i++){
      const c = choices[i];
      const x = 300 + i*300;
      const card = RUN.renderCard(this, x, 350, 200, 240, c);
      const box = card.cardBg;
      this.selectCardGroup.addMultiple([box,card.nameText,card.costText,card.effectText,card.image]);
      box.setInteractive();
      box.on('pointerdown', ()=>{
        RUN.player.deck.push(c);
        //this.finishRewards();
        this.selectRelics();
      });
    }
    // skip button
    /*
    const skip = this.add.rectangle(600,520,160,50,0x666666).setInteractive();
    const skipText = this.add.text(600,520,'„Çπ„Ç≠„ÉÉ„Éó', {fontSize:18}).setOrigin(0.5);
    */
    const skip = this.add.rectangle(600,560,160,50,0x666666).setInteractive();
    const skipText = this.add.text(600,560,'„Çπ„Ç≠„ÉÉ„Éó', {fontSize:18}).setOrigin(0.5);
    skip.on('pointerdown', ()=> this.selectRelics());
    this.selectCardGroup.addMultiple([skip,skipText]);
  }

  selectRelics(){
    this.selectCardGroup.clear(true,true);
    // Next: relic selection (unowned)
    this.relicChoices = Util.shuffle(RELIC_TEMPLATES.filter(r=>!RUN.relicIds.has(r.id))).slice(0,3);
    this.relicTexts = [];
    this.add.text(450,200,'Ê•≠Âãô„Å´ÂΩπÁ´ã„Å§„ÇÇ„ÅÆ„Çí1„Å§ÈÅ∏ÊäûÔºà„Åæ„Åü„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ', {fontSize:18});
    for(let i=0;i<this.relicChoices.length;i++){
      const r = this.relicChoices[i];
      const x = 300 + i*300;
      const box = this.add.rectangle(x,360,240,120,0x222222).setStrokeStyle(2,0xffffff).setInteractive();
      this.add.text(x-100,340,r.name,{fontSize:14}).setOrigin(0);
      this.add.text(x,380,r.desc,{fontSize:12,wordWrap:{width:200}}).setOrigin(0.5);
      box.on('pointerdown', ()=> {
        RUN.applyRelic(r);
        this.finishRewards();
      });
    }
    // skip relic
    /*
    const skipRel = this.add.rectangle(600,620,160,40,0x444444).setInteractive();
    this.add.text(600,620,'„É¨„É™„ÉÉ„ÇØ„ÇíÂèñ„Çâ„Å™„ÅÑ', {fontSize:14}).setOrigin(0.5);
    */
    const skipRel = this.add.rectangle(600,560,160,40,0x444444).setInteractive();
    this.add.text(600,560,'„Çπ„Ç≠„ÉÉ„Éó', {fontSize:14}).setOrigin(0.5);
    skipRel.on('pointerdown', ()=> this.finishRewards());
  }

  finishRewards(){
    this.scene.start('MapScene');
  }
}

/* ChestScene */
class ChestScene extends Phaser.Scene {
  constructor(){ super({key:'ChestScene'}); }
  create(){
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.add.text(600,80,'ÁâπÂà•ÊâãÂΩìÔºÅ', {fontSize:28}).setOrigin(0.5);
    const goldGain = Math.floor(10 + Math.random()*30);
    RUN.player.gold += goldGain;
    this.add.text(600,120,`Ë≥áÈáë +${goldGain}`, {fontSize:18}).setOrigin(0.5);
    // relics choices
    const relics = Util.shuffle(RELIC_TEMPLATES.filter(r=>!RUN.relicIds.has(r.id))).slice(0,3);
    this.add.text(450,200,'Ê•≠Âãô„Å´ÂΩπÁ´ã„Å§„ÇÇ„ÅÆ„Çí1„Å§ÈÅ∏ÊäûÔºà„Åæ„Åü„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ', {fontSize:18});
    for(let i=0;i<relics.length;i++){
      const r = relics[i];
      const x = 300 + i*300;
      const box = this.add.rectangle(x,360,240,140,0x222222).setStrokeStyle(2,0xffffff).setInteractive();
      this.add.text(x-100,360,r.name,{fontSize:14}).setOrigin(0);
      this.add.text(x,340,r.desc,{fontSize:12,wordWrap:{width:200}}).setOrigin(0.5);
      box.on('pointerdown', ()=> {
        RUN.applyRelic(r);
        this.scene.start('MapScene');
      });
    }
    const skip = this.add.rectangle(600,560,160,40,0x666666).setInteractive();
    this.add.text(600,560,'„Çπ„Ç≠„ÉÉ„Éó', {fontSize:16}).setOrigin(0.5);
    //skip.on('pointerdown', ()=> this.scene.start('MapScene'));
    skip.on('pointerdown', ()=> this.scene.start('ShopScene'));
  }
}

/* RestScene */
class RestScene extends Phaser.Scene {
  constructor(){ super({key:'RestScene'}); }
  create(){    
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.add.text(600,120,'‰ºëÊÜ©', {fontSize:28}).setOrigin(0.5);
    // three choices: rest(heal), upgrade(random card), skip
    const restBtn = this.add.rectangle(300,320,240,100,0x77cc77).setInteractive();
    this.add.text(300,320,'‰ºëÊÅØ: ‰ΩìÂäõÂõûÂæ©', {fontSize:18}).setOrigin(0.5);
    restBtn.on('pointerdown', ()=> {
      RUN.player.hp = RUN.player.hp + 20;
      this.endRestScene();
    });

    const upgradeBtn = this.add.rectangle(600,320,240,100,0x7799ff).setInteractive();
    this.add.text(600,320,'ÊîπËâØ: „Éá„ÉÉ„Ç≠„ÅÆÊñΩÁ≠ñÂº∑Âåñ', {fontSize:18}).setOrigin(0.5);
    upgradeBtn.on('pointerdown', ()=> {
      if(RUN.player.deck.length===0) { this.scene.start('MapScene'); return; }
      const toUpgrade = Util.randChoice(RUN.player.deck);
      // simple upgrade: increase defense/heal/damage by 50%
      if(toUpgrade.defense) toUpgrade.defense = Math.ceil(toUpgrade.defense*1.5);
      if(toUpgrade.heal) toUpgrade.heal = Math.ceil(toUpgrade.heal*1.5);
      if(toUpgrade.damageToVuln) toUpgrade.damageToVuln = Math.ceil(toUpgrade.damageToVuln*1.5);
      toUpgrade.name = toUpgrade.name+"+";
      this.add.text(600,430,`ÊîπËâØÔºö ${toUpgrade.name} „ÇíÂæó„Åü`, {fontSize:14});
      this.time.delayedCall(1000, ()=> this.endRestScene());
    });

    const skipBtn = this.add.rectangle(900,320,240,100,0x666666).setInteractive();
    this.add.text(900,320,'„Çπ„Ç≠„ÉÉ„Éó', {fontSize:18}).setOrigin(0.5);
    //skipBtn.on('pointerdown', ()=> this.scene.start('MapScene'));
    skipBtn.on('pointerdown', ()=> this.endRestScene());
  }
  endRestScene(){
    this.scene.start('ShopScene');
  }
}

/* ShopScene */
class ShopScene extends Phaser.Scene {
  constructor(){ super({key:'ShopScene'}); }
  create(){
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.add.text(600,80,'„Ç∑„Éß„ÉÉ„Éó', {fontSize:28}).setOrigin(0.5);
    RUN.player.gold += RUN.budget;
    //RUN.showPlayerStatus(this);
    //this.goldText = this.add.text(80,120,`Ë≥áÈáë: ${RUN.player.gold} (‰∫àÁÆóÁç≤Âæó: +${RUN.budget})`, {fontSize:18});
    this.goldText = RUN.showPlayerStatusChangeMT(this, `Ë≥áÈáë: ${RUN.player.gold} (‰∫àÁÆóÁç≤Âæó: +${RUN.budget})`).moneyText;
    // items: 5 random cards, 3 relics, delete card option(1)
    const cardOffers = Util.shuffle(CARD_TEMPLATES).slice(0,5).map(c=>({card:JSON.parse(JSON.stringify(c)), price: Math.floor(5 + Math.random()*8)}));
    //const cardOffers = Util.shuffle(CARD_TEMPLATES).slice(0,5);
    for(let i=0;i<cardOffers.length;i++){
      const o = cardOffers[i];
      const x = 120 + i*200;
      //const box = RUN.renderCard(this, x, 260, 180, 140, o).cardBg;
      const box = RUN.renderCard(this, x, 260, 180, 200, o.card).cardBg;
      //this.add.text(x+70,230,`¬•${o.price}`,{fontSize:12}).setOrigin(1,0);
      this.add.text(x + 80,170,`¬•${o.price}`,{fontSize:12}).setOrigin(1,0);
      box.setInteractive();
      box.on('pointerdown', ()=>{
        if(RUN.player.gold < o.price) return;
        RUN.player.gold -= o.price;
        this.goldText.setText(`Ë≥áÈáë: ${RUN.player.gold}`, {fontSize:18});
        RUN.player.deck.push(o.card);
        box.fillColor = 0x444444;
      });
    }
    // relic offers
    const relicOffers = Util.shuffle(RELIC_TEMPLATES.filter(r=>!RUN.relicIds.has(r.id))).slice(0,3);
    for(let i=0;i<relicOffers.length;i++){
      const r = relicOffers[i];
      const x = 200 + i*300;
      const box = this.add.rectangle(x,460,240,120,0x222222).setStrokeStyle(2,0xffffff).setInteractive();
      const price = 15;
      this.add.text(x-100,432,r.name,{fontSize:14}).setOrigin(0);
      this.add.text(x+100,432,`¬•${price}`,{fontSize:12}).setOrigin(1,0);
      this.add.text(x,460,r.desc,{fontSize:12,wordWrap:{width:200}}).setOrigin(0.5);
      box.on('pointerdown', ()=>{
        if(RUN.player.gold < price) return;
        RUN.player.gold -= price;
        this.goldText.setText(`Ë≥áÈáë: ${RUN.player.gold}`, {fontSize:18});
        RUN.applyRelic(r);
        box.fillColor = 0x444444;
      });
    }
    // delete card option (one-time)
    const delBox = this.add.rectangle(900,560,240,120,0xaa4444).setStrokeStyle(2,0xffffff).setInteractive();
    this.add.text(900,540,'„Ç´„Éº„ÉâÂâäÈô§ (¬•20)', {fontSize:14}).setOrigin(0.5);
    delBox.on('pointerdown', ()=>{
      if(RUN.player.gold < 20) return;
      if(RUN.player.deck.length<=1) return;
      RUN.player.gold -= 20;
      this.goldText.setText(`Ë≥áÈáë: ${RUN.player.gold}`, {fontSize:18});
      // remove a random non-basic card (try to remove strongest)
      RUN.player.deck.sort((a,b)=> (b.defense||0 + b.damageToVuln||0) - (a.defense||0 + a.damageToVuln||0));
      RUN.player.deck.pop();
      this.add.text(900,620,'„Ç´„Éº„Éâ„Çí1ÊûöÂâäÈô§„Åó„Åæ„Åó„Åü', {fontSize:12}).setOrigin(0.5);
    });

    const leave = this.add.rectangle(600,680,160,40,0x666666).setInteractive();
    this.add.text(600,680,'Â∫ó„ÇíÂá∫„Çã', {fontSize:16}).setOrigin(0.5);
    //leave.on('pointerdown', ()=> this.startBattle());
    leave.on('pointerdown', ()=> startBattle(this));
  }
  /*
  startBattle(){
    if(RUN.stageIndex < 5){
      this.startBattle(false);
    }else if(RUN.stageIndex == 9){
      this.startBattle('boss');
    }else{
      this.startBattle(true);
    }
  }
  startBattle(eliteFlag){
    // prepare enemy from templates based on type & stage
    let enemy;
    if(eliteFlag==='boss') enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.boss)));
    else if(eliteFlag===true) enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.elite)));
    else enemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.normal)));
    // store battle state in RUN
    RUN.currentEnemy = {
      ...enemy,
      hp: enemy.hp,
      def: enemy.def,
      intent: enemy.intent,
      intentValue: enemy.intentValue,
      tags: enemy.tags || []
    };
    // prepare player draw pile if empty
    if(RUN.player.drawPile.length===0) RUN.player.drawPile = Util.shuffle(RUN.player.deck.slice());
    // reset temporary player values
    RUN.player.defense = 0;
    //RUN.player.energy = RUN.player.maxEnergy;
    RUN.player.status = {}; // status effects
    this.scene.start('BattleScene', {elite: eliteFlag});
  }
  //*/

}

/* EventScene */
class EventScene extends Phaser.Scene {
  constructor(){ super({key:'EventScene'}); }
  create(){
    RUN.showPlayerStatus(this);
    RUN.showBtns(this,true,false,false,true,true);
    //RUN.showDeckViewBtn(this);
    this.add.text(600,80,'„Ç§„Éô„É≥„Éà', {fontSize:28}).setOrigin(0.5);
    let ev;
    //const ev = Util.randChoice(events);
    if(debugMode){
      //ev = Util.randChoice(EVENT_TEMPLATES);
      ev = EVENT_TEMPLATES[debugIndex++];
    }else{
      ev = Util.randChoice(EVENT_TEMPLATES);
    }
    this.add.text(600,140,ev.title, {fontSize:20}).setOrigin(0.5);
    this.add.text(600,160,ev.text, {fontSize:18}).setOrigin(0.5);
    /*
    if(ev.id==='insider'){
      // start battle immediately with an enemy
      RUN.currentEnemy = JSON.parse(JSON.stringify(Util.randChoice(ENEMY_TEMPLATES.normal)));
      RUN.currentEnemy.hp = RUN.currentEnemy.hp;
      this.time.delayedCall(1200, ()=> this.scene.start('BattleScene', {elite:false}));
      return;
    } else {
      ev.effect();
      const skip = this.add.rectangle(600,560,160,40,0x666666).setInteractive();
      this.add.text(600,560,'Ê¨°„Å∏', {fontSize:16}).setOrigin(0.5);
      skip.on('pointerdown', ()=> this.scene.start('MapScene'));
      //this.time.delayedCall(1200, ()=> this.scene.start('MapScene'));
    }
    */
    const choiceBtns = [];
    let startY = 300;
    //const choice = this.add.text(600,startY+20,`${ev.choices.length}`, {fontSize:18}).setOrigin(0.5);
    //RUN.showBtn(this, 600, startY+80, "a", 0xffffff);
    for(let i=0; i<ev.choices.length; i++){
      //const choiceBlk = this.add.rectangle();
      //const choice = this.add.text(600,startY+i*20,ev.choices[i].option, {fontSize:18}).setOrigin(0.5);
      const Btn = RUN.showBtn(this, 600, startY+i*100, ev.choices[i].option, 0x666666, 400,40);
      //const Btn = RUN.showBtn(this, 600, startY+i*20, "a", 0xffffff);
      Btn.btn.on('pointerdown', ()=> { this.applyEvent(ev.choices[i].effect()); this.destroyBtns(choiceBtns); this.endScene(); });
      choiceBtns.push(Btn);
    }
    //close.on('pointerdown', ()=>{ modal.destroy(); close.destroy(); closeText.destroy(); Txt.destroy(); });
  }
  applyEvent(ret){
    if(ret.card != null){
      RUN.player.applyEffectWaiting.push({leftTime: ret.card.cost.time, card: ret.card});
    }
    if(ret.labor != null){
      if(ret.labor > 0){
        if(ret.time == null){
          RUN.player.energy += ret.labor;
        }
        RUN.player.maxEnergy += ret.labor;     
      }else{
        if(ret.time == null){
          RUN.player.maxEnergy += ret.labor;
        }
        RUN.player.energy += ret.labor;
      }
    }
    if(ret.money != null){
      RUN.player.gold += ret.money*5;
    }
    if(ret.budget != null){
      RUN.budget += ret.budget*5;
    }
    if(ret.trust != null){
      RUN.player.hp +=ret.trust*5;
    }
  }
  destroyBtns(Btns){
    for(let i=0; i<Btns.length; i++){
      Btns[i].btn.destroy();
      Btns[i].txt.destroy();
    }
  }
  endScene(){    
    const skip = this.add.rectangle(600,560,160,40,0x666666).setInteractive();
    this.add.text(600,560,'Ê¨°„Å∏', {fontSize:16}).setOrigin(0.5);
    if(debugMode){
      if(debugIndex == EVENT_TEMPLATES.length){
        skip.on('pointerdown', ()=> this.scene.start('ShopScene'));
      }else{
        skip.on('pointerdown', ()=> this.scene.start('EventScene'));
      }
    }else{
      skip.on('pointerdown', ()=> this.scene.start('ShopScene'));
    }
  }
}

/* GameOverScene */
class GameOverScene extends Phaser.Scene {
  constructor(){ super({key:'GameOverScene'}); }
  init(data){ this.victory = data && data.victory; }
  create(){
    this.add.text(600,120, this.victory ? 'Ê•≠ÂãôÁ∂ôÁ∂öÊàêÂäüÔºÅ' : '„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº', {fontSize:34}).setOrigin(0.5);
    this.add.text(600,180,`„Éó„É¨„Ç§ÊôÇÈñì: ${Math.floor((Date.now()-RUN.startTimestamp)/1000)}Áßí`, {fontSize:16}).setOrigin(0.5);
    this.add.text(600,220,`ÊúÄÁµÇË≥áÈáë: ${RUN.player.gold}`, {fontSize:16}).setOrigin(0.5);
    this.add.text(600,260,`„Éá„ÉÉ„Ç≠: ${RUN.player.deck.map(c=>c.name).join(', ')}`, {fontSize:12}).setOrigin(0.5);
    this.add.text(600,300,`„Çµ„Éù„Éº„Éà: ${RUN.player.relics.map(r=>r.name).join(', ')}`, {fontSize:12}).setOrigin(0.5);
    const nextBtn = this.add.rectangle(600,500,220,60,0x2d8cff).setInteractive();
    this.add.text(600,500,'„Çø„Ç§„Éà„É´„Å´Êàª„Çã', {fontSize:20}).setOrigin(0.5);
    nextBtn.on('pointerdown', ()=> this.scene.start('OpeningScene'));
  }
}

/* ---------- Register scenes and start ---------- */
config.scene = [OpeningScene, MapScene, BattleScene, RewardScene, ChestScene, RestScene, ShopScene, EventScene, GameOverScene];
const game = new Phaser.Game(config);

/* ---------- End of file ---------- */

</script>
</body>
</html>
